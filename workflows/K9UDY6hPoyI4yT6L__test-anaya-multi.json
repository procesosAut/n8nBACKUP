{
  "updatedAt": "2026-01-04T10:56:20.539Z",
  "createdAt": "2025-12-31T10:07:03.414Z",
  "id": "K9UDY6hPoyI4yT6L",
  "name": "test Anaya Multi",
  "description": "",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/responses",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpBearerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json.openaiBody}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1744,
        -1520
      ],
      "id": "8b2cfcc1-2f80-47dd-a021-936bd3d2dc4e",
      "name": "OpenAI",
      "alwaysOutputData": false,
      "executeOnce": false,
      "retryOnFail": false,
      "credentials": {
        "httpBearerAuth": {
          "id": "Fb5EZ7r56FOl5M3A",
          "name": "Http Open AI"
        }
      }
    },
    {
      "parameters": {
        "content": "## Conexi√≥n directa con AUTOMTE\nRecibe el PDF por HTTP ",
        "height": 352,
        "width": 704,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2944,
        432
      ],
      "id": "fbca81af-0fb1-4453-82d9-b7d86025b64f",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const fileId = $items(\"Subir PDF a OpenAI\")[0].json.id; // o el nombre exacto del nodo upload\nconst prompt = ($json.promptCabecera || \"\").trim();\n\nif (!fileId || !String(fileId).startsWith(\"file-\")) {\n  throw new Error(`fileId inv√°lido: ${fileId}`);\n}\n\nconst titleSchema = {\n  type: \"object\",\n  additionalProperties: false,\n  required: [\n    \"idElemento\",\"cliente\",\"contacto\",\"suReferencia\",\"numeroOf\",\"numeroOtCliente\",\"isbnPack\",\n    \"fechaEntrega\",\"sinRetraso\",\"tirada\",\"precioUnitarioSinIVA\",\"precioToltalSinIVA\",\n    \"quiereVerFerros\",\"certificacion\",\"observacionesPedido\",\"titulo\",\"sello\",\"isbn\",\"codProyecto\",\n    \"anchoPaginaCm\",\"altoPaginaCm\",\"unionPliegos\",\"encuadernacion\",\"cabezada\",\"cabezadaColor\",\n    \"cabezadaColorOtro\",\"guardasAparte\",\"guardasImpresas\",\"cintaRegistro\",\"cintaRegistroColor\",\n    \"cintaRegistroColorOtro\",\"calibreCarton\",\"tipoLomo\",\"solapa\",\"hendidoCortesia\",\"espiralMaterial\",\n    \"espiralColor\",\"espiralColorOtro\",\"espiralLado\",\"wireoMaterial\",\"wireoColor\",\"wireoColorOtro\",\n    \"wireoLado\",\"observacionesEncuadernacion\"\n  ],\n  properties: {\n    idElemento: { type: \"string\" },\n    cliente: { type: \"integer\" },\n    contacto: { type: \"integer\" },\n    suReferencia: { type: \"integer\" },\n    numeroOf: { type: \"string\" },\n    numeroOtCliente: { type: \"string\" },\n    isbnPack: { type: \"string\" },\n    fechaEntrega: { type: \"string\" },\n    sinRetraso: { type: \"boolean\" },\n    tirada: { type: \"integer\" },\n    precioUnitarioSinIVA: { type: \"number\" },\n    precioToltalSinIVA: { type: \"number\" },\n    quiereVerFerros: { type: \"integer\" },\n    certificacion: { type: \"integer\" },\n    observacionesPedido: { type: \"string\" },\n    titulo: { type: \"string\" },\n    sello: { type: \"string\" },\n    isbn: { type: \"string\" },\n    codProyecto: { type: \"string\" },\n    anchoPaginaCm: { type: \"number\" },\n    altoPaginaCm: { type: \"number\" },\n    unionPliegos: { type: \"integer\" },\n    encuadernacion: { type: \"integer\" },\n    cabezada: { type: \"integer\" },\n    cabezadaColor: { type: \"integer\" },\n    cabezadaColorOtro: { type: \"string\" },\n    guardasAparte: { type: \"integer\" },\n    guardasImpresas: { type: \"integer\" },\n    cintaRegistro: { type: \"integer\" },\n    cintaRegistroColor: { type: \"integer\" },\n    cintaRegistroColorOtro: { type: \"string\" },\n    calibreCarton: { type: \"integer\" },\n    tipoLomo: { type: \"integer\" },\n    solapa: { type: \"boolean\" },\n    hendidoCortesia: { type: \"boolean\" },\n    espiralMaterial: { type: \"integer\" },\n    espiralColor: { type: \"integer\" },\n    espiralColorOtro: { type: \"string\" },\n    espiralLado: { type: \"integer\" },\n    wireoMaterial: { type: \"integer\" },\n    wireoColor: { type: \"integer\" },\n    wireoColorOtro: { type: \"string\" },\n    wireoLado: { type: \"integer\" },\n    observacionesEncuadernacion: { type: \"string\" }\n  }\n};\n\nconst rootSchema = {\n  type: \"object\",\n  additionalProperties: false,\n  required: [\"titulos\"],\n  properties: {\n    titulos: { type: \"array\", minItems: 1, items: titleSchema }\n  }\n};\n\nconst openaiBody = {\n  model: \"gpt-5.2\",\ntext: {\n  format: {\n    type: \"json_schema\",\n    name: \"cabecera_multi_titulo\",\n    strict: true,\n    schema: rootSchema\n  }\n},\n  input: [{\n    role: \"user\",\n    content: [\n      { type: \"input_file\", file_id: fileId },\n      { type: \"input_text\", text: prompt }\n    ]\n  }]\n};\n\n// ‚úÖ ESTO ES LO QUE TE FALTABA: devolver item con { json: { ... } }\nreturn { json: { openaiBody } };\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1392,
        -1520
      ],
      "id": "78fb9fdb-f39d-4508-8996-2e30b1c2d55e",
      "name": "Build OpenAI Body (schema)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/files",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpBearerAuth",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "purpose",
              "value": "user_data"
            },
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "data"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1680,
        560
      ],
      "id": "06569543-b4c1-4635-a2fb-5e191c91d769",
      "name": "Subir PDF a OpenAI",
      "alwaysOutputData": false,
      "executeOnce": false,
      "retryOnFail": false,
      "credentials": {
        "httpBearerAuth": {
          "id": "Fb5EZ7r56FOl5M3A",
          "name": "Http Open AI"
        }
      }
    },
    {
      "parameters": {
        "content": "## Prompt Multi",
        "height": 384,
        "width": 320,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        336,
        -160
      ],
      "typeVersion": 1,
      "id": "e5526111-51ed-4f96-8f2b-3643c064715e",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## Cabecera",
        "height": 304,
        "width": 1344,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1296,
        -1616
      ],
      "id": "c008bff4-147c-415d-91b6-d1e631ba216c",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -1056,
        416
      ],
      "id": "e8b788c7-7137-440a-9c22-3875086b2a1c",
      "name": "Merge"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "716a3085-d054-4c2e-95d1-4865cec67f57",
              "name": "openaiFileId",
              "value": "={{$json.id}}",
              "type": "string"
            },
            {
              "id": "2e4e2dd2-a5dc-4e7c-8f3e-6bdcfbb25371",
              "name": "openaiFilename",
              "value": "={{$json.filename}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1280,
        560
      ],
      "id": "0e314d80-14c6-4829-a90f-f82dc4791df7",
      "name": "openaiFileId"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/responses",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpBearerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json.openaiBody}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1664,
        -1120
      ],
      "id": "a41e6b7b-034e-48b8-93b1-b64d033eeb63",
      "name": "OpenAI1",
      "alwaysOutputData": false,
      "executeOnce": false,
      "retryOnFail": false,
      "credentials": {
        "httpBearerAuth": {
          "id": "Fb5EZ7r56FOl5M3A",
          "name": "Http Open AI"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const fileId = $items(\"Subir PDF a OpenAI\")[0].json.id; // ‚úÖ file-...\nconst prompt = ($json.promptInteriores || \"\").trim();\n\nif (!fileId?.startsWith(\"file-\")) {\n  throw new Error(`fileId inv√°lido (esperaba file-...): ${fileId}`);\n}\n\n// --- Schema INTERIORES ---\nconst papelPedidoProps = {\n  refPedido: { type: \"string\" },\n  gramaje: { type: \"integer\" },\n  anchoBobinaCm: { type: \"number\" },\n  upsCalc: { type: \"integer\" },\n  ups: { type: \"integer\" },\n  metros: { type: \"number\" },\n  kg: { type: \"number\" },\n};\n\nconst interiorProps = {\n  // ‚úÖ CLAVE para enlazar con cabecera/cubierta/extras\n  idElemento: { type: \"string\" },\n\n  papel_id: { type: \"integer\" },\n  propietarioPapel: { type: \"integer\" },\n  tipoImpresion: { type: \"integer\" },\n  calidad: { type: \"string\" },\n  paginas: { type: \"integer\" },\n  plegadoOCortado: { type: \"integer\" },\n  maquina: { type: \"integer\" },\n  observaciones: { type: \"string\" },\n\n  papelPedido: {\n    type: \"object\",\n    additionalProperties: false,\n    properties: papelPedidoProps,\n    required: Object.keys(papelPedidoProps),\n  },\n};\n\nconst schema = {\n  type: \"object\",\n  additionalProperties: false,\n  required: [\"interiores\"],\n  properties: {\n    interiores: {\n      type: \"array\",\n      minItems: 4,\n      // Si quieres FORZAR 4 para este PDF de prueba, cambia a:\n      // minItems: 4,\n      items: {\n        type: \"object\",\n        additionalProperties: false,\n        properties: interiorProps,\n        required: Object.keys(interiorProps),\n      },\n    },\n  },\n};\n\nconst openaiBody = {\n  model: \"gpt-5.2\",\n  input: [\n    {\n      role: \"user\",\n      content: [\n        { type: \"input_file\", file_id: fileId },\n        { type: \"input_text\", text: prompt },\n      ],\n    },\n  ],\n  text: {\n    format: {\n      type: \"json_schema\",\n      name: \"interiores_pedido\",\n      strict: true, // ‚úÖ importante: evita que ‚Äúse salte‚Äù claves\n      schema,\n    },\n  },\n};\n\n// ‚úÖ n8n Code node: siempre devolver { json: {...} }\nreturn { json: { openaiBody } };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1392,
        -1120
      ],
      "id": "3a199b38-3fc2-4a31-99ce-b3880b8317a6",
      "name": "Build OpenAI Body (schema)1"
    },
    {
      "parameters": {
        "content": "## Interiores",
        "height": 288,
        "width": 1536,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1296,
        -1200
      ],
      "id": "a1d5489f-efce-4f40-be0d-fd187325d01f",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/responses",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpBearerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json.openaiBody}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1648,
        -704
      ],
      "id": "708f0f47-c0f4-4d6c-b46c-b5f01a5e7740",
      "name": "OpenAI2",
      "alwaysOutputData": false,
      "executeOnce": false,
      "retryOnFail": false,
      "credentials": {
        "httpBearerAuth": {
          "id": "Fb5EZ7r56FOl5M3A",
          "name": "Http Open AI"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const fileId = $items(\"Subir PDF a OpenAI\")[0].json.id; // ‚úÖ file-...\nconst prompt = ($json.promptCubierta || \"\").trim();\n\nif (!fileId?.startsWith(\"file-\")) {\n  throw new Error(`fileId inv√°lido (esperaba file-...): ${fileId}`);\n}\n\nconst cubiertaItemProps = {\n  idElemento: { type: \"string\" },\n\n  materialCubierta: { type: \"integer\" },\n  propietarioPapel: { type: \"integer\" },\n  plastificado: { type: \"integer\" },\n  uvi: { type: \"integer\" },\n  impresion: { type: \"string\" },\n  codDescarga: { type: \"integer\" },\n  tecnologia: { type: \"integer\" },\n  observaciones: { type: \"string\" },\n};\n\nconst schema = {\n  type: \"object\",\n  additionalProperties: false,\n  required: [\"cubiertas\"],\n  properties: {\n    cubiertas: {\n      type: \"array\",\n      minItems: 1,\n      items: {\n        type: \"object\",\n        additionalProperties: false,\n        properties: cubiertaItemProps,\n        required: Object.keys(cubiertaItemProps),\n      },\n    },\n  },\n};\n\nconst openaiBody = {\n  model: \"gpt-5.2\",\n  input: [\n    {\n      role: \"user\",\n      content: [\n        { type: \"input_file\", file_id: fileId },\n        { type: \"input_text\", text: prompt },\n      ],\n    },\n  ],\n  text: {\n    format: {\n      type: \"json_schema\",\n      name: \"cubiertas_pedido\",\n      strict: true,\n      schema,\n    },\n  },\n};\n\nreturn { json: { openaiBody } };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1392,
        -704
      ],
      "id": "493ad846-b658-48c8-b1f0-9e88d1acebd7",
      "name": "Build OpenAI Body (schema)2"
    },
    {
      "parameters": {
        "content": "## Cubierta",
        "height": 304,
        "width": 1536,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1296,
        -800
      ],
      "id": "b3dda410-a609-4918-a8f6-0046f9b43aec",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/responses",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpBearerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json.openaiBody}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1680,
        -288
      ],
      "id": "507685d6-90c0-4e9e-b6fd-f912426e1811",
      "name": "OpenAI3",
      "alwaysOutputData": false,
      "executeOnce": false,
      "retryOnFail": false,
      "credentials": {
        "httpBearerAuth": {
          "id": "Fb5EZ7r56FOl5M3A",
          "name": "Http Open AI"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const fileId = $items(\"Subir PDF a OpenAI\")[0].json.id; // ‚úÖ file-...\nconst prompt = ($json.promptExtras || \"\").trim();\n\nif (!fileId?.startsWith(\"file-\")) {\n  throw new Error(`fileId inv√°lido (esperaba file-...): ${fileId}`);\n}\n\n// ---------- Subschemas ----------\n\n// papelPedido / papelProduccion (id√©nticos salvo nombre de ref)\nconst papelPedidoProps = {\n  refPedido: { type: \"string\" },\n  gramaje: { type: \"integer\" },\n  anchoBobinaCm: { type: \"number\" },\n  upsCalc: { type: \"integer\" },\n  ups: { type: \"integer\" },\n  metros: { type: \"number\" },\n  kg: { type: \"number\" },\n};\n\nconst papelProduccionProps = {\n  refProduccion: { type: \"string\" },\n  gramaje: { type: \"integer\" },\n  anchoBobinaCm: { type: \"number\" },\n  upsCalc: { type: \"integer\" },\n  ups: { type: \"integer\" },\n  metros: { type: \"number\" },\n  kg: { type: \"number\" },\n};\n\nconst guardasProps = {\n  papel_id: { type: \"integer\" },\n  propietarioPapel: { type: \"integer\" },\n  tipoImpresion: { type: \"integer\" },\n  calidad: { type: \"string\" },          // en tu prompt es texto (\"Ahuesado\", etc.)\n  paginas: { type: \"integer\" },\n  plegadoOCortado: { type: \"integer\" },\n  maquina: { type: \"integer\" },\n  observaciones: { type: \"string\" },\n  papelPedido: {\n    type: \"object\",\n    additionalProperties: false,\n    properties: papelPedidoProps,\n    required: Object.keys(papelPedidoProps),\n  },\n  papelProduccion: {\n    type: \"object\",\n    additionalProperties: false,\n    properties: papelProduccionProps,\n    required: Object.keys(papelProduccionProps),\n  },\n};\n\nconst sobrecubiertaProps = {\n  materialSobrecubierta: { type: \"integer\" },\n  propietarioPapel: { type: \"integer\" },\n  plastificado: { type: \"integer\" },\n  uvi: { type: \"integer\" },\n  impresion: { type: \"string\" },    // \"4/0\", \"4/4\", etc.\n  tecnologia: { type: \"integer\" },\n  observaciones: { type: \"string\" },\n};\n\nconst fajaProps = {\n  materialFaja: { type: \"integer\" },\n  propietarioPapel: { type: \"integer\" },\n  plastificado: { type: \"integer\" },\n  uvi: { type: \"integer\" },\n  impresion: { type: \"string\" },    // \"4/0\", \"4/4\", etc.\n  tecnologia: { type: \"integer\" },\n  observaciones: { type: \"string\" },\n};\n\nconst componenteEspecialProps = {\n  material: { type: \"integer\" },\n  propietarioPapel: { type: \"integer\" },\n  nombre: { type: \"string\" },\n  plastificado: { type: \"integer\" },\n  uvi: { type: \"boolean\" },         // en tu modelo inicial era boolean\n  impresion: { type: \"string\" },    // mejor string (\"4/0\"...)\n  tecnologia: { type: \"integer\" },\n  observaciones: { type: \"string\" },\n};\n\nconst peticionEspecialProps = {\n  descripcion: { type: \"string\" },\n};\n\nconst direccionProps = {\n  direccionId: { type: \"string\" },  // a veces viene como n√∫mero; si prefieres integer lo cambio\n  destinatario: { type: \"string\" },\n  via: { type: \"string\" },\n  numero: { type: \"string\" },\n  piso: { type: \"string\" },\n  puerta: { type: \"string\" },\n  cp: { type: \"string\" },\n  localidad: { type: \"string\" },\n  provincia: { type: \"string\" },\n  pais: { type: \"string\" },\n  contacto: { type: \"string\" },\n  telefonos: { type: \"string\" },\n  pallet: { type: \"integer\" },\n  encajado: { type: \"integer\" },\n  ejemplaresPaquete: { type: \"integer\" },\n  ejemplares: { type: \"integer\" },\n  envioResto: { type: \"integer\" },\n  modelos: { type: \"integer\" },\n  observaciones: { type: \"string\" },\n};\n\n// ---------- Main schema ----------\nconst schema = {\n  type: \"object\",\n  additionalProperties: false,\n  properties: {\n    guardas: {\n      type: \"object\",\n      additionalProperties: false,\n      properties: guardasProps,\n      required: Object.keys(guardasProps),\n    },\n    sobrecubierta: {\n      type: \"object\",\n      additionalProperties: false,\n      properties: sobrecubiertaProps,\n      required: Object.keys(sobrecubiertaProps),\n    },\n    faja: {\n      type: \"object\",\n      additionalProperties: false,\n      properties: fajaProps,\n      required: Object.keys(fajaProps),\n    },\n    componentesEspeciales: {\n      type: \"array\",\n      items: {\n        type: \"object\",\n        additionalProperties: false,\n        properties: componenteEspecialProps,\n        required: Object.keys(componenteEspecialProps),\n      },\n    },\n    peticionesEspeciales: {\n      type: \"array\",\n      items: {\n        type: \"object\",\n        additionalProperties: false,\n        properties: peticionEspecialProps,\n        required: Object.keys(peticionEspecialProps),\n      },\n    },\n    direcciones: {\n      type: \"array\",\n      items: {\n        type: \"object\",\n        additionalProperties: false,\n        properties: direccionProps,\n        required: Object.keys(direccionProps),\n      },\n    },\n  },\n  required: [\"guardas\", \"sobrecubierta\", \"faja\", \"componentesEspeciales\", \"peticionesEspeciales\", \"direcciones\"],\n};\n\nreturn {\n  openaiBody: {\n    model: \"gpt-5.2\",\n    input: [{\n      role: \"user\",\n      content: [\n        { type: \"input_file\", file_id: fileId },\n        { type: \"input_text\", text: prompt },\n      ],\n    }],\n    text: {\n      format: {\n        type: \"json_schema\",\n        name: \"extras_pedido\",\n        strict: false,\n        schema,\n      },\n    },\n  },\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1392,
        -288
      ],
      "id": "c1ff06cc-3eec-41e9-b3ac-0a4f9fe143af",
      "name": "Build OpenAI Body (schema)3"
    },
    {
      "parameters": {
        "jsCode": "// Parse output_text de OpenAI a JSON (robusto)\n\nfunction pickOutputText(j) {\n  // Caso t√≠pico: OpenAI node devuelve output_text directamente\n  if (typeof j.output_text === \"string\" && j.output_text.trim()) return j.output_text;\n\n  // Otros casos posibles (seg√∫n nodo/versi√≥n):\n  if (typeof j.text === \"string\" && j.text.trim()) return j.text;\n\n  // Responses API a veces viene en estructuras anidadas:\n  // j.output?.[0]?.content?.[0]?.text\n  const nested =\n    j?.output?.[0]?.content?.find?.((c) => c?.type === \"output_text\")?.text ??\n    j?.output?.[0]?.content?.[0]?.text;\n\n  if (typeof nested === \"string\" && nested.trim()) return nested;\n\n  return \"\";\n}\n\nconst raw = pickOutputText($json);\n\nif (!raw) {\n  throw new Error(\"No encuentro output_text/text en la respuesta de OpenAI.\");\n}\n\n// A veces puede venir con espacios antes/despu√©s\nconst txt = raw.trim();\n\n// Parse JSON\nlet parsed;\ntry {\n  parsed = JSON.parse(txt);\n} catch (e) {\n  // Ayuda cuando el modelo devuelve basura alrededor (aunque le pidas SOLO JSON)\n  const first = txt.indexOf(\"{\");\n  const last = txt.lastIndexOf(\"}\");\n  if (first >= 0 && last > first) {\n    parsed = JSON.parse(txt.slice(first, last + 1));\n  } else {\n    throw new Error(\"No se pudo parsear JSON en output_text. Raw: \" + txt.slice(0, 300));\n  }\n}\n\n// Devuelve el objeto ya parseado\nreturn [{ json: parsed }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1952,
        -288
      ],
      "id": "fb69b146-d123-489b-bc29-7647cca07a05",
      "name": "Parse output_text3"
    },
    {
      "parameters": {
        "content": "## Extras",
        "height": 320,
        "width": 1184,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1296,
        -384
      ],
      "id": "7eaec399-a177-48f5-95a5-bb0a55c61195",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "jsCode": "const buf = await this.helpers.getBinaryDataBuffer(0, 'data');\nconst b64 = buf.toString('base64');\n\n// Conserva lo que venga en json y a√±ade archivoBase64\nreturn {\n  ...$json,\n  archivoBase64: b64,\n  nombreArchivo: $binary?.data?.fileName || $json.name || 'pedido.pdf',\n  mime: $binary?.data?.mimeType || 'application/pdf',\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1488,
        352
      ],
      "id": "55e0c9ac-ca5c-41ee-ab74-a3fe6b47f01f",
      "name": "PDF - Base64"
    },
    {
      "parameters": {
        "content": "## Sube el PDF a OpenAI, genera el PDF en base64 y los combina\n",
        "height": 560,
        "width": 944
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1808,
        224
      ],
      "id": "ea2ca3e6-16c7-400e-88cf-ad08cdf5ddfe",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "jsCode": "function toNumber(v) {\n  if (v === null || v === undefined) return NaN;\n  if (typeof v === \"number\") return v;\n  if (typeof v === \"string\") return Number(v.replace(\",\", \".\").trim());\n  return Number(v);\n}\n\nfunction toBool(v) {\n  if (typeof v === \"boolean\") return v;\n  if (typeof v === \"number\") return v === 1;\n  if (typeof v === \"string\") {\n    const s = v.trim().toLowerCase();\n    if (s === \"true\" || s === \"1\" || s === \"s√≠\" || s === \"si\") return true;\n    if (s === \"false\" || s === \"0\" || s === \"no\") return false;\n  }\n  return Boolean(v);\n}\n\nconst items = $input.all();\n\nreturn items.map(({ json }) => {\n  const encuadernacion = toNumber(json.encuadernacion);\n  const tirada = toNumber(json.tirada);\n  const solapa = toBool(json.solapa);\n\n  const uvi = toNumber(json.cubierta?.uvi);\n  const tecnologiaIn = toNumber(json.cubierta?.tecnologia);\n\n  // Si falta algo, no rompas el flujo: deja tecnologia como ven√≠a (o 0)\n  if (![encuadernacion, tirada, uvi, tecnologiaIn].every(Number.isFinite)) {\n    json.cubierta = { ...(json.cubierta || {}), tecnologia: json.cubierta?.tecnologia ?? 0 };\n    return { json };\n  }\n\n  let tecnologia = tecnologiaIn;\n\n  // Regla especial: si IA detecta offset => 5, lo cambiamos a 2\n  if (tecnologiaIn === 5) {\n    tecnologia = 2;\n  } else {\n    const c1 = (encuadernacion === 1 && uvi === 1 && tirada > 799);\n    const c2 = (encuadernacion === 1 && uvi === 0 && tirada > 999);\n    const c3 = (encuadernacion === 3 && uvi === 1 && solapa === true && tirada > 799);\n    const c4 = (encuadernacion === 3 && uvi === 0 && solapa === true && tirada > 1499);\n    const c5 = (uvi === 1 && tirada > 799);\n    const c6 = (uvi === 0 && tirada > 1999);\n    const c7 = (tirada > 1999);\n\n    tecnologia = (c1 || c2 || c3 || c4 || c5 || c6 || c7) ? 3 : 1;\n  }\n\n  json.cubierta = { ...(json.cubierta || {}), tecnologia };\n  return { json };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2608,
        -704
      ],
      "id": "8eaaa8b9-b8b5-4bbf-85b5-a4de606e2947",
      "name": "Calcular tecnologia (cubierta)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "059e152e-2548-4983-add7-2d9f28cc9968",
              "leftValue": "={{ $json.papel_id }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        4096,
        -1088
      ],
      "id": "b0451f67-a5db-4a49-8ae3-48cbf2b3c062",
      "name": "¬øpapel_id > 0?"
    },
    {
      "parameters": {
        "url": "https://liberdigital.gomezaparicio.es/sw/automatizacion/bobinas/stock",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "options": {
          "allowUnauthorizedCerts": true,
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4400,
        -720
      ],
      "id": "402d30f8-536e-424f-8bd0-a674402364bb",
      "name": "API Bobinas Stock",
      "alwaysOutputData": true,
      "notesInFlow": false,
      "credentials": {
        "httpBasicAuth": {
          "id": "EGTFeBpcDKH8NdqZ",
          "name": "Apis Libernet"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// items = lista de items que vienen del HTTP (117 bobinas)\nconst stock = items.map(i => i.json);\n\n// devolvemos 1 solo item con un campo stock = [ ...bobinas ]\nreturn [{ json: { stock } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4640,
        -720
      ],
      "id": "3539550d-d7e1-4e14-8f34-578fc1109209",
      "name": "Agrupar stock"
    },
    {
      "parameters": {
        "jsCode": "function toNumber(v) {\n  if (v === null || v === undefined) return NaN;\n  if (typeof v === \"number\") return v;\n\n  const s = String(v)\n    .trim()\n    // deja solo d√≠gitos, coma, punto y signo\n    .replace(/[^\\d.,+-]/g, \"\")\n    // si hay coma, la tratamos como decimal\n    .replace(\",\", \".\");\n\n  const n = Number(s);\n  return Number.isFinite(n) ? n : NaN;\n}\n\nfunction normStr(v) {\n  return (v ?? \"\").toString().trim();\n}\n\n// normalizaci√≥n ‚Äútipo prompt‚Äù: min√∫sculas, sin acentos, colapsa espacios\nfunction normKey(v) {\n  return (v ?? \"\")\n    .toString()\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\") // quita acentos\n    .toLowerCase()\n    .replace(/\\s+/g, \" \")\n    .trim();\n}\n\n// gramaje robusto: acepta \"70\", \"70 g\", \"70gr\", \"70,0\"\nfunction normGramaje(v) {\n  const s = (v ?? \"\").toString().replace(/[^\\d.,]/g, \"\");\n  const n = toNumber(s);\n  return Number.isFinite(n) ? n : NaN;\n}\n\n// ======================\n// INPUT\n// ======================\nconst root = { ...$json };\nconst pedido = root.pedido ?? root;\n\n// stock puede estar en root.stock, root.stock.stock, pedido.stock, pedido.stock.stock...\nconst bobinas =\n  Array.isArray(root.stock) ? root.stock :\n  Array.isArray(root.stock?.stock) ? root.stock.stock :\n  Array.isArray(pedido.stock) ? pedido.stock :\n  Array.isArray(pedido.stock?.stock) ? pedido.stock.stock :\n  [];\n\n// ======================\n// VALIDACIONES\n// ======================\nconst interior0 = Array.isArray(pedido.interiores) ? pedido.interiores[0] : null;\nif (!interior0) return [{ json: pedido }];\nif (!Array.isArray(bobinas) || bobinas.length === 0) return [{ json: pedido }];\n\n// ======================\n// DATOS PEDIDO (como Azure Function)\n// ======================\nconst anchoLibroCm = toNumber(pedido.anchoPaginaCm);\nif (!Number.isFinite(anchoLibroCm)) return [{ json: pedido }];\n\nconst unionPliegos = toNumber(pedido.unionPliegos);\nconst esCosido = Number.isFinite(unionPliegos) && unionPliegos === 1;\n\nconst propietarioDeseado = \"Liberdigital\";\n\n// üëá robusto\nconst calidadPedidoN = normKey(interior0?.calidad);\nconst gramajePedidoN = normGramaje(interior0?.papelPedido?.gramaje);\n\nconst certificacionCodigo = normStr(pedido.certificacion);\n\n// ======================\n// MAPEO CERTIFICACI√ìN (igual que Python)\n// ======================\nconst mapaCert = {\n  \"2\": \"FSC MIX CREDIT\",\n  \"3\": \"100% PEFC CERTIFICADO\",\n  \"4\": \"70% PEFC CERTIFICADO\",\n  \"5\": \"FSC Reciclado 100%\",\n};\n\nconst certTexto = mapaCert[certificacionCodigo] ?? null;\n\n// ======================\n// 1) FILTRAR CALIDAD + GRAMAJE (robusto OCR)\n// ======================\nlet base = bobinas.filter(b => {\n  const calidadB = normKey(b.calidad);\n  const gramajeB = normGramaje(b.gramaje);\n\n  // si no podemos parsear gramaje, NO lo aceptamos\n  if (!Number.isFinite(gramajePedidoN) || !Number.isFinite(gramajeB)) return false;\n\n  return calidadB === calidadPedidoN && gramajeB === gramajePedidoN;\n});\n\nif (base.length === 0) {\n  // Limpieza stock igualmente\n  delete root.stock;\n  if (root.pedido) delete root.pedido.stock;\n  delete pedido.stock;\n  if (pedido.pedido) delete pedido.pedido.stock;\n  delete pedido.seleccionBobina;\n  delete root.seleccionBobina;\n\n  return [{ json: pedido }];\n}\n\n// ======================\n// 2) CALCULAR CANDIDATOS (propietario + cert + copias)\n// ======================\nconst anchoEfectivo = anchoLibroCm + 1;\nif (!(anchoEfectivo > 0)) return [{ json: pedido }];\n\nconst candidatos = [];\n\nfor (const b of base) {\n  const anchoBobina = toNumber(b.ancho); // admite \"48\", \"48 cm\", etc.\n  if (!Number.isFinite(anchoBobina) || anchoBobina <= 0) continue;\n\n  // propietario (igual que python: si bobina trae propietario y no coincide, fuera)\n  const propBobina = normKey(b.propietario);\n  if (propietarioDeseado && propBobina && propBobina !== normKey(propietarioDeseado)) continue;\n\n  // certificaci√≥n\n  const certBobina = normKey(b.certificacion);\n  if (certTexto && certBobina) {\n    const certObjetivo = normKey(certTexto);\n\n    if (certObjetivo === normKey(\"FSC MIX CREDIT\")) {\n      // admite MIX CREDIT o MIX 70%\n      if (certBobina !== normKey(\"FSC MIX CREDIT\") && certBobina !== normKey(\"FSC MIX 70%\")) continue;\n    } else {\n      if (certBobina !== certObjetivo) continue;\n    }\n  }\n\n  // max copias base\n  const maxCopias = Math.floor(anchoBobina / anchoEfectivo);\n  if (maxCopias <= 0) continue;\n\n  let copias;\n  if (esCosido) {\n    // solo 4 o 2\n    if (maxCopias >= 4) copias = 4;\n    else if (maxCopias >= 2) copias = 2;\n    else continue;\n  } else {\n    // fresado: todas las que quepan\n    copias = maxCopias;\n  }\n\n  candidatos.push({\n    bobina: b,\n    copiasEnAncho: copias,\n    anchoBobina: anchoBobina,\n  });\n}\n\nif (candidatos.length === 0) {\n  // Limpieza stock\n  delete root.stock;\n  if (root.pedido) delete root.pedido.stock;\n  delete pedido.stock;\n  if (pedido.pedido) delete pedido.pedido.stock;\n  delete pedido.seleccionBobina;\n  delete root.seleccionBobina;\n\n  return [{ json: pedido }];\n}\n\n// ======================\n// 3) ELEGIR MEJOR (igual que python)\n// 1¬∫ mayor copiasEnAncho\n// 2¬∫ menor anchoBobina\n// ======================\ncandidatos.sort((a, b) => {\n  if (b.copiasEnAncho !== a.copiasEnAncho) return b.copiasEnAncho - a.copiasEnAncho;\n  return a.anchoBobina - b.anchoBobina;\n});\n\nconst mejor = candidatos[0].bobina;\nconst ups = candidatos[0].copiasEnAncho;\n\n// ======================\n// 4) APLICAR AL PEDIDO\n// ======================\nconst papelIdNuevo = toNumber(mejor.papelId);\nif (Number.isFinite(papelIdNuevo)) interior0.papel_id = papelIdNuevo;\n\nif (typeof interior0.papelPedido !== \"object\" || interior0.papelPedido === null) {\n  interior0.papelPedido = {};\n}\n\n// mantenemos gramaje, pero lo reasignamos por seguridad\ninterior0.papelPedido.gramaje = toNumber(mejor.gramaje) || toNumber(interior0.papelPedido.gramaje) || 0;\n\n// ancho bobina\ninterior0.papelPedido.anchoBobinaCm = toNumber(mejor.ancho) || 0;\n\n// ups (siempre calculado como el Python)\ninterior0.papelPedido.ups = ups;\n\n// kg siempre 0\ninterior0.papelPedido.kg = 0;\n\n// referencia informativa\nif (normStr(mejor.referencia)) interior0.papelPedido.refPedido = normStr(mejor.referencia);\n\n// ======================\n// LIMPIEZA STOCK\n// ======================\ndelete root.stock;\nif (root.pedido) delete root.pedido.stock;\n\ndelete pedido.stock;\nif (pedido.pedido) delete pedido.pedido.stock;\n\ndelete pedido.seleccionBobina;\ndelete root.seleccionBobina;\n\n// ======================\n// SALIDA\n// ======================\nreturn [{ json: pedido }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5072,
        -896
      ],
      "id": "970328b4-f5be-4439-9e3e-42a48ff5597f",
      "name": "Seleccionar bobina (JS)"
    },
    {
      "parameters": {
        "jsCode": "function toNumber(v) {\n  if (v === null || v === undefined) return NaN;\n  if (typeof v === \"number\") return v;\n  if (typeof v === \"string\") return Number(v.replace(\",\", \".\").trim());\n  return Number(v);\n}\n\nfunction calcUps({ anchoBobinaCm, anchoPaginaCm, unionPliegos }) {\n  const aBob = toNumber(anchoBobinaCm);\n  const aPag = toNumber(anchoPaginaCm);\n  const uPl  = toNumber(unionPliegos);\n\n  if (!Number.isFinite(aBob) || aBob <= 0) return null;\n  if (!Number.isFinite(aPag)) return null;\n\n  const denom = aPag + 1;\n  if (!Number.isFinite(denom) || denom <= 0) return null;\n\n  const base = Math.floor(aBob / denom);\n\n  // 2 = FRESADO\n  if (uPl === 2) return base;\n\n  // 1 = COSIDO => 0/2/4\n  if (uPl === 1) {\n    if (base >= 4) return 4;\n    if (base >= 2) return 2;\n    return 0;\n  }\n\n  return base;\n}\n\nreturn $input.all().map((item) => {\n  const j = item.json ?? {};\n\n  const papelPedido = (j.papelPedido && typeof j.papelPedido === \"object\") ? j.papelPedido : {};\n\n  const ups = calcUps({\n    anchoBobinaCm: papelPedido.anchoBobinaCm,\n    anchoPaginaCm: j.anchoPaginaCm,\n    unionPliegos: j.unionPliegos,\n  });\n\n  if (ups !== null) {\n    j.papelPedido = { ...papelPedido, ups };\n  } else {\n    j.papelPedido = papelPedido;\n  }\n\n  return { json: j };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2608,
        -1120
      ],
      "id": "912854f8-deef-4cc8-93fd-d58d0c53fce7",
      "name": "Calcular UPS (interiores)"
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "idElemento",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2384,
        -1120
      ],
      "id": "a300e01c-1802-429a-b15a-d6f4e05019a9",
      "name": "Merge2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://liberdigital-des.gomezaparicio.es/desarrollo/sw/automatizacion/pedidos/digital/nuevo/00",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        6112,
        -624
      ],
      "id": "89daa8fc-fe12-4535-86b0-ac9d2d63a2ad",
      "name": "Desarrollo1",
      "credentials": {
        "httpBasicAuth": {
          "id": "EGTFeBpcDKH8NdqZ",
          "name": "Apis Libernet"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "662a650f-c96b-4ca1-bde7-45044a53297b",
        "options": {
          "binaryPropertyName": "data"
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -2656,
        560
      ],
      "id": "27afca73-7ba1-4322-b45d-d064b2c53439",
      "name": "Webhook",
      "webhookId": "662a650f-c96b-4ca1-bde7-45044a53297b"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        },
        "options": {
          "binaryPropertyName": "data"
        }
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -2416,
        160
      ],
      "id": "27f40572-9a02-4dfb-a372-998c6d11c206",
      "name": "Download file",
      "alwaysOutputData": false,
      "credentials": {
        "googleApi": {
          "id": "ePv2Ty1cw3gq6g7N",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "d0cde515-9ba1-4c2a-9753-3e96c5806967",
              "leftValue": "={{ $json.mimeType }}",
              "rightValue": "application/pdf",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -2640,
        176
      ],
      "id": "c05842e1-2c5d-46ec-878a-4bec0cb68c43",
      "name": "solo PDF"
    },
    {
      "parameters": {
        "content": "## Conexi√≥n con Google DRIVE\nRecoge el PDF de la carpeta \"variosPedidos\"",
        "height": 336,
        "width": 704,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2944,
        32
      ],
      "id": "bc648318-bf78-4de4-b79c-a58b18da607e",
      "name": "Sticky Note16"
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "authentication": "serviceAccount",
        "triggerOn": "specificFolder",
        "folderToWatch": {
          "__rl": true,
          "value": "1F23DWVP1M9OqK6DfxnVyvuJ0lhAGwwBH",
          "mode": "list",
          "cachedResultName": "test ANAYA",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1F23DWVP1M9OqK6DfxnVyvuJ0lhAGwwBH"
        },
        "event": "fileUpdated",
        "options": {}
      },
      "type": "n8n-nodes-base.googleDriveTrigger",
      "typeVersion": 1,
      "position": [
        -2848,
        176
      ],
      "id": "75a81a9d-1396-4e26-920a-63a497b1dbb1",
      "name": "Google Drive",
      "credentials": {
        "googleApi": {
          "id": "ePv2Ty1cw3gq6g7N",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first();\n\n// detecta el nombre de la propiedad binaria (normalmente \"data\")\nconst binKey = item.binary ? Object.keys(item.binary)[0] : null;\nif (!binKey) throw new Error('No llega ning√∫n binario en item.binary');\n\nconst bin = item.binary[binKey];\n\n// nombre deseado: usa el fileName del JSON si existe, si no uno por defecto\nlet name = item.json.fileName || bin.fileName || 'pedido.pdf';\n\n// asegura extensi√≥n .pdf\nif (!name.toLowerCase().endsWith('.pdf')) name += '.pdf';\n\n// fuerza metadatos\nbin.fileName = name;\nbin.mimeType = 'application/pdf';\n\nitem.binary[binKey] = bin;\n\nreturn [item];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2064,
        608
      ],
      "id": "698adc9e-09fa-4501-a35c-bd7a7a4cfb5e",
      "name": "Renombrar binario"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f0ce385a-7aee-445a-9af9-1acee2a8952e",
              "name": "promptCabecera",
              "value": "## ANAYA v1 ‚Äî CABECERA (multi-t√≠tulo)\n\nAct√∫a como un extractor de datos. Tu tarea es analizar el PDF adjunto y devolver exclusivamente un JSON v√°lido conforme al siguiente esquema.\n\n### MODELO DE SALIDA (exacto)\n{\n  \"titulos\": [\n    {\n      \"idElemento\": \"\",\n      \"cliente\": 34,\n      \"contacto\": 0,\n      \"suReferencia\": 0,\n      \"numeroOf\": \"\",\n      \"numeroOtCliente\": \"\",\n      \"isbnPack\": \"\",\n      \"fechaEntrega\": \"\",\n      \"sinRetraso\": false,\n      \"tirada\": 0,\n      \"precioUnitarioSinIVA\": 0,\n      \"precioToltalSinIVA\": 0,\n      \"quiereVerFerros\": 3,\n      \"certificacion\": 0,\n      \"observacionesPedido\": \"\",\n      \"titulo\": \"\",\n      \"sello\": \"\",\n      \"isbn\": \"\",\n      \"codProyecto\": \"\",\n      \"anchoPaginaCm\": 0,\n      \"altoPaginaCm\": 0,\n      \"unionPliegos\": 0,\n      \"encuadernacion\": 0,\n      \"cabezada\": 0,\n      \"cabezadaColor\": 0,\n      \"cabezadaColorOtro\": \"\",\n      \"guardasAparte\": 0,\n      \"guardasImpresas\": 0,\n      \"cintaRegistro\": 0,\n      \"cintaRegistroColor\": 0,\n      \"cintaRegistroColorOtro\": \"\",\n      \"calibreCarton\": 0,\n      \"tipoLomo\": 0,\n      \"solapa\": false,\n      \"hendidoCortesia\": false,\n      \"espiralMaterial\": 0,\n      \"espiralColor\": 0,\n      \"espiralColorOtro\": \"\",\n      \"espiralLado\": 0,\n      \"wireoMaterial\": 0,\n      \"wireoColor\": 0,\n      \"wireoColorOtro\": \"\",\n      \"wireoLado\": 0,\n      \"observacionesEncuadernacion\": \"\"\n    }\n  ]\n}\n\n### REGLAS\n- Devuelve **un objeto por cada fila** de la secci√≥n **T√çTULOS** (en este PDF son 4).\nPara cada objeto de \"titulos\":\n- Primero identifica suReferencia (C√≥digo Comercial) en T√çTULOS.\n- Usa esa suReferencia para localizar el √≠tem correspondiente en:\n  a) \"ELEMENTOS Y TIRADAS\" (para idElemento)\n  b) \"ACONDICIONAMIENTO Y ENTREGA / Instrucciones\" (bloque del √≠tem)\n  c) \"Descripci√≥n\" / ficha del art√≠culo (para Ed/Enc si aparece)\n- PROHIBIDO reutilizar el valor de encuadernacion de otro t√≠tulo/√≠tem.\n\n- En **ELEMENTOS Y TIRADAS**, busca el **Id (3115xxx)** asociado a cada **suReferencia** y rellena **idElemento**.\n\n\n### REGLAS OBLIGATORIAS\n1) Devuelve SOLO JSON. Sin texto adicional. Sin markdown. Sin explicaciones.  \n2) El JSON debe ser v√°lido (comillas dobles, sin trailing commas).  \n3) Cumple el esquema al 100%:  \n   - No inventes campos que no existan en el esquema.  \n   - No devuelvas claves extra fuera del esquema.  \n   - Respeta tipos (string/number/boolean/array/object).  \n4) Si un dato no aparece en el PDF:  \n   - Usa null si el esquema lo permite.  \n   - Si NO permite null, usa: \"\" para string, 0 para number, false para boolean.  \n5) Normalizaci√≥n (solo para buscar):  \n   - Coincidencia sin distinguir may√∫sculas/min√∫sculas.  \n   - Ignora acentos/diacr√≠ticos.  \n   - Colapsa espacios m√∫ltiples y recorta espacios sobrantes.  \n   - Elimina guiones de final de l√≠nea por OCR.  \n6) Verificaci√≥n final antes de responder:  \n   - Revisa que el JSON parsea.  \n   - Revisa que cumple el esquema.  \n   - Revisa que no hay texto fuera del JSON.\n\n---\n\n## REGLAS POR CAMPO (resumen)\n- \"cliente\": Devuelve 34.  \n- \"contacto\": Usa el prompt de CONTACTO.  \n- \"suReferencia\": En \"T√çTULOS\" busca \"C√≥digo Comercial\" (o variantes) y devuelve solo d√≠gitos (number).  \n- \"numeroOf\": En \"T√çTULOS\" busca \"N¬∫ O.F.\" o \"Orden de Fabricaci√≥n\".  \n- \"numeroOtCliente\": Busca \"ORDEN DE TRABAJO N¬∫\" o equivalente. Devuelve SIN puntos (ej \"1.132.221\" ‚Üí \"1132221\").  \n- \"fechaEntrega\": En \"ACONDICIONAMIENTO Y ENTREGA\" columna \"Fecha Entrega\" ‚Üí \"YYYY-MM-DD\". Fallback: primera fecha dd/mm/aaaa en instrucciones/entrega cerca de GETAFE/Distribuir/ENTREGAR.  \n- \"sinRetraso\": true si en instrucciones aparece literalmente \"URGENTE\"/\"URGENTES\". Si no, false.  \n- \"tirada\": En \"T√çTULOS\" campo \"TIRADA\".  \n- \"precioUnitarioSinIVA\": siempre 0.  \n- \"precioToltalSinIVA\": Busca \"TOTAL ORDEN\" (quita miles y coma‚Üípunto).  \n- \"quiereVerFerros\": instrucciones: 1 si \"ferro digital\"; 2 si \"ferro f√≠sico/fisico\"; 3 si nada.  \n- \"certificacion\": Usa CERTIFICACION.  \n- \"observacionesPedido\": Usa OBSERVACIONES.  \n- \"titulo\": SOLO en \"T√çTULOS\", columna \"T√≠tulo\". PROHIBIDO usar \"T√≠tulo del Elemento\" en \"ELEMENTOS Y TIRADAS\".  \n- \"sello\": primer sello/editorial del encabezado.  \n- \"isbn\": siempre \"\" (aunque aparezca).  \n- \"codProyecto\": En \"T√çTULOS\", campo \"C√≥digo Proyecto\".  \n- \"anchoPaginaCm\"/\"altoPaginaCm\": desde \"Formato\" (x, X, *, ¬∑).  \n- \"unionPliegos\": si contiene \"FRESADO\" ‚Üí 2; si contiene \"COSIDO\" ‚Üí 1.  \n- \"encuadernacion\": En Instrucciones: devuelve el n√∫mero 1=Carton√©/Tapa dura, 2=Flexible, 3=R√∫stica, 4=Espiral, 5=Grapa, 6=Wire-o, 7=Otro, si no encuentras referencia devuelve 3.\n\n## RESTO DE CAMPOS DEPENDIENTES (se mantienen como ya los ten√≠as)\n- \"cabezada\": 1 si aparece ‚ÄúCabezada SI/S√ç‚Äù y encuadernacion ‚àà {1,2}; si ‚ÄúSIN cabezadas‚Äù o no aparece ‚Üí 0.  \n- \"cabezadaColorOtro\": si ‚ÄúCabezada S√≠‚Äù y encuadernacion ‚àà {1,2}, extrae el texto tras ‚ÄúS√≠‚Äù (misma l√≠nea o 1 debajo). Si no hay texto ‚Üí \"\".  \n- \"guardasAparte\": 1 si encuadernacion ‚àà {1,2}, si no 0.  \n- \"guardasImpresas\": 1 si aparece ‚Äúguardas impresas‚Äù y encuadernacion ‚àà {1,2}, si no 0.  \n- \"cintaRegistro\": 1 si ‚ÄúCinta de registro SI/S√ç‚Äù y encuadernacion ‚àà {1,2}; si ‚ÄúNO‚Äù ‚Üí 0.  \n- \"cintaRegistroColorOtro\": si cintaRegistro=1 extrae texto tras ‚ÄúS√≠‚Äù (misma l√≠nea o 1 debajo).  \n- \"calibreCarton\": Usa CALIBRE (solo si encuadernacion ‚àà {1,2}, si no 0).  \n- \"tipoLomo\": 1=‚Äúlomo cuadrado‚Äù, 2=‚Äúlomo redondo‚Äù y encuadernacion ‚àà {1,2}, si no 0.  \n- \"solapa\": true si aparece ‚ÄúSOLAPA(S)‚Äù (en Elaboraciones/Encuadernaci√≥n o Instrucciones). false si ‚ÄúSIN SOLAPA(S)‚Äù o no aparece.  \n- \"hendidoCortesia\": Devuelve true SIEMPRE (no buscar en PDF).\n- Campos ‚Äúespiral...‚Äù/‚Äúwireo...‚Äù solo si aparecen expl√≠citamente; si no 0 o \"\".\n- \"observacionesEncuadernacion\": Solo si detectas \"Guardas impresas NO\" busca referencia material (ej: \"Geltex\").\n\n---\n\n## PROMPTS\n\n### CONTACTO\nBusca en el PDF solo en la parte inferior de la orden (el √∫ltimo cuarto de la p√°gina). Seguido a Fdo., localiza el nombre y apellidos juntos.\nReglas:\n- Coincidencia sin distinguir may√∫sculas/min√∫sculas.\n- Ignora acentos/diacr√≠ticos (√Å=A, √â=E, √ç=I, √ì=O, √ö=U, √ú=U, √ë=N).\n- Colapsa espacios m√∫ltiples y recorta espacios sobrantes.\n- Si varias l√≠neas coinciden tras normalizar, devuelve el usuarioId menor.\n- Si no hay coincidencia, devuelve 0.\nSalida: devuelve solo el n√∫mero usuarioId (entero, sin comillas).\nMapa nombre ‚Üí usuarioId:\n  Concepci√≥n Mercado = 160\n  Cristina Calvo = 161\n  Didac Puigcerver = 163\n  Jose E. Valdepe√±as = 164\n  Jose Exp√≥sito = 165\n  Juan A. Barras = 166\n  Juan F. Garc√≠a = 167\n  Juan J. Rodr√≠guez = 168\n  Luis M. Bustos = 169\n  Manuel Fern√°ndez = 170\n  Natalia Yag√ºez = 171\n  Ruben Camacho = 172\n  Oscar Bravo = 176\n  Juan F. Garc√≠a Escalonilla = 177\n  Daniel = 225\n  Pilar = 227\n  BEL√âN = 454\n  Carmen = 473\n  Maria Isabel = 476\n  ALEJANDRO = 482\n  Susana = 487\n  SARA = 495\n  Aurora = 501\n  √ÅNGELES = 506\n\n### OBSERVACIONES\n1. Localiza el bloque de texto del apartado ‚ÄúInstrucciones‚Äù del √≠tem (fila) correspondiente.\n2. Extrae el bloque completo desde la primera l√≠nea del bloque hasta justo antes de la primera aparici√≥n de:\n   - una fecha (dd/mm/aaaa o dd/mm/aa), o\n   - encabezado/log√≠stica tipo ‚ÄúPaquetes y/o Cajas‚Ä¶‚Äù, ‚ÄúENTREGAS:‚Äù, ‚ÄúFACTURACI√ìN:‚Äù, ‚ÄúOBSERVACIONES GENERALES‚Äù.\n3. Devuelve un solo p√°rrafo (reemplaza saltos de l√≠nea y guiones repetidos por espacio).\n4. No incluyas en observacionesPedido los valores de Fecha Entrega / Destino / Para.\n5. Si ‚ÄúInstrucciones‚Äù est√° en una celda contigua a otras columnas, NO concatenes esas columnas.\nNormaliza:\n- Sustituye cada salto de l√≠nea por un √∫nico espacio.\n- Colapsa espacios m√∫ltiples a uno y recorta.\n\n### CALIBRE\n(igual que tu versi√≥n actual: mapeo 1,5‚Üí1; 2,0‚Üí2; 2,5‚Üí3; 3,0‚Üí4; + espuma 3 ‚Üí 5/6/7; 1,75‚Üí8; 2,25‚Üí9; 2,75‚Üí10)\nReglas: scope por ‚Äúcalibre/cart√≥n/tapa/cubierta‚Ä¶‚Äù, normalizaci√≥n (.,=,), prioridad combos con espuma, desempate ‚Üí 0.\nSolo si encuadernacion ‚àà {1,2}, si no 0.\n\n### CERTIFICACION\n(igual que tu versi√≥n actual: bloque ‚ÄúDescripci√≥n‚Äù validado, dentro del bloque buscar ‚ÄúFSC Mix‚Äù‚Üí2, ‚ÄúPEFC‚Äù‚Üí4, si ambos prioriza FSC Mix; excluir cabeceras/pies y tablas Servicios/Componentes; salida solo n√∫mero)\n\n‚ÄúPara cada t√≠tulo, localiza primero ‚ÄòEd/Enc‚Äô o ‚ÄòEncuadernaci√≥n‚Äô en ELABORACIONES Y VALORACI√ìN; si existe, esa es la fuente principal y prevalece sobre Instrucciones.‚Äù\n\n---\n\n### IMPORTANTE\nDevuelve todos los valores del esquema aunque est√©n vac√≠os o sin datos.\n",
              "type": "string"
            },
            {
              "id": "c96c9a1c-073d-4f7e-b50a-3cd080f922a9",
              "name": "promptInteriores",
              "value": "## ANAYA v2 - INTERIORES MULTI T√çTULO\n\nAct√∫as como extractor de datos de √ìrdenes de Trabajo (PDF).\nDevuelve EXCLUSIVAMENTE un JSON v√°lido que cumpla el esquema EXACTO.\n\nREGLAS GENERALES\n1) Devuelve SOLO JSON (sin texto, sin markdown).\n2) JSON v√°lido (comillas dobles, sin comas finales).\n3) Devuelve SIEMPRE todas las claves del esquema. No a√±adas claves nuevas.\n4) Tipos estrictos: number/string/boolean.\n5) Si no hay dato: \"\" para string, 0 para number, false para boolean.\n6) Normaliza para comparar: min√∫sculas, sin acentos, colapsa espacios, elimina guiones de salto de l√≠nea OCR.\n\n‚ÄúPara cada idElemento (Id en ‚ÄòELEMENTOS Y TIRADAS‚Äô), devuelve al menos un objeto en interiores[] con ese idElemento.‚Äù\n‚ÄúNo mezcles datos entre idElemento distintos‚Äù.\n\nESQUEMA DE SALIDA (exacto)\n{\n  \"interiores\": [\n    {\n      \"idElemento\": \"\",\n      \"papel_id\": 0,\n      \"propietarioPapel\": 0,\n      \"tipoImpresion\": 0,\n      \"calidad\": \"\",\n      \"paginas\": 0,\n      \"plegadoOCortado\": 0,\n      \"maquina\": 0,\n      \"observaciones\": \"\",\n      \"papelPedido\": {\n        \"refPedido\": \"\",\n        \"gramaje\": 0,\n        \"anchoBobinaCm\": 0,\n        \"upsCalc\": 0,\n        \"ups\": 0,\n        \"metros\": 0,\n        \"kg\": 0\n      }\n    }\n  ]\n}\n\nOBJETIVO\nExtraer SOLO datos de INTERIORES. Ignora completamente cualquier dato de cubierta.\n\nMULTI T√çTULO (MUY IMPORTANTE)\n- En este PDF hay varios t√≠tulos (varios ‚ÄúidElemento‚Äù).\n- Debes devolver UN OBJETO en \"interiores\" por cada t√≠tulo (por cada idElemento) como m√≠nimo.\n- Si para un mismo idElemento detectas 2 papeles interiores distintos, devuelve 2 objetos para ese MISMO idElemento (duplicando idElemento).\n- PROHIBIDO mezclar p√°ginas/kg/papel entre idElemento distintos.\n\nC√ìMO OBTENER idElemento\n- Usa la secci√≥n ‚ÄúELEMENTOS Y TIRADAS‚Äù y toma la columna ‚ÄúId‚Äù (ej: 3115677).\n- Ese ‚ÄúId‚Äù es el idElemento.\n- Luego, cuando busques materiales/elaboraciones/p√°ginas, aseg√∫rate de que la informaci√≥n corresponde a ese mismo idElemento\n  (por proximidad en la tabla, o por coincidencia con el t√≠tulo/c√≥digo comercial asociado, o por fila del elemento).\n\nFILTRO (MUY IMPORTANTE)\n- Solo considera filas/textos donde aparezca: ‚ÄúINT‚Äù, ‚ÄúINTERIOR‚Äù, ‚ÄúCTE INT‚Äù, ‚ÄúCUERPO‚Äù, ‚ÄúINTERIORES‚Äù.\n- Excluye cualquier fila/texto donde aparezca: ‚ÄúCUB‚Äù, ‚ÄúCUBIERTA‚Äù, ‚ÄúTAPA‚Äù, ‚ÄúSOBRECUBIERTA‚Äù.\n\nFLUJO DE EXTRACCI√ìN (prioridad obligatoria)\nA) Primero intenta MATERIALES ‚Üí columna ‚ÄúMaterial‚Äù (solo interiores) y SOLO del idElemento correspondiente.\nB) Si no hay MATERIALES para interiores, usa ELABORACIONES Y VALORACI√ìN ‚Üí ‚ÄúClase de papel‚Äù (solo interiores) y SOLO del idElemento correspondiente.\nC) Si tampoco hay, usa Observaciones/Instrucciones que describan el papel interior, SOLO del idElemento correspondiente.\n\nMAPEO por MATERIALES/Material (solo interiores)\n- Si en MATERIALES / Material aparece literal OFF.PQ.AHUE.SAT.ORIA PEFC. 54,0x 0,0.110,0 (gr.) ‚Üí papel_id 596\n- Si en MATERIALES / Material aparece literal OFF.DIG.PQ.AHUE.SAT.ORIA PEFC. 50,0x 0,0. 80,0 (gr.) ‚Üí papel_id 593\n- Si en MATERIALES / Material aparece literal OFF.PQ.AHUE.SAT.ORIA PRINT IVORY PEFC. 54,0x 0,0. 70,0 (gr.) ‚Üí papel_id 592\n- Si en MATERIALES / Material aparece literal OFF.PQ.AHUE.SAT.ORIA PRINT IVORY PEFC. 48,0x 0,0. 70,0 (gr.) ‚Üí papel_id 590\n- Si en MATERIALES / Material aparece literal OFF.PQ.AHUE.SAT.ORIA PRINT IVORY PEFC. 52,0x 0,0. 70,0 (gr.) ‚Üí papel_id 588\n\nSI HAY papel_id POR MAPEO\n- 596 ‚Üí propietarioPapel 2, calidad \"Ahuesado\", gramaje 110, refPedido \"Ahuesado Oria (ANAYA)\", anchoBobinaCm 54\n- 593 ‚Üí propietarioPapel 2, calidad \"Ahuesado\", gramaje 80, refPedido \"Ahuesado Oria (ANAYA)\", anchoBobinaCm 50\n- 592 ‚Üí propietarioPapel 2, calidad \"Ahuesado\", gramaje 70, refPedido \"Ahuesado Oria (ANAYA)\", anchoBobinaCm 54\n- 590 ‚Üí propietarioPapel 2, calidad \"Ahuesado\", gramaje 70, refPedido \"Ahuesado Oria (ANAYA)\", anchoBobinaCm 48\n- 588 ‚Üí propietarioPapel 2, calidad \"Ahuesado\", gramaje 70, refPedido \"Ahuesado Oria (ANAYA)\", anchoBobinaCm 52\n\nSI NO HAY papel_id POR MAPEO (fallback)\n- Si no encuentras Materiales, toma ‚ÄúClase de papel‚Äù en ELABORACIONES Y VALORACI√ìN -Elementos gr√°ficos- para interiores.\n  devuelve literalmente:\n            devuleve literalmente \"Ahuesado\" si aparece solo la referencia ahuesado\n            devuleve literalmente \"Ahuesado volumen 1.5\" si aparece solo la referencia ahuesado mano 1.5 o ahuesado 1.5\n            devuleve literalmente \"Ahuesado volumen 1.6\" si aparece solo la referencia ahuesado mano 1.6 o ahuesado 1.6\n            devuleve literalmente \"Ahuesado volumen 1.8\" si aparece solo la referencia ahuesado mano 1.8 o ahuesado 1.8\n            devuleve literalmente \"Ahuesado volumen 2\" si aparece solo la referencia ahuesado mano 2.0 o ahuesado 2.0 o ahuesado 2\n            devuleve literalmente \"Estucado semimate\" si aparece solo la referencia Estudado o Estucado semimate\n            devuleve literalmente \"Offset blanco\" si aparece solo la referencia Offset blanco\n            devuleve literalmente \"Offset Blanco Volumen\" si aparece solo la referencia Offset Blanco Volumen\n            En estos casos deja \"papel_id\": 0 y propietarioPapel = 1.\n  En fallback deja papel_id=0 y propietarioPapel=1.\n- gramaje: devuelve el valor de Grs al lado de clase de papel\n\ntipoImpresion (interiores)\n- Si detectas ‚Äú1/1‚Äù, ‚Äú1+1‚Äù, ‚ÄúNEGRO‚Äù, ‚ÄúB/N‚Äù o ‚ÄúInkjet Premium‚Äù ‚Üí tipoImpresion = 2\n- Si detectas ‚Äú4/4‚Äù, ‚Äú4+4‚Äù, ‚ÄúCMYK‚Äù, ‚Äúcuatricrom√≠a‚Äù, ‚Äúcolor‚Äù ‚Üí tipoImpresion = 1\n- Si no hay evidencia ‚Üí tipoImpresion = 1\n\npaginas\n- En ELABORACIONES Y VALORACI√ìN - Elementos gr√°ficos, toma el valor ‚ÄúP√°g.‚Äù asociado a interiores del idElemento.\n- Si no aparece, 0.\n\nkg\n- En MATERIALES, usa la fila del papel interior (por filtro INT/INTERIOR) del MISMO idElemento y toma la columna Kg de esa fila (no totales).\n- Si no aparece, 0.\n\nCampos fijos (no extraer)\nplegadoOCortado=0, maquina=0, observaciones=\"\", upsCalc=0, ups=0, metros=0.\n",
              "type": "string"
            },
            {
              "id": "61b81b8a-7210-47b0-8839-f6cf5cb901c4",
              "name": "promptCubierta",
              "value": "### ANAYA v1\n\nAct√∫as como un extractor de datos de √ìrdenes de Trabajo (PDF). Tu tarea es analizar el PDF adjunto y devolver EXCLUSIVAMENTE un JSON v√°lido que cumpla ESTRICTAMENTE el esquema proporcionado.\n\nREGLAS OBLIGATORIAS\n1) Devuelve SOLO JSON. Sin texto adicional. Sin markdown. Sin explicaciones.\n2) El JSON debe ser v√°lido (comillas dobles, sin trailing commas).\n3) Devuelve EXACTAMENTE las claves del esquema (ni m√°s ni menos).\n4) Respeta tipos:\n   - number: solo n√∫meros (sin comillas)\n   - string: texto entre comillas\n5) Si un dato NO aparece en el PDF: usa 0 para number y \"\" para string.\n6) Normalizaci√≥n para b√∫squeda:\n   - Coincidencia insensible a may√∫sculas/min√∫sculas.\n   - Ignora acentos/diacr√≠ticos.\n   - Colapsa espacios y saltos m√∫ltiples a un espacio.\n   - Elimina guiones de final de l√≠nea por OCR.\n7) Consistencia: NO mezcles datos de interiores con cubierta.\n8) Verificaci√≥n final: el JSON debe parsear y no debe haber nada fuera del JSON.\n\nMODELO DE SALIDA (exacto)\n{\n  \"cubiertas\": [\n    {\n      \"idElemento\": \"\",\n      \"materialCubierta\": 0,\n      \"propietarioPapel\": 0,\n      \"plastificado\": 0,\n      \"uvi\": 0,\n      \"impresion\": \"4/0\",\n      \"codDescarga\": 0,\n      \"tecnologia\": 0,\n      \"observaciones\": \"\"\n    }\n  ]\n}\n\n\nOBJETIVO\nExtraer SOLO datos de CUBIERTA (portada/tapa). Ignora completamente interiores.\n\nFILTRO (muy importante)\n- Solo considera texto/filas donde aparezca alguna de estas evidencias:\n  \"CUB\", \"CUBIERTA\", \"TAPA\", \"PORTADA\", \"SOBRECUBIERTA\", \"CUB. EXT\", \"CUB EXT\", \"CUBIERTA EXT\"\n- Excluye texto/filas donde aparezca:\n  \"INT\", \"INTERIOR\", \"CTE INT\", \"INTERIORES\", \"CUERPO\"\n\nFUENTES PRIORITARIAS (orden obligatorio)\n1) SECCI√ìN \"ELABORACIONES Y VALORACI√ìN - Elementos gr√°ficos\" (si hay referencia espec√≠fica a cubierta)\n2) SECCI√ìN \"ACONDICIONAMIENTO Y ENTREGA / Instrucciones\" (solo si menciona cubierta expl√≠citamente)\n\nANCLAJE POR idElemento (OBLIGATORIO)\nDevuelve un objeto por cada idElemento del pedido.\nPara cada idElemento:\n1) Localiza el idElemento en ‚ÄúELEMENTOS Y TIRADAS‚Äù.\n2) Con ese bloque del elemento, busca SOLO datos de CUBIERTA en ‚ÄúELABORACIONES Y VALORACI√ìN - Elementos gr√°ficos‚Äù\n   (filas Cte CUB / CUB / Cubierta / Tapa / Portada).\n3) Si no hay datos de cubierta para ese idElemento, rellena con 0 / \"\" (pero devuelve igualmente el objeto).\nPROHIBIDO mezclar datos entre idElemento distintos.\n\nREGLAS POR CAMPO\n\nA) materialCubierta (number)\nELABORACIONES Y VALORACI√ìN -Elementos gr√°ficos- / Clase de papel\n    - Si Cte CUB -> Clase de papel CARTULINA GOF2C -> 250 devuelve estos valores ‚áí materialCubierta=14  ‚áí propietarioPapel=1  ‚áí plastificado=6 (SIGNIFICA: SIN PLASTIFICADO / NO APLICA, No eval√∫es el campo Recubrimiento ni busques plastificado en instrucciones. Ignora ‚ÄúGOFRADO‚Äù si apareciera en otro contexto)\n    - Si Cte CUB -> Clase de papel CART.EST.1C.PQ -> 240 devuelve estos valores ‚áí materialCubierta=1  ‚áí propietarioPapel=1\n    - Si Cte CUB -> Clase de papel FOLD.EST -> 200 devuelve estos valores ‚áí materialCubierta=1  ‚áí propietarioPapel=1\n\n    - Si la encuadernaci√≥n es Carton√©/Tapa dura/Flexible devuelve estos valores ‚áí materialCubierta=2  ‚áí propietarioPapel=1\n\nB) plastificado (number)\n    - ELABORACIONES Y VALORACI√ìN -Elementos gr√°ficos- / Recubrimiento (m√°s espec√≠fico ‚Üí gen√©rico; insensible a may√∫sculas/acentos):\n          \"MATE SEDOSO\"‚Üí3\n          \"MATE ANTIRRAYA\"‚Üí4\n          \"BRILLO DIGITAL\"‚Üí7\n          \"MATE DIGITAL\"‚Üí8,\n          \"GOFRADO\"‚Üí5\n          \"NATUREFLEX\"‚Üí9\n          \"SANDY\"‚Üí10\n          \"BRILLO\"‚Üí1\n          \"MATE\"‚Üí2,\n          IMPORTANTE: Si Recubrimiento est√° vac√≠o o no existe ‚Üí plastificado=6\n\nC) uvi (number)\nACONDICIONAMIENTO Y ENTREGA / Instrucciones\n    - Busca ‚ÄúUVI‚Äù, ‚ÄúUV‚Äù, ‚ÄúBARNIZ UVI‚Äù, ‚ÄúBARNIZ UV‚Äù, ‚ÄúRESERVA UVI/UV‚Äù.\n    - Mapea:\n      - ‚ÄúUVI/UV TOTAL‚Äù / ‚ÄúUV TOTAL‚Äù ‚Üí uvi = 1\n      - ‚ÄúUVI/UV RESERVA‚Äù / ‚ÄúUV RESERVA‚Äù / ‚ÄúRESERVA‚Äù ‚Üí uvi = 2\n      - ‚ÄúSIN UVI/UV‚Äù ‚Üí uvi = 0\n    - Solo considera ‚ÄòRESERVA‚Äô si est√° en la misma frase/l√≠nea que ‚ÄòUVI‚Äô, ‚ÄòUV‚Äô o ‚ÄòBARNIZ\n    - Si no se menciona ‚Üí 0\n\nD) impresion (string)\nELABORACIONES Y VALORACI√ìN -Elementos gr√°ficos- / b/v\n- Extrae el formato de impresi√≥n de la cubierta si aparece (ej: 1/0, 1/1, 4/0, 4/1, 4/4, 5/0.\n- Si no hay evidencia, deja el valor por defecto: \"4/0\"\n\nE) codDescarga (number)\n-Busca en T√çTULOS / Imprimir C√≥digo\n    - Si = 1\n    - NO = 0\n\nF) tecnologia (number)\n\nH) observaciones (string)\nACONDICIONAMIENTO Y ENTREGA / Instrucciones. Extrae solo frases que contengan ‚Äòcubierta‚Äô, ‚Äòtapa‚Äô, ‚Äòportada‚Äô, ‚Äòsolapa‚Äô, ‚Äòplastificado‚Äô, ‚Äòrecubrimiento‚Äô, ‚Äògofrado‚Äô, ‚Äòuvi/uv‚Äô, ‚Äòbarniz‚Äô, ‚Äòlaminado.\n\nIMPORTANTE\n- No uses informaci√≥n de ‚Äúinteriores‚Äù para completar campos de cubierta.\n- Devuelve SOLO el JSON final.\n",
              "type": "string"
            },
            {
              "id": "5dab2b9d-9686-473a-85b9-8bfe63dfe1d0",
              "name": "promptExtras",
              "value": "### ANAYA v1 ‚Äî EXTRAS (por t√≠tulo con idElemento)\n\nAct√∫as como un extractor de datos de √ìrdenes de Trabajo (PDF).  \nTu tarea es analizar el PDF adjunto y devolver **EXCLUSIVAMENTE un JSON v√°lido** que cumpla **ESTRICTAMENTE** el esquema proporcionado.\n\n---\n\n## REGLAS OBLIGATORIAS\n1) Devuelve **SOLO JSON**. Sin texto adicional. Sin markdown. Sin explicaciones.  \n2) El JSON debe ser v√°lido (comillas dobles, sin comas finales).  \n3) Devuelve **EXACTAMENTE** las claves del esquema (ni m√°s ni menos).  \n4) Respeta tipos estrictos:\n   - number: solo n√∫meros (sin comillas)\n   - string: texto entre comillas\n   - boolean: true/false\n   - array: siempre `[]` si no hay elementos\n   - object: siempre con todas sus claves\n5) Si un dato NO aparece en el PDF:\n   - string ‚Üí `\"\"`\n   - number ‚Üí `0`\n   - boolean ‚Üí `false`\n   - array ‚Üí `[]`\n6) Normalizaci√≥n SOLO para detecci√≥n/b√∫squeda:\n   - Coincidencia sin distinguir may√∫sculas/min√∫sculas.\n   - Ignora acentos/diacr√≠ticos.\n   - Colapsa espacios m√∫ltiples y saltos a un √∫nico espacio.\n   - Elimina guiones al final de l√≠nea por OCR.\n7) **Consistencia por √≠tem**: NO mezcles datos entre t√≠tulos. Cada objeto se rellena con el contenido del t√≠tulo correspondiente.\n8) Verificaci√≥n final: el JSON debe parsear y no debe haber nada fuera del JSON.\n\n---\n\n## OBJETIVO\nExtraer **EXTRAS** por cada √≠tem (t√≠tulo) del PDF y devolverlos en un array.  \nCada objeto debe incluir `idElemento` para poder emparejar despu√©s con cabecera/cubierta/interiores.\n\n---\n\n## REGLA DE ITEMS (OBLIGATORIA)\n- Devuelve **un objeto por cada fila de la secci√≥n ‚ÄúT√çTULOS‚Äù** (en este PDF son 4).\n- El array de salida es `extras` y debe contener 4 objetos.\n- Cada objeto corresponde a un t√≠tulo distinto.\n\n---\n\n## C√ìMO OBTENER `idElemento` (OBLIGATORIO)\nPara cada t√≠tulo:\n1) En la secci√≥n **T√çTULOS**, identifica el **C√≥digo Comercial** (tambi√©n puede aparecer como ‚ÄúC√≥digo Comercial‚Äù, ‚ÄúC√≥d. Com.‚Äù, ‚ÄúCod. Com.‚Äù).  \n2) Ve a **ELEMENTOS Y TIRADAS** y encuentra el **Id (3115xxx)** asociado a ese C√≥digo Comercial.  \n3) Devuelve ese Id en `idElemento` como **string** (ej: `\"3115677\"`).\n\nSi no se encuentra, `idElemento` = `\"\"`.\n\n---\n\n## ESQUEMA DE SALIDA (EXACTO)\n```json\n{\n  \"extras\": [\n    {\n      \"idElemento\": \"\",\n      \"guardas\": {\n        \"papel_id\": 0,\n        \"propietarioPapel\": 0,\n        \"tipoImpresion\": 0,\n        \"calidad\": \"\",\n        \"paginas\": 0,\n        \"plegadoOCortado\": 0,\n        \"maquina\": 0,\n        \"observaciones\": \"\",\n        \"papelPedido\": {\n          \"refPedido\": \"\",\n          \"gramaje\": 0,\n          \"anchoBobinaCm\": 0,\n          \"upsCalc\": 0,\n          \"ups\": 0,\n          \"metros\": 0,\n          \"kg\": 0\n        },\n        \"papelProduccion\": {\n          \"refProduccion\": \"\",\n          \"gramaje\": 0,\n          \"anchoBobinaCm\": 0,\n          \"upsCalc\": 0,\n          \"ups\": 0,\n          \"metros\": 0,\n          \"kg\": 0\n        }\n      },\n      \"sobrecubierta\": {\n        \"materialSobrecubierta\": 0,\n        \"propietarioPapel\": 0,\n        \"plastificado\": 0,\n        \"uvi\": 0,\n        \"impresion\": \"\",\n        \"tecnologia\": 0,\n        \"observaciones\": \"\"\n      },\n      \"faja\": {\n        \"materialFaja\": 0,\n        \"propietarioPapel\": 0,\n        \"plastificado\": 0,\n        \"uvi\": 0,\n        \"impresion\": \"\",\n        \"tecnologia\": 0,\n        \"observaciones\": \"\"\n      },\n      \"componentesEspeciales\": [\n        {\n          \"material\": 0,\n          \"propietarioPapel\": 0,\n          \"nombre\": \"\",\n          \"plastificado\": 0,\n          \"uvi\": 0,\n          \"impresion\": \"\",\n          \"tecnologia\": 0,\n          \"observaciones\": \"\"\n        }\n      ],\n      \"peticionesEspeciales\": [\n        {\n          \"descripcion\": \"\"\n        }\n      ],\n      \"direcciones\": [\n        {\n          \"direccionId\": \"\",\n          \"destinatario\": \"\",\n          \"via\": \"\",\n          \"numero\": \"\",\n          \"piso\": \"\",\n          \"puerta\": \"\",\n          \"cp\": \"\",\n          \"localidad\": \"\",\n          \"provincia\": \"\",\n          \"pais\": \"\",\n          \"contacto\": \"\",\n          \"telefonos\": \"\",\n          \"pallet\": 0,\n          \"encajado\": 0,\n          \"ejemplaresPaquete\": 0,\n          \"ejemplares\": 0,\n          \"envioResto\": 0,\n          \"modelos\": 0,\n          \"observaciones\": \"\"\n        }\n      ]\n    }\n  ]\n}\n\n## SCOPING / FUENTES POR T√çTULO (MUY IMPORTANTE)\n\nPara cada objeto de `extras[]`:\n\n- Prioriza informaci√≥n dentro del bloque del √≠tem (fila) en:\n  - **ACONDICIONAMIENTO Y ENTREGA / Instrucciones** (si est√° tabulado por t√≠tulo)\n  - **T√çTULOS** (si hay columnas por t√≠tulo)\n  - **COMPONENTES / SERVICIOS / OBSERVACIONES** (si hay referencias claras al t√≠tulo)\n\n- Si el PDF tiene instrucciones generales sin separaci√≥n por t√≠tulo:\n  - Puedes aplicarlas a todos los t√≠tulos **solo si no hay contradicci√≥n**.\n\n## GUARDAS\n\n### Gate (obligatorio)\nSolo rellenar `guardas` si se cumplen **AMBAS** condiciones:\n\n1) Hay menci√≥n expl√≠cita a guardas en el √≠tem:  \n   - ‚Äúguardas incluidas‚Äù, ‚Äúguardas aparte‚Äù, ‚Äúguardas impresas‚Äù, ‚Äúguardas‚Äù.\n\n2) La encuadernaci√≥n del √≠tem permite guardas:\n   - Si `encuadernacion` = 3 (R√∫stica), 4 (Espiral), 5 (Grapa) o 6 (Wire-o) ‚Üí **NO lleva guardas** ‚Üí deja `guardas` por defecto.\n   - Solo lleva guardas si `encuadernacion` = 1 (Carton√©/Tapa dura) o 2 (Flexible).\n\n**Importante:** si no puedes determinar `encuadernacion` del √≠tem, **NO inventes guardas**; deja `guardas` por defecto.\n\n---\n\n### C√≥mo rellenar\n- Si se menciona **‚Äúguardas aparte‚Äù**: busca en el texto de guardas la descripci√≥n del papel (si aparece) y √∫sala como `papelPedido.refPedido`.\n- Si se menciona **‚Äúguardas incluidas‚Äù**: usa la descripci√≥n del papel del interior como `papelPedido.refPedido` **solo si el PDF lo dice expl√≠citamente** (si no, `\"\"`).\n\n---\n\n### Mapeos exactos (si detectas estas calidades en la descripci√≥n de guardas)\n\n#### Si detectas ‚ÄúAhuesado‚Äù\n- `guardas.papel_id = 561`\n- `guardas.propietarioPapel = 1`\n- `guardas.tipoImpresion = 1`\n- `guardas.calidad = \"Ahuesado\"`\n- `guardas.paginas = 8`\n- `guardas.papelPedido.refPedido = \"Ahuesado Oria\"`\n- `guardas.papelPedido.gramaje = 120`\n- `guardas.papelPedido.anchoBobinaCm = 54`\n- `guardas.papelPedido.ups = 2`\n- Lo dem√°s por defecto\n\n#### Si detectas ‚ÄúOffset blanco‚Äù\n- `guardas.papel_id = 620`\n- `guardas.propietarioPapel = 1`\n- `guardas.tipoImpresion = 1`\n- `guardas.calidad = \"Offset blanco\"`\n- `guardas.paginas = 8`\n- `guardas.papelPedido.refPedido = \"Navigator Offset Premium 161\"`\n- `guardas.papelPedido.gramaje = 120`\n- `guardas.papelPedido.anchoBobinaCm = 54`\n- `guardas.papelPedido.ups = 2`\n- Lo dem√°s por defecto\n\n#### Si detectas ‚ÄúEstucado‚Äù / ‚ÄúEstucado semimate‚Äù\n- `guardas.papel_id = 613`\n- `guardas.propietarioPapel = 1`\n- `guardas.tipoImpresion = 1`\n- `guardas.calidad = \"Estucado semimate\"`\n- `guardas.paginas = 8`\n- `guardas.papelPedido.refPedido = \"G-Silk\"`\n- `guardas.papelPedido.gramaje = 150`\n- `guardas.papelPedido.anchoBobinaCm = 54`\n- `guardas.papelPedido.ups = 2`\n- Lo dem√°s por defecto\n\n---\n\n### Si no hay menci√≥n v√°lida\nDeja `guardas` completo por defecto (todo `0` / `\"\"` / `false`).\n\n## SOBRECUBIERTA\n\n### Gate SOBRECUBIERTA (OBLIGATORIO)\nSolo cuenta si aparece literal como palabra independiente:\n- ‚Äúsobrecubierta‚Äù o ‚Äúsobre cubierta‚Äù o ‚Äúsobre-cubierta‚Äù\n\nSi **NO** aparece literal ‚Üí deja `sobrecubierta` por defecto.  \nSi aparece negado en una ventana de ¬±5 palabras (‚Äúsin‚Äù, ‚Äúno‚Äù, ‚Äúnunca‚Äù) ‚Üí por defecto.\n\n---\n\n### Si pasa el gate, rellena\n- `materialSobrecubierta = 15`\n- `propietarioPapel = 1`\n\n#### plastificado (desde la misma l√≠nea o 2 siguientes)\n- brillo ‚Üí 1  \n- mate ‚Üí 2  \n- mate sedoso ‚Üí 3  \n- mate antirraya ‚Üí 4  \n- gofrado ‚Üí 5  \n- brillo digital ‚Üí 7  \n- mate digital ‚Üí 8  \n- natureflex ‚Üí 9  \n- sandy ‚Üí 10  \n- cualquier otro caso ‚Üí 6  \n\n#### uvi\n- `1` si aparece ‚ÄúUVI‚Äù o ‚ÄúUV‚Äù o ‚Äúbarniz uvi/uv‚Äù en ese √°mbito  \n- si no ‚Üí `0`\n\n#### impresion\n- usa literal si aparece: `\"4/0\"`, `\"4/1\"`, `\"4/4\"`, `\"1/0\"`, `\"5/0\"`\n- si aparece ‚Äúreverso‚Äù ‚Üí `\"4/4\"`\n- si no aparece ‚Üí `\"4/0\"`\n\n#### tecnologia\n- deja `0` (se calcula fuera)\n\n#### observaciones\n- `\"Recibimos modelo de impresi√≥n\"` solo si aparece ‚Äúenviamos modelo‚Äù, ‚Äúenviamos prueba‚Äù, ‚Äúmuestra de impresi√≥n‚Äù\n\n---\n\n### Prohibici√≥n\n**PROHIBIDO** copiar valores desde ‚Äúcubierta‚Äù a ‚Äúsobrecubierta‚Äù.\n\n## FAJA\n\n### Gate FAJA (OBLIGATORIO)\nSolo cuenta si aparece ‚Äúfaja‚Äù o ‚Äúfajilla‚Äù como palabra independiente.\n\n- Si **NO** aparece ‚Üí deja `faja` por defecto.  \n- Si aparece negado (‚Äúsin faja‚Äù, ‚Äúno lleva faja‚Äù) ‚Üí por defecto.\n\n---\n\n### Si pasa el gate, rellena\n- `materialFaja = 15`\n- `propietarioPapel = 1`\n- `plastificado`: (misma tabla que sobrecubierta)\n- `uvi`: `1` si aparece UVI/UV, si no `0`\n- `impresion`: literal si aparece; si ‚Äúreverso‚Äù ‚Üí `\"4/4\"`; si no ‚Üí `\"4/0\"`\n- `tecnologia`: `0`\n- `observaciones`: `\"Recibimos modelo de impresi√≥n\"` solo si hay evidencia de ‚Äúenviamos modelo/prueba/muestra‚Äù\n\n---\n\n### Prohibici√≥n\n**PROHIBIDO** copiar valores desde ‚Äúcubierta‚Äù a ‚Äúfaja‚Äù.\n\n---\n\n## COMPONENTES ESPECIALES\n\nDetecta menciones literales (no negadas) de:\n- ‚Äúcuadernillo‚Äù\n- ‚Äúencarte‚Äù\n- ‚Äúpliego‚Äù\n\nSi detectas alguno, rellena `componentesEspeciales` con **un objeto por cada componente distinto detectado** (sin duplicados):\n- `nombre`: `\"CUADERNILLO\"`, `\"ENCARTE\"` o `\"PLIEGO\"`\n- `propietarioPapel`: `1`\n- `material`: si el PDF indica un papel/gramaje claro asociado, pon el ID si existe; si no, `0`\n- `impresion`: literal si aparece (`\"4/0\"`, `\"4/1\"`, `\"4/4\"`, `\"1/0\"`, `\"5/0\"`). Si no, `\"4/0\"`\n- `tecnologia`: `1`\n- `observaciones`: l√≠neas relacionadas (saltos ‚Üí espacios)\n- `plastificado`: `0`\n- `uvi`: `0`\n\nSi no hay menciones, entonces `componentesEspeciales` debe ser un array vac√≠o:\n```json\n[]\n\n### PETICIONES ESPECIALES:\n\nAnaliza el texto del PDF (en texto plano) y detecta si se solicitan estos elementos especiales: Faja, Topo, Sobrecubierta, Cuadernillo, Encarte, Pliego.\n\nReglas generales de detecci√≥n\n    No distingas may√∫sculas/min√∫sculas ni acentos.\n    No hagas inferencias por contexto: solo cuenta si aparece la palabra clave literal.\n    La coincidencia debe ser palabra completa, separada por espacios o signos de puntuaci√≥n.\n    No cuentes coincidencias dentro de otras palabras (por ejemplo: ‚Äúfajardo‚Äù, ‚Äútopograf√≠a‚Äù, ‚Äúplegadora‚Äù no valen).\n    Revisa primero las zonas de Observaciones, Notas y Componentes/Servicios; si no encuentras nada, revisa el resto del documento.\n\nNegaciones\n    Si una menci√≥n est√° negada cerca de la palabra clave, NO la cuentes.\n    Usa una ventana de ¬±5 palabras alrededor de la palabra clave.\n    Palabras o frases de negaci√≥n: ‚Äúsin‚Äù, ‚Äúno‚Äù, ‚Äúno lleva‚Äù, ‚Äúsin llevar‚Äù, ‚Äúsin colocar‚Äù.\n    Ejemplos: ‚Äúsin faja‚Äù ‚Üí no contar ‚Äúfaja‚Äù; ‚Äúno lleva sobrecubierta‚Äù ‚Üí no contar ‚Äúsobrecubierta‚Äù; ‚Äúno colocar topo‚Äù ‚Üí no contar ‚Äútopo‚Äù.\n    Si ves ‚Äúguardas‚Äù: null, ‚Äúsobrecubierta‚Äù: null, ‚Äúfaja‚Äù: null, no lo cuentes.\n\nPalabras clave por tipo\n\nFaja:\nPalabra clave: ‚Äúfaja‚Äù.\nSolo cuenta ‚Äúfaja‚Äù como palabra independiente.\nNo cuentes ‚Äúfajilla‚Äù ni otras palabras m√°s largas que contengan ‚Äúfaja‚Äù.\nSi hay una menci√≥n v√°lida (no negada), a√±ade ‚ÄúColocar faja‚Äù al array peticionesEspeciales.\n\nTopo:\nPalabra clave: ‚Äútopo‚Äù.\nSolo cuenta ‚Äútopo‚Äù como palabra independiente.\nSi hay una menci√≥n v√°lida (no negada), a√±ade ‚ÄúColocar topo‚Äù al array peticionesEspeciales.\n\nSobrecubierta:\nPalabra clave: ‚Äúsobrecubierta‚Äù.\nAcepta como equivalentes las variantes con espacio o guion: ‚Äúsobre cubierta‚Äù, ‚Äúsobre-cubierta‚Äù.\nNo cuentes ‚Äúcubierta‚Äù sola.\nNo deduzcas nunca que hay sobrecubierta por tipo de encuadernaci√≥n, UVI, plastificado, carton√©, guardas, faja o fajilla. Solo cuenta si aparece literalmente ‚Äúsobrecubierta‚Äù (o sus variantes indicadas).\nSi hay una menci√≥n v√°lida (no negada), a√±ade ‚ÄúColocar Sobrecubierta‚Äù al array peticionesEspeciales.\n\nCuadernillo:\nPalabra clave: ‚Äúcuadernillo‚Äù.\nSi hay una menci√≥n v√°lida (no negada), a√±ade al array peticionesEspeciales la(s) frase(s) donde se mencione ‚Äúcuadernillo‚Äù, omitiendo referencias a papel (tipo de papel, gramaje, etc.).\n\nEncarte:\nPalabra clave: ‚Äúencarte‚Äù.\nSi hay una menci√≥n v√°lida (no negada), a√±ade al array peticionesEspeciales la(s) frase(s) donde se mencione ‚Äúencarte‚Äù, omitiendo referencias a papel.\n\nPliego:\nPalabra clave: ‚Äúpliego‚Äù.\nSi hay una menci√≥n v√°lida (no negada), a√±ade al array peticionesEspeciales la(s) frase(s) donde se mencione ‚Äúpliego‚Äù, omitiendo referencias a papel.\n\nConstrucci√≥n de peticionesEspeciales:\npeticionesEspeciales es un array de cadenas.\nPuede contener:\n\n‚ÄúColocar faja‚Äù\n\n‚ÄúColocar topo‚Äù\n\n‚ÄúColocar Sobrecubierta‚Äù\n\nLas frases correspondientes a Cuadernillo, Encarte y Pliego (sin referencias a papel).\n\nCada tipo de elemento solo puede aparecer una vez en el array.\nEl array debe respetar el orden en el que se detecta cada elemento por primera vez en el documento.\nSi un elemento no aparece o solo aparece en forma negada, no lo a√±adas al array.\n\nProhibiciones\nNo inventes elementos especiales si no aparecen las palabras clave expl√≠citas.\nNo infieras Faja, Topo, Sobrecubierta, Cuadernillo, Encarte o Pliego por contexto, tipo de libro, UVI, plastificado, carton√©, fajilla, etc.\nNo cuentes menciones negadas.\nNo generes texto extra fuera de la estructura de salida.\n\nSalida esperada (solo esto):\nUn objeto JSON con:\n‚ÄúpeticionesEspeciales‚Äù: array de cadenas.\n\n### DIRECCIONES:\n\n      Reglas:\n          Buscar si existe un alias exacto en el PDF:\n              Usa coincidencia insensible a may√∫sculas/min√∫sculas, acentos y elimina espacios extra.\n              La coincidencia debe ser por frase completa (no dentro de otras palabras).\n          En caso de empate:\n              Prefiere alias completo exacto.\n              Luego la cadena coincidente m√°s larga.\n              Luego el menor direccionId.\n          Si se encuentra un alias:\n            Devuelve un objeto con:\n              \"direccionId\" correspondiente del mapa.\n              Solo el campo \"ejemplares\" con el n√∫mero de tirada.\n              Todos los dem√°s campos deben ir vac√≠os (\"\") o en 0.\n              Si NO se encuentra alias:\n              Usa \"direccionId\": 0.\n              Extrae del PDF todos los campos posibles:\n              via, numero, piso, puerta, cp, localidad, provincia, pais, contacto, telefonos, pallet, encajado, ejemplaresPaquete, ejemplares, envioResto, modelos, observaciones.\n              Si alg√∫n campo no aparece, d√©jalo vac√≠o (\"\") o en 0.\n              Regla adicional \"Sin muestras\" o \"Sin muestra\":\n              Si NO se encuentra la referencia \"Sin muestras\" o \"Sin muestra\" en observaciones:\n\n            Mapa ‚Üí direccionId:\n                  GETAFE = 2\n                  OFICINA = 3\n                  TRACTILPACK = 52\n                  GAMAN ENCUADERNACI√ìN = 221\n\n      Formato de salida (id√©ntico a este):\n      Si encuentras direccionId devuleve:\n      {\n        \"direcciones\": [\n          {\n            \"direccionId\": 0,\n            \"ejemplares\": 0\n          }\n        ]\n      }\n      \n      Si no completa este:    \n      {\n        \"direcciones\": [\n          {\n            \"direccionId\": 0,\n            \"destinatario\": \"\",\n            \"via\": \"\",\n            \"numero\": \"\",\n            \"piso\": \"\",\n            \"puerta\": \"\",\n            \"cp\": \"\",\n            \"localidad\": \"\",\n            \"provincia\": \"\",\n            \"pais\": \"\",\n            \"contacto\": \"\",\n            \"telefonos\": \"\",\n            \"pallet\": 0,\n            \"encajado\": 0,\n            \"ejemplaresPaquete\": 0,\n            \"ejemplares\": 0,\n            \"envioResto\": 0,\n            \"modelos\": 0,\n            \"observaciones\": \"\"\n          }\n        ]\n      }\n\n",
              "type": "string"
            },
            {
              "id": "cc2cb1a8-001c-47c2-905c-932fb95e2f0a",
              "name": "",
              "value": "",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        432,
        -16
      ],
      "id": "72052f08-6ce7-4dd8-ba22-afdbccaad45d",
      "name": "PromptConfig_ANAYA"
    },
    {
      "parameters": {
        "jsCode": "const text = $json.output?.[0]?.content?.[0]?.text ?? \"\";\nconst data = JSON.parse(text);\nreturn [{ json: data }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2096,
        -1520
      ],
      "id": "594c5297-d8d5-42e0-abb1-7db53dadd722",
      "name": "Parse cabecera"
    },
    {
      "parameters": {
        "jsCode": "return ($json.titulos || []).map(t => ({ json: t }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2400,
        -1520
      ],
      "id": "ccf21aab-aef8-409f-a898-e3948fad51bc",
      "name": "Split Out Items"
    },
    {
      "parameters": {
        "jsCode": "const text =\n  $json.output?.[0]?.content?.[0]?.text ??\n  $json.output_text ??\n  \"\";\n\nif (!text) {\n  throw new Error(\"No encuentro output_text / output[0].content[0].text en la respuesta de OpenAI\");\n}\n\nlet data;\ntry {\n  data = JSON.parse(text);\n} catch (e) {\n  throw new Error(\"El texto devuelto por OpenAI no es JSON parseable. Primeros 200 chars: \" + text.slice(0, 200));\n}\n\n// data debe ser { interiores: [...] }\nreturn [{ json: data }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1920,
        -1120
      ],
      "id": "92a16fe1-d2ff-4a49-a282-1e87441c61c2",
      "name": "Parse interiores"
    },
    {
      "parameters": {
        "jsCode": "const parent = $json;\nconst interiores = Array.isArray(parent?.interiores) ? parent.interiores : [];\n\nreturn interiores.map((interior) => {\n  const interiorClean = { ...(interior || {}) };\n\n  // Quitar idElemento dentro del interior (lo dejamos solo en root)\n  if ('idElemento' in interiorClean) delete interiorClean.idElemento;\n\n  return {\n    json: {\n      idElemento: String(interior?.idElemento ?? parent?.idElemento ?? \"\"),\n      interiores: [interiorClean],\n    },\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2128,
        -1120
      ],
      "id": "c3c8b42d-0999-4ff3-a766-ee4e0361f515",
      "name": "Split Out Items1"
    },
    {
      "parameters": {
        "jsCode": "const text =\n  $json.output?.[0]?.content?.[0]?.text ??\n  $json.output_text ??\n  \"\";\n\nif (!text) throw new Error(\"No encuentro el texto de salida en la respuesta de OpenAI\");\n\nlet data;\ntry {\n  data = JSON.parse(text);\n} catch (e) {\n  throw new Error(\"Salida no parseable como JSON. Inicio: \" + text.slice(0, 200));\n}\n\nreturn [{ json: data }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1872,
        -704
      ],
      "id": "e77d6689-4187-42f1-a75c-b0dcb9805a1c",
      "name": "Parse cubierta"
    },
    {
      "parameters": {
        "jsCode": "return ($json.cubiertas || []).map(c => ({\n  json: {\n    idElemento: String(c.idElemento ?? \"\"),\n    cubierta: {\n      materialCubierta: c.materialCubierta ?? 0,\n      propietarioPapel: c.propietarioPapel ?? 0,\n      plastificado: c.plastificado ?? 0,\n      uvi: c.uvi ?? 0,\n      impresion: c.impresion ?? \"4/0\",\n      codDescarga: c.codDescarga ?? 0,\n      tecnologia: c.tecnologia ?? 0,\n      observaciones: c.observaciones ?? \"\"\n    }\n  }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2112,
        -704
      ],
      "id": "74c89b19-b9d8-495a-ab57-fcffe8862a60",
      "name": "Split Out Items2"
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "idElemento",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2352,
        -704
      ],
      "id": "9961cfad-aedf-4974-ab91-e1f886b449f2",
      "name": "Merge5"
    },
    {
      "parameters": {
        "jsCode": "const arr = Array.isArray($json.extras) ? $json.extras : [];\nreturn arr.map(e => ({ json: e }));\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2192,
        -288
      ],
      "id": "153f235e-09c2-4180-8174-ff37658cc7d8",
      "name": "Split Out Items3"
    },
    {
      "parameters": {
        "jsCode": "return $input.all().map(item => {\n  const out = { ...item.json };\n\n  if (out.idElemento !== undefined && out.idElemento !== null) {\n    out.idElemento = String(out.idElemento);\n  }\n\n  return { json: out };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2944,
        -1520
      ],
      "id": "21b97c0a-75e4-45f5-bc65-c8cf4601f0d5",
      "name": "idElemento"
    },
    {
      "parameters": {
        "jsCode": "return $input.all().map(item => {\n  const out = { ...item.json };\n\n  if (out.idElemento !== undefined && out.idElemento !== null) {\n    out.idElemento = String(out.idElemento);\n  }\n\n  return { json: out };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2944,
        -1120
      ],
      "id": "7af5aa57-00fb-4db2-ab34-acf057445de8",
      "name": "idElemento1"
    },
    {
      "parameters": {
        "jsCode": "return $input.all().map(item => {\n  const out = { ...item.json };\n\n  if (out.idElemento !== undefined && out.idElemento !== null) {\n    out.idElemento = String(out.idElemento);\n  }\n\n  return { json: out };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2944,
        -704
      ],
      "id": "0a3777ed-52b2-481d-8ea6-119821bdee26",
      "name": "idElemento2"
    },
    {
      "parameters": {
        "jsCode": "return $input.all().map(item => {\n  const out = { ...item.json };\n\n  if (out.idElemento !== undefined && out.idElemento !== null) {\n    out.idElemento = String(out.idElemento);\n  }\n\n  return { json: out };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2944,
        -288
      ],
      "id": "fdc79839-193f-4f7c-9b5e-a27a84c39ebd",
      "name": "idElemento3"
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "idElemento",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        3232,
        -1328
      ],
      "id": "33de18f9-2122-48f8-85ee-c30fbbc33f70",
      "name": "Merge6"
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "idElemento",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        3232,
        -912
      ],
      "id": "769f82de-bc5d-4b0a-a4d4-0bbf92b914c6",
      "name": "Merge7"
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "idElemento",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        3248,
        -496
      ],
      "id": "8a8d2e73-6f4d-461a-b762-7efc7673fedc",
      "name": "Merge8"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3824,
        -1104
      ],
      "id": "4f1885ef-cdf9-4a1d-ac5f-59bcf3b23842",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        4848,
        -896
      ],
      "id": "3908a244-4a78-4693-ac66-bdd8f9eb6641",
      "name": "Unir pedido + stock"
    },
    {
      "parameters": {
        "jsCode": "const id = String($json.idElemento || 'sin-id');\nconst now = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-'); // 2026-01-01-19-22-00\n\n// Puedes elegir una ruta fija\n// Ejemplo: pruebas/anaya/3115677.json (siempre se sobrescribe)\nconst filePath = `pruebas/anaya/${id}.json`;\n\n// O si quieres hist√≥rico por fecha:\n// const filePath = `pruebas/anaya/${id}/${now}.json`;\n\nconst contentStr = JSON.stringify($json, null, 2);\nconst contentB64 = Buffer.from(contentStr, 'utf8').toString('base64');\n\nreturn [{\n  json: {\n    ...$json,\n    filePath,\n    contentB64,\n    commitMsg: `Test ANAYA ${id} (${now})`,\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5600,
        -1104
      ],
      "id": "4df42c95-88db-4749-bfc3-c22bd22e3d20",
      "name": "const id = String($json.idElemento || 'sin-id'); const now = new Date().toISOString().slice(0,19).re"
    },
    {
      "parameters": {
        "resource": "file",
        "owner": {
          "__rl": true,
          "mode": "list",
          "value": "procesosAut"
        },
        "repository": {
          "__rl": true,
          "value": "n8nANAYA",
          "mode": "list",
          "cachedResultName": "n8nANAYA",
          "cachedResultUrl": "https://github.com/procesosAut/n8nANAYA"
        },
        "filePath": "=pruebas/anaya/{{$json.idElemento}}.json",
        "fileContent": "={{ JSON.stringify($json, null, 2) }}",
        "commitMessage": "={{ \"Test ANAYA \" + $json.idElemento }}",
        "additionalParameters": {
          "branch": {
            "branch": "main"
          }
        }
      },
      "type": "n8n-nodes-base.github",
      "typeVersion": 1.1,
      "position": [
        5856,
        -624
      ],
      "id": "bf55f2b6-9edc-444a-adf1-c5f732f9c447",
      "name": "Create a file",
      "webhookId": "0c21900a-7f12-4c04-b9bb-a49863f167b7",
      "credentials": {
        "githubApi": {
          "id": "LEIE04CpazTBsgn7",
          "name": "GitHub anaya"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const id = String($json.idElemento || 'sin-id');\nconst now = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');\n\n// Ruta en el repo (elige la carpeta que quieras)\nconst filePath = `pruebas/anaya/${id}.json`;\n\n// Contenido del archivo (texto)\nconst fileContent = JSON.stringify($json, null, 2);\n\n// Commit message\nconst commitMessage = `Test ANAYA ${id} (${now})`;\n\nreturn [{\n  json: {\n    ...$json,\n    filePath,\n    fileContent,\n    commitMessage,\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5840,
        -1104
      ],
      "id": "1a348955-11fd-4030-89e9-c61f4592ab57",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "jsCode": "// n8n Code node (Run once for each item)\n// Limpia el JSON eliminando claves con valor 0 o \"\" (y contenedores vac√≠os)\n\nconst KEEP_KEYS = ['idElemento']; // claves que NUNCA se eliminan (aunque fueran 0/\"\", por seguridad)\n\n// Decide si un valor debe eliminarse\nfunction shouldRemovePrimitive(v, key) {\n  if (KEEP_KEYS.includes(key)) return false;\n  return v === 0 || v === \"\";\n}\n\nfunction clean(value, keyForThisValue = \"\") {\n  // Primitivos\n  if (value === null) return value;         // no tocamos null (si quieres lo quitamos tambi√©n)\n  if (value === undefined) return undefined;\n\n  const t = typeof value;\n  if (t !== \"object\") {\n    return shouldRemovePrimitive(value, keyForThisValue) ? undefined : value;\n  }\n\n  // Arrays\n  if (Array.isArray(value)) {\n    const arr = value\n      .map((v) => clean(v, \"\"))            // en arrays no hay key, pasamos \"\"\n      .filter((v) => v !== undefined);     // quitamos elementos eliminados\n\n    return arr.length === 0 ? undefined : arr;\n  }\n\n  // Objetos\n  const out = {};\n  for (const [k, v] of Object.entries(value)) {\n    // Si es primitivo 0 o \"\", lo quitamos\n    if (v === 0 || v === \"\") {\n      if (KEEP_KEYS.includes(k)) out[k] = v; // conservar si est√° en KEEP_KEYS\n      continue;\n    }\n\n    const cv = clean(v, k);\n    if (cv === undefined) {\n      // eliminado (por ser vac√≠o o contener solo valores vac√≠os)\n      // si est√° en KEEP_KEYS, lo mantenemos aunque sea undefined no tendr√≠a sentido, as√≠ que lo omitimos\n      continue;\n    }\n    out[k] = cv;\n  }\n\n  // Si el objeto qued√≥ vac√≠o, lo eliminamos (salvo si es root; eso lo manejamos al final)\n  return Object.keys(out).length === 0 ? undefined : out;\n}\n\nconst cleaned = clean($json, \"\") ?? {}; // root siempre debe ser objeto para n8n\n\nreturn [{ json: cleaned }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5312,
        -1104
      ],
      "id": "5302b4ed-4aac-4f69-880f-85264443ffee",
      "name": "limpieza"
    },
    {
      "parameters": {
        "jsCode": "const out = { ...$json };\n\n// Coge el base64 del nodo inicial (primer item de ese nodo)\nconst archivoBase64 = $items(\"PDF - Base64\")[0]?.json?.archivoBase64;\n\nif (archivoBase64) {\n  // Lo ponemos \"al principio\" del objeto (orden l√≥gico)\n  return [{ json: { archivoBase64, ...out } }];\n}\n\nreturn [{ json: out }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3552,
        -1104
      ],
      "id": "265295f3-e2be-40b5-93c8-bbb28563115d",
      "name": "a√±ade PDF"
    },
    {
      "parameters": {
        "jsCode": "// Soporta \"Full Response\" ON/OFF:\nconst body = $json.body ?? $json;\n\nconst text =\n  body.output?.flatMap(o => o.content || [])\n    ?.find(c => c.type === \"output_text\")\n    ?.text;\n\nif (!text) throw new Error(\"No encuentro output_text en la respuesta de OpenAI\");\n\nlet data;\ntry {\n  data = JSON.parse(text);\n} catch (e) {\n  throw new Error(\"El output_text no es JSON parseable: \" + e.message + \"\\n\\n\" + text);\n}\n\n// Limpieza: borra 0, \"\", null, [], {} EXCEPTO estos campos:\nconst keepAlways = new Set([\n  \"cliente\", \"contacto\", \"sinRetraso\", \"unionPliegos\", \"encuadernacion\", \"solapa\", \"hendidoCortesia\"\n]);\n\nfunction isEmpty(v) {\n  if (v === null || v === undefined) return true;\n  if (typeof v === \"string\" && v.trim() === \"\") return true;\n  if (typeof v === \"number\" && v === 0) return true;\n  if (Array.isArray(v) && v.length === 0) return true;\n  if (typeof v === \"object\" && !Array.isArray(v) && Object.keys(v).length === 0) return true;\n  return false;\n}\n\nfor (const k of Object.keys(data)) {\n  if (keepAlways.has(k)) continue;\n  if (isEmpty(data[k])) delete data[k];\n}\n\nreturn [{ json: data }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2224,
        800
      ],
      "id": "b5925e31-b1ba-4c1b-9aca-9f2f41006bc8",
      "name": "Parse output_text"
    },
    {
      "parameters": {
        "jsCode": "// -----------------------------\n// PARSE + LIMPIEZA (INTERIORES)\n// -----------------------------\n\n// A veces n8n trae el body como string. Lo hacemos robusto:\nlet resp = $json;\nif (typeof resp === \"string\") resp = JSON.parse(resp);\n\n// Soporta \"Full Response\" ON/OFF:\nconst body = resp.body ?? resp;\n\n// En Responses API el texto suele venir en body.output[0..].content[*].text\nconst text =\n  body.output?.flatMap(o => o.content || [])\n    ?.find(c => c.type === \"output_text\")\n    ?.text;\n\nif (!text) throw new Error(\"No encuentro output_text en la respuesta de OpenAI\");\n\nlet parsed;\ntry {\n  parsed = JSON.parse(text);\n} catch (e) {\n  throw new Error(\"El output_text no es JSON parseable: \" + e.message + \"\\n\\n\" + text);\n}\n\n// Esperamos { interiores: [ ... ] } (si el modelo devuelve directo el array, lo aceptamos)\nlet interiores = Array.isArray(parsed?.interiores)\n  ? parsed.interiores\n  : (Array.isArray(parsed) ? parsed : []);\n\n// ---------- LIMPIEZA ----------\n// Borra 0, \"\", null, [], {} excepto estos PATHS (para no romper estructura m√≠nima)\nconst keepAlwaysPaths = new Set([\n  // Mantener siempre el array (aunque quede vac√≠o)\n  \"interiores\",\n\n  // Campos m√≠nimos por interior\n  \"interiores[].papel_id\",\n  \"interiores[].propietarioPapel\",\n  \"interiores[].tipoImpresion\",\n  \"interiores[].paginas\",\n\n  // Mantener siempre el objeto papelPedido y claves √∫tiles\n  \"interiores[].papelPedido\",\n  \"interiores[].papelPedido.gramaje\",\n  \"interiores[].papelPedido.anchoBobinaCm\",\n  \"interiores[].papelPedido.ups\",\n  \"interiores[].papelPedido.kg\",\n]);\n\nfunction isEmpty(v) {\n  if (v === null || v === undefined) return true;\n  if (typeof v === \"string\" && v.trim() === \"\") return true;\n  if (typeof v === \"number\" && v === 0) return true;\n  if (Array.isArray(v) && v.length === 0) return true;\n  if (typeof v === \"object\" && !Array.isArray(v) && Object.keys(v).length === 0) return true;\n  return false;\n}\n\nfunction cleanDeep(value, path) {\n  // Arrays: limpiar elementos y eliminar elementos vac√≠os\n  if (Array.isArray(value)) {\n    const arr = [];\n    for (const el of value) {\n      const cleaned = cleanDeep(el, path + \"[]\");\n      // si el elemento queda vac√≠o, lo descartamos\n      if (!isEmpty(cleaned)) arr.push(cleaned);\n    }\n    return arr;\n  }\n\n  // Objetos: limpiar claves recursivamente\n  if (value && typeof value === \"object\") {\n    const obj = { ...value };\n    for (const k of Object.keys(obj)) {\n      const childPath = path ? `${path}.${k}` : k;\n\n      obj[k] = cleanDeep(obj[k], childPath);\n\n      // Si est√° en keepAlwaysPaths, NO lo borramos aunque est√© vac√≠o\n      if (keepAlwaysPaths.has(childPath)) continue;\n\n      // Si est√° vac√≠o, borramos\n      if (isEmpty(obj[k])) delete obj[k];\n    }\n    return obj;\n  }\n\n  // Primitivos\n  return value;\n}\n\n// Aplicar limpieza a cada interior\ninteriores = cleanDeep(interiores, \"interiores\");\n\n// Asegurar que siempre devolvemos el array\nif (!Array.isArray(interiores)) interiores = [];\n\nreturn [{\n  json: {\n    interiores\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1936,
        1200
      ],
      "id": "5953cf26-e186-43fd-a6fb-b5246aad9b30",
      "name": "Parse output_text1"
    },
    {
      "parameters": {
        "jsCode": "// ---------------------------\n// PARSE + LIMPIEZA (CUBIERTA)\n// ---------------------------\n\n// A veces n8n trae el body como string. Lo hacemos robusto:\nlet resp = $json;\nif (typeof resp === \"string\") resp = JSON.parse(resp);\n\n// Soporta \"Full Response\" ON/OFF:\nconst body = resp.body ?? resp;\n\n// En Responses API el texto suele venir en body.output[0..].content[*].text\nconst text =\n  body.output?.flatMap(o => o.content || [])\n    ?.find(c => c.type === \"output_text\")\n    ?.text;\n\nif (!text) throw new Error(\"No encuentro output_text en la respuesta de OpenAI (cubierta)\");\n\n// Parse JSON\nlet parsed;\ntry {\n  parsed = JSON.parse(text);\n} catch (e) {\n  throw new Error(\n    `El output_text no es JSON v√°lido: ${e.message}. Primeros 200 chars: ${String(text).slice(0, 200)}`\n  );\n}\n\n// Normaliza salida: esperamos { cubierta: {...} }\n// Si devuelve directamente el objeto de cubierta, lo envolvemos\nconst cubiertaRaw =\n  (parsed && typeof parsed === \"object\" && !Array.isArray(parsed) && parsed.cubierta)\n    ? parsed.cubierta\n    : parsed;\n\n// Validaci√≥n m√≠nima\nif (!cubiertaRaw || typeof cubiertaRaw !== \"object\" || Array.isArray(cubiertaRaw)) {\n  throw new Error(\"La salida parseada no contiene un objeto 'cubierta' v√°lido\");\n}\n\n// ---------- LIMPIEZA ----------\n// Borra 0, \"\", null, [], {} EXCEPTO campos que deben existir siempre\nconst keepAlways = new Set([\n  \"materialCubierta\",\n  \"propietarioPapel\",\n  \"plastificado\",\n  \"uvi\",\n  \"impresion\",\n  \"codDescarga\",\n  \"tecnologia\",\n  // Si quieres forzar que observaciones siempre exista, a√±ade \"observaciones\" aqu√≠.\n]);\n\nfunction isEmpty(v) {\n  if (v === null || v === undefined) return true;\n  if (typeof v === \"string\" && v.trim() === \"\") return true;\n  if (typeof v === \"number\" && v === 0) return true;\n  if (Array.isArray(v) && v.length === 0) return true;\n  if (typeof v === \"object\" && !Array.isArray(v) && Object.keys(v).length === 0) return true;\n  return false;\n}\n\n// Limpieza superficial (cubierta suele ser plano)\nconst cubierta = { ...cubiertaRaw };\nfor (const k of Object.keys(cubierta)) {\n  if (keepAlways.has(k)) continue;\n  if (isEmpty(cubierta[k])) delete cubierta[k];\n}\n\n// Asegura que los campos \"siempre\" existen aunque el modelo los omitiera\nfor (const k of keepAlways) {\n  if (!(k in cubierta)) {\n    // defaults por tipo esperado\n    if (k === \"impresion\") cubierta[k] = \"\";\n    else cubierta[k] = 0;\n  }\n}\n\n// Devuelve solo el bloque de cubierta\nreturn [{\n  json: {\n    cubierta\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2112,
        1616
      ],
      "id": "bed43574-e0e7-4005-af94-5008c3a090d6",
      "name": "Parse output_text2"
    },
    {
      "parameters": {
        "jsCode": "function safeItems(name) {\n  try {\n    return $items(name);\n  } catch (e) {\n    return null;\n  }\n}\n\nfunction firstJsonFrom(names) {\n  for (const n of names) {\n    const it = safeItems(n);\n    if (it && it[0] && it[0].json) return it[0].json;\n  }\n  return null;\n}\n\nfunction toNumber(v, def = 0) {\n  if (v === null || v === undefined) return def;\n  if (typeof v === \"number\") return Number.isFinite(v) ? v : def;\n  if (typeof v === \"string\") {\n    const n = Number(v.replace(\",\", \".\").trim());\n    return Number.isFinite(n) ? n : def;\n  }\n  const n = Number(v);\n  return Number.isFinite(n) ? n : def;\n}\n\n// 1) Base64: prueba nombres posibles\nconst base64Json = firstJsonFrom([\n  \"PDF - Base64\",\n  \"PDF - Base644\",\n  \"PDF ‚Üí Base64\",\n  \"PDF a Base64\",\n]);\n\nconst archivoBase64 =\n  base64Json?.archivoBase64 ||\n  base64Json?.pdfBase64 ||\n  base64Json?.archivoBase64_1 ||\n  null;\n\nif (!archivoBase64) {\n  throw new Error(\n    \"No encuentro archivoBase64. Revisa el nodo de Base64 y el nombre del campo (archivoBase64/pdfBase64).\"\n  );\n}\n\n// 2) Cabecera / Interiores / Cubierta / Extras\nconst cabecera =\n  firstJsonFrom([\"Parse output_text\", \"Parse output_text (cabecera)\"]) || {};\n\n// Interiores: preferimos el nodo que YA calcula UPS\nconst interioresObj =\n  firstJsonFrom([\n    \"Calcular UPS (interiores)\",\n    \"Calcular UPS (interiores)1\",\n    \"Parse output_text1\",\n    \"Parse output_text (interiores)\",\n  ]) || {};\n\nconst interiores = Array.isArray(interioresObj.interiores)\n  ? interioresObj.interiores\n  : [];\n\n// Cubierta: preferimos el nodo que YA calcula tecnologia (si existe)\nconst cubiertaObj =\n  firstJsonFrom([\n    \"Calcular tecnologia (cubierta)\",\n    \"Calcular tecnologia (cubierta)1\",\n    \"Parse output_text2\",\n    \"Parse output_text (cubierta)\",\n  ]) || {};\n\nlet cubierta = cubiertaObj.cubierta ?? null;\n\n// Extras\nconst extras =\n  firstJsonFrom([\"Parse output_text3\", \"Parse output_text (extras)\"]) || {};\n\n// 3) L√≥gica tecnologia (si hay cubierta)\nif (cubierta && typeof cubierta === \"object\") {\n  const encuadernacion = toNumber(cabecera.encuadernacion, 0);\n  const uvi = toNumber(cubierta.uvi, 0);\n  const tirada = toNumber(cabecera.tirada, 0);\n  const solapa = !!cabecera.solapa;\n\n  const tecnologiaIA = toNumber(cubierta.tecnologia, 1);\n\n  let tecnologiaFinal = tecnologiaIA;\n\n  // Si IA marca 5 = offset => lo convertimos a 2\n  if (tecnologiaIA === 5) {\n    tecnologiaFinal = 2;\n  } else {\n    const cond =\n      (encuadernacion === 1 && uvi === 1 && tirada > 799) ||\n      (encuadernacion === 1 && uvi === 0 && tirada > 999) ||\n      (encuadernacion === 3 && uvi === 1 && solapa === true && tirada > 799) ||\n      (encuadernacion === 3 && uvi === 0 && solapa === true && tirada > 1499) ||\n      (uvi === 1 && tirada > 799) ||\n      (uvi === 0 && tirada > 1999) ||\n      (tirada > 1999);\n\n    tecnologiaFinal = cond ? 3 : 1;\n  }\n\n  cubierta = { ...cubierta, tecnologia: tecnologiaFinal };\n}\n\n// 4) Payload final\nconst finalPayload = {\n  archivoBase64,\n  ...cabecera,\n  interiores,\n  cubierta,\n  ...extras,\n};\n\nreturn { json: finalPayload };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3168,
        944
      ],
      "id": "89a477ee-21e9-4ba0-bf2c-007955bf5422",
      "name": "Build JSON completo"
    },
    {
      "parameters": {
        "url": "https://liberdigital.gomezaparicio.es/sw/automatizacion/pedidos/digital",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "options": {
          "allowUnauthorizedCerts": true
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3952,
        1328
      ],
      "id": "6a3e1325-f8ad-499e-bc41-c6e32afefd04",
      "name": "API Pedidos",
      "credentials": {
        "httpBasicAuth": {
          "id": "EGTFeBpcDKH8NdqZ",
          "name": "Apis Libernet"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "const input = $json;\n\nconst numeroOtCliente =\n  input.numeroOtCliente ??\n  input.numeroOTcliente ??\n  null;\n\nconst isbnRaw = (input.isbn ?? '').toString();\nconst isbn = isbnRaw.replace(/[^0-9Xx]/g, '').toUpperCase();\n\nreturn [{\n  ...input,\n  numeroOtCliente: numeroOtCliente?.toString().trim(),\n  isbn,\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3520,
        1328
      ],
      "id": "5c56b561-3a6d-4bf8-92da-64a486bb1af3",
      "name": "Normalizar pedido"
    },
    {
      "parameters": {
        "jsCode": "function normStr(v) {\n  return (v ?? '').toString().trim();\n}\nfunction normIsbn(v) {\n  return normStr(v).replace(/[^0-9Xx]/g, '').toUpperCase();\n}\n\nconst pedido = $items(\"Normalizar pedido\")[0]?.json;\nif (!pedido) throw new Error('No encuentro el item del nodo \"Normalizar pedido\". Revisa el nombre del nodo.');\n\nconst otPedido = normStr(pedido.numeroOtCliente); // puede ser \"\"\nconst isbnPedido = normIsbn(pedido.isbn);\n\n// ISBN es obligatorio para la validaci√≥n\nif (!isbnPedido) {\n  return [{\n    allowCreate: false,\n    reason: \"DATOS_INCOMPLETOS\",\n    message: \"Falta ISBN en el pedido, no se puede validar duplicados.\",\n    pedido: { numeroOtCliente: otPedido || null, isbn: null, titulo: pedido.titulo },\n    match: null,\n  }];\n}\n\nconst registros = $input.all().map(i => i.json);\n\n// ===============\n// 1) OTcliente (solo si viene informado)\n// ===============\nif (otPedido) {\n  const matchOt = registros.find(r => normStr(r.numeroOTcliente) === otPedido);\n  if (matchOt) {\n    // Si existe OTcliente => AVISO y STOP. NO se mira ISBN.\n    return [{\n      allowCreate: false,\n      reason: \"OT_DUPLICADA\",\n      pedido: { numeroOtCliente: otPedido, isbn: isbnPedido, titulo: pedido.titulo },\n      match: {\n        numeroPedido: matchOt.numeroPedido,\n        numeroOTcliente: matchOt.numeroOTcliente,\n        titulo: matchOt.titulo,\n        faseInterior1: matchOt.faseInterior1,\n        fechaEntrega: matchOt.fechaEntrega,\n        isbn: matchOt.isbn,\n      },\n    }];\n  }\n}\n\n// ===============\n// 2) ISBN (siempre se comprueba)\n// ===============\nconst estadosFinalizados = new Set([\n  \"10.0. Facturado\",\n  \"99.0. Cancelado\",\n  \"9.0. Mercanc√≠a entregada\",\n]);\n\nconst activosPorIsbn = registros.filter(r => {\n  const risbn = normIsbn(r.isbn);\n  if (risbn !== isbnPedido) return false;\n\n  const fase = normStr(r.faseInterior1);\n  if (!fase) return false;\n\n  return !estadosFinalizados.has(fase);\n});\n\nif (activosPorIsbn.length > 0) {\n  const ej = activosPorIsbn[0];\n  return [{\n    allowCreate: false,\n    reason: \"ISBN_EN_PRODUCCION\",\n    pedido: { numeroOtCliente: otPedido || null, isbn: isbnPedido, titulo: pedido.titulo },\n    match: {\n      numeroPedido: ej.numeroPedido,\n      numeroOTcliente: ej.numeroOTcliente,\n      titulo: ej.titulo,\n      faseInterior1: ej.faseInterior1,\n      fechaEntrega: ej.fechaEntrega,\n      isbn: ej.isbn,\n    },\n    activosCount: activosPorIsbn.length,\n  }];\n}\n\n// OK\nreturn [{\n  allowCreate: true,\n  reason: \"OK\",\n  pedido: { numeroOtCliente: otPedido || null, isbn: isbnPedido, titulo: pedido.titulo },\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4304,
        1328
      ],
      "id": "4afd0b72-ae19-43d0-bae4-be9ef176114b",
      "name": "Validar duplicados",
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "8dbabbf5-f37b-475a-b6df-aea5e1d70401",
              "leftValue": "={{$json.allowCreate}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        4608,
        1328
      ],
      "id": "7154726e-fdb9-400a-b019-c9b2aaeee361",
      "name": "If",
      "disabled": true
    },
    {
      "parameters": {
        "content": "## DUPLICIDAD\n**Comprueba si el PEDIDO existe o el ISBN\n** Desconecta los tres m√≥dulos para que no compruebe si esta en producci√≥n",
        "height": 368,
        "width": 1152
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        3792,
        1184
      ],
      "id": "c9fd60d4-f4bb-41a1-8f05-3c9155542093",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.reason}}",
                    "rightValue": "OT_DUPLICADA",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "98b4a8f0-04dd-4ecc-9b9e-8b88b9a95904"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "386d49ea-5349-42ea-9685-17312f4ca29a",
                    "leftValue": "={{$json.reason}}",
                    "rightValue": "ISBN_EN_PRODUCCION",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "fbc0c780-bcde-4640-9e57-00ca9d6c0282",
                    "leftValue": "={{$json.reason}}",
                    "rightValue": "DATOS_INCOMPLETOS",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        5744,
        2240
      ],
      "id": "e56d989e-6514-4d2e-bf75-aaa818f75cbf",
      "name": "Switch"
    },
    {
      "parameters": {
        "content": "## Condici√≥n\nsi viene id (su papel) o no viene (nuestro papel)",
        "height": 368,
        "width": 336,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        5680,
        1120
      ],
      "id": "f029a9fe-ce16-44cd-8b75-2502dbac3942",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        5264,
        960
      ],
      "id": "216b86dd-9181-4580-b6e4-31db83faf7db",
      "name": "Merge1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://liberdigital-des.gomezaparicio.es/desarrollo/sw/automatizacion/pedidos/digital/nuevo/",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4448,
        2224
      ],
      "id": "1106cfda-3af3-4fc8-a376-ff2bcd7099c6",
      "name": "Desarrollo",
      "credentials": {
        "httpBasicAuth": {
          "id": "EGTFeBpcDKH8NdqZ",
          "name": "Apis Libernet"
        }
      }
    },
    {
      "parameters": {
        "content": "## Selecciona bobina en stock\n",
        "height": 336,
        "width": 448
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        3504,
        2112
      ],
      "id": "c024551c-7e4b-4b3b-8bc1-aeabd619e61d",
      "name": "Sticky Note9"
    },
    {
      "parameters": {
        "content": "## LIBERNET",
        "height": 560,
        "width": 368,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        4320,
        2112
      ],
      "id": "7756a985-441f-46ec-859f-0dc7f434e1d6",
      "name": "Sticky Note10"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://liberdigital.gomezaparicio.es/sw/automatizacion/pedidos/digital/nuevo/",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4448,
        2464
      ],
      "id": "7aa2b3f2-3ef3-4b47-97c0-bfa172d60461",
      "name": "Producci√≥n",
      "credentials": {
        "httpBasicAuth": {
          "id": "EGTFeBpcDKH8NdqZ",
          "name": "Apis Libernet"
        }
      }
    },
    {
      "parameters": {
        "content": "## LIBERNET",
        "height": 560,
        "width": 368,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        6752,
        960
      ],
      "id": "c1aeb8bc-5a3b-435e-99d6-a206134ec1fa",
      "name": "Sticky Note11"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://liberdigital.gomezaparicio.es/sw/automatizacion/pedidos/digital/nuevo/",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        6880,
        1312
      ],
      "id": "177414ae-e624-4c44-be1a-d62f0b8616e1",
      "name": "Producci√≥n1",
      "credentials": {
        "httpBasicAuth": {
          "id": "EGTFeBpcDKH8NdqZ",
          "name": "Apis Libernet"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c50ac2fc-7702-478c-bb8a-fe568b6229b8",
              "name": "asunto",
              "value": "ERROR POR DUPLICACI√ìN: Este n√∫mero de pedido ya esta en producci√≥n",
              "type": "string"
            },
            {
              "id": "a7625554-7c62-408b-965c-183c852a901d",
              "name": "texto",
              "value": "=El pedido n√∫mero: {{ $json.pedido.numeroOtCliente }} est√° en producci√≥n, en el estado \"{{ $json.match.faseInterior1 }}\". Por favor, compruebalo.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6080,
        2064
      ],
      "id": "3b689f94-f010-4761-8e77-b04bd5178928",
      "name": "OT_DUPLICADA"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://default90419c2b07624d6fb6a1aca6fc3084.80.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/b8ed51b3f3514e6f8835627e068fe901/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=8nyoBAiRe-vHc4jKd_eLpw_R5BPIg-GxP32JL1lYr4s",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "asunto",
              "value": "={{$json.asunto}}"
            },
            {
              "name": "texto",
              "value": "={{$json.texto}}"
            },
            {
              "name": "json",
              "value": "={{$json.json}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        7984,
        2752
      ],
      "id": "cbac6834-0954-4f0a-86e0-f34ca84d49d9",
      "name": "email AUTOMATE"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c50ac2fc-7702-478c-bb8a-fe568b6229b8",
              "name": "asunto",
              "value": "ERROR POR DUPLICACI√ìN: Este n√∫mero de ISBN ya esta en producci√≥n",
              "type": "string"
            },
            {
              "id": "a7625554-7c62-408b-965c-183c852a901d",
              "name": "texto",
              "value": "=El ISBN n√∫mero: {{ $json.pedido.isbn }} est√° en producci√≥n, en el estado \"{{ $json.match.faseInterior1 }}\".  Por favor, compruebalo.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6080,
        2256
      ],
      "id": "6b618530-4b02-457d-8fe5-c3f4e5ac3112",
      "name": "ISBN_EN_PRODUCCION"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c50ac2fc-7702-478c-bb8a-fe568b6229b8",
              "name": "asunto",
              "value": "ERROR POR DATOS INCOMPLETOS",
              "type": "string"
            },
            {
              "id": "a7625554-7c62-408b-965c-183c852a901d",
              "name": "texto",
              "value": "=Al pedido le faltan datos.  Por favor, compruebalo.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6080,
        2464
      ],
      "id": "cb2bb70e-6966-49ec-b777-a42916ffa939",
      "name": "DATOS_INCOMPLETOS"
    },
    {
      "parameters": {
        "content": "## NOTIFICACIONES POR DUPLICACI√ìN \n**Envio de correos por duplicaci√≥n de pedido o isbn",
        "height": 704,
        "width": 624
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        5664,
        1968
      ],
      "id": "53af4175-edf2-4e97-8695-0321e18f7da0",
      "name": "Sticky Note14"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c50ac2fc-7702-478c-bb8a-fe568b6229b8",
              "name": "asunto",
              "value": "=Informe del registro del pedido {{ $json.numeroOtCliente }}, Ot {{ $json.numeroPedido }}",
              "type": "string"
            },
            {
              "id": "a7625554-7c62-408b-965c-183c852a901d",
              "name": "texto",
              "value": "=El resultado es {{ $json.resultado }}",
              "type": "string"
            },
            {
              "id": "3352ce0f-a77e-4162-8e27-c2f69a4c14dd",
              "name": "json",
              "value": "={{ JSON.stringify($json.json_para_email, null, 2) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5312,
        2736
      ],
      "id": "1260df2e-379e-40cc-a931-71e8e8428500",
      "name": "INFORME DE REGISTRO 2"
    },
    {
      "parameters": {
        "content": "## Texto Informe\nCuando el papel es suyo",
        "height": 304,
        "width": 256
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        7568,
        896
      ],
      "id": "5da1fb90-7fd3-4bb4-814b-4be2529029bd",
      "name": "Sticky Note13"
    },
    {
      "parameters": {
        "content": "## Texto Informe\nCuando el papel es nuestro",
        "height": 304,
        "width": 288
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        5216,
        2624
      ],
      "id": "013e40f7-6dbf-452c-a759-c66ef9dfe805",
      "name": "Sticky Note15"
    },
    {
      "parameters": {
        "jsCode": "return items.map(item => {\n  const { archivoBase64, ...resto } = item.json;\n\n  return {\n    json: {\n      ...resto,                 // <- ya NO incluye archivoBase64\n      json_para_email: resto     // <- copia limpia para el email\n    }\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4096,
        2752
      ],
      "id": "a281d5a3-0c74-45df-9c3c-5abc913f3240",
      "name": "json para email"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        4880,
        2736
      ],
      "id": "d7ee5556-c188-4112-b287-20e02f3d8afa",
      "name": "Merge3"
    },
    {
      "parameters": {
        "jsCode": "return items.map(item => {\n  const { archivoBase64, ...resto } = item.json;\n\n  return {\n    json: {\n      ...resto,                 // <- ya NO incluye archivoBase64\n      json_para_email: resto     // <- copia limpia para el email\n    }\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6880,
        736
      ],
      "id": "c53c1298-98b4-4e23-b57f-e117a3ea00f5",
      "name": "json para email1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c50ac2fc-7702-478c-bb8a-fe568b6229b8",
              "name": "asunto",
              "value": "=Informe del registro del pedido {{ $json.numeroOtCliente }}, Ot {{ $json.numeroPedido }}",
              "type": "string"
            },
            {
              "id": "a7625554-7c62-408b-965c-183c852a901d",
              "name": "texto",
              "value": "=El resultado es {{ $json.resultado }}",
              "type": "string"
            },
            {
              "id": "3352ce0f-a77e-4162-8e27-c2f69a4c14dd",
              "name": "json",
              "value": "={{ JSON.stringify($json.json_para_email, null, 2) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7648,
        1008
      ],
      "id": "5898b20d-7038-4ef6-83fe-20d241a7420d",
      "name": "INFORME DE REGISTRO "
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        7328,
        1008
      ],
      "id": "18add2f4-946e-4407-aff8-1ef5b415dbe4",
      "name": "Merge4"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/responses",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpBearerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json.openaiBody}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1808,
        800
      ],
      "id": "0c5c516e-02e1-4547-8710-a6c3e31fb1f3",
      "name": "OpenAI4",
      "alwaysOutputData": false,
      "executeOnce": false,
      "retryOnFail": false,
      "credentials": {
        "httpBearerAuth": {
          "id": "Fb5EZ7r56FOl5M3A",
          "name": "Http Open AI"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const fileId = $items(\"Subir PDF a OpenAI\")[0].json.id;  // ‚úÖ file-...\nconst prompt = ($json.promptCabecera || \"\").trim();\n\nif (!fileId?.startsWith(\"file-\")) {\n  throw new Error(`fileId inv√°lido (esperaba file-...): ${fileId}`);\n}\n\nconst schema = {\n  type: \"object\",\n  additionalProperties: false,\n  properties: {\n    // Identificaci√≥n / cabecera\n    cliente: { type: [\"string\", \"integer\"] },\n    contacto: { type: [\"string\", \"integer\"] },\n    suReferencia: { type: \"string\" },\n\n    // En algunos PDFs viene como \"002/006\", as√≠ que lo dejamos flexible\n    numeroOf: { type: [\"string\", \"integer\"] },\n\n    numeroOtCliente: { type: \"string\" },\n    isbnPack: { type: \"string\" },\n\n    // Fechas\n    fechaAlta: { type: \"string\" },\n    fechaEntrega: { type: \"string\" },\n\n    // Pedido\n    sinRetraso: { type: \"boolean\" },\n    tirada: { type: \"integer\" },\n    precioUnitarioSinIVA: { type: \"number\" },\n    precioToltalSinIVA: { type: \"number\" },\n    quiereVerFerros: { type: \"integer\" },\n    certificacion: { type: \"integer\" },\n    observacionesPedido: { type: \"string\" },\n\n    // Libro / proyecto\n    titulo: { type: \"string\" },\n    sello: { type: \"string\" },\n    isbn: { type: \"string\" },\n    codProyecto: { type: \"string\" },\n\n    // Formato\n    anchoPaginaCm: { type: \"number\" },\n    altoPaginaCm: { type: \"number\" },\n\n    // Encuadernaci√≥n (base)\n    unionPliegos: { type: \"integer\" },\n    encuadernacion: { type: \"integer\" },\n\n    // En tu plantilla son 0/1, pero a veces el modelo devuelve true/false ‚Üí permitimos ambos\n    solapa: { type: [\"integer\", \"boolean\"] },\n    hendidoCortesia: { type: [\"integer\", \"boolean\"] },\n\n    observacionesEncuadernacion: { type: \"string\" },\n\n    // Encuadernaci√≥n (extras)\n    cabezada: { type: \"integer\" },\n    cabezadaColorOtro: { type: \"string\" },\n\n    guardasAparte: { type: \"integer\" },\n    guardasImpresas: { type: \"integer\" },\n\n    cintaRegistro: { type: \"integer\" },\n    cintaRegistroColorOtro: { type: \"string\" },\n\n    calibreCarton: { type: \"integer\" },\n    tipoLomo: { type: \"integer\" },\n\n    // Espiral\n    espiralMaterial: { type: \"integer\" },\n    espiralColor: { type: \"integer\" },\n    espiralColorOtro: { type: \"string\" },\n    espiralLado: { type: \"integer\" },\n\n    // Wire-o\n    wireoMaterial: { type: \"integer\" },\n    wireoColor: { type: \"integer\" },\n    wireoColorOtro: { type: \"string\" },\n    wireoLado: { type: \"integer\" }\n  },\n  required: [] // nada requerido\n};\n\nreturn {\n  openaiBody: {\n    model: \"gpt-5.2\",\n    input: [{\n      role: \"user\",\n      content: [\n        { type: \"input_file\", file_id: fileId },\n        { type: \"input_text\", text: prompt }\n      ]\n    }],\n    text: {\n      format: {\n        type: \"json_schema\",\n        name: \"cabecera_pedido\",\n        strict: false,\n        schema\n      }\n    }\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1408,
        800
      ],
      "id": "05dc0555-ef15-4bc3-ba93-c1192930c5f1",
      "name": "Build OpenAI Body (schema)4"
    },
    {
      "parameters": {
        "content": "## Cabecera",
        "height": 304,
        "width": 1344,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1312,
        704
      ],
      "id": "2ce4cfbb-7b03-4c95-88a9-28a29100f6ff",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/responses",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpBearerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json.openaiBody}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1680,
        1200
      ],
      "id": "1d2dfaea-a7bf-4990-b7f2-b264355dc539",
      "name": "OpenAI5",
      "alwaysOutputData": false,
      "executeOnce": false,
      "retryOnFail": false,
      "credentials": {
        "httpBearerAuth": {
          "id": "Fb5EZ7r56FOl5M3A",
          "name": "Http Open AI"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const fileId = $items(\"Subir PDF a OpenAI\")[0].json.id; // ‚úÖ file-...\nconst prompt = ($json.promptInteriores || \"\").trim();\n\nif (!fileId?.startsWith(\"file-\")) {\n  throw new Error(`fileId inv√°lido (esperaba file-...): ${fileId}`);\n}\n\n// --- Schema INTERIORES ---\nconst papelPedidoProps = {\n  refPedido: { type: \"string\" },\n  gramaje: { type: \"integer\" },\n  anchoBobinaCm: { type: \"number\" },\n  upsCalc: { type: \"integer\" },\n  ups: { type: \"integer\" },\n  metros: { type: \"number\" },\n  kg: { type: \"number\" },\n};\n\nconst interiorProps = {\n  papel_id: { type: \"integer\" },\n  propietarioPapel: { type: \"integer\" },\n  tipoImpresion: { type: \"integer\" },\n  calidad: { type: \"string\" },\n  paginas: { type: \"integer\" },\n  plegadoOCortado: { type: \"integer\" },\n  maquina: { type: \"integer\" },\n  observaciones: { type: \"string\" },\n  papelPedido: {\n    type: \"object\",\n    additionalProperties: false,\n    properties: papelPedidoProps,\n    required: Object.keys(papelPedidoProps),\n  },\n};\n\nconst schema = {\n  type: \"object\",\n  additionalProperties: false,\n  properties: {\n    interiores: {\n      type: \"array\",\n      items: {\n        type: \"object\",\n        additionalProperties: false,\n        properties: interiorProps,\n        required: Object.keys(interiorProps),\n      },\n    },\n  },\n  required: [\"interiores\"],\n};\n\nreturn {\n  openaiBody: {\n    model: \"gpt-5.2\",\n    input: [\n      {\n        role: \"user\",\n        content: [\n          { type: \"input_file\", file_id: fileId },\n          { type: \"input_text\", text: prompt },\n        ],\n      },\n    ],\n    text: {\n      format: {\n        type: \"json_schema\",\n        name: \"interiores_pedido\",\n        strict: false,\n        schema,\n      },\n    },\n  },\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1408,
        1200
      ],
      "id": "1e138879-9335-40d1-87ac-18ccb9d12247",
      "name": "Build OpenAI Body (schema)5"
    },
    {
      "parameters": {
        "content": "## Interiores",
        "height": 288,
        "width": 1344,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1312,
        1120
      ],
      "id": "17980c77-ce13-4397-8b30-6e8b1eb68f8c",
      "name": "Sticky Note17"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/responses",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpBearerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json.openaiBody}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1776,
        1616
      ],
      "id": "06c25031-e3e6-4f02-9beb-0ad99a43b0db",
      "name": "OpenAI6",
      "alwaysOutputData": false,
      "executeOnce": false,
      "retryOnFail": false,
      "credentials": {
        "httpBearerAuth": {
          "id": "Fb5EZ7r56FOl5M3A",
          "name": "Http Open AI"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const fileId = $items(\"Subir PDF a OpenAI\")[0].json.id; // ‚úÖ file-...\nconst prompt = ($json.promptCubierta || \"\").trim();\n\nif (!fileId?.startsWith(\"file-\")) {\n  throw new Error(`fileId inv√°lido (esperaba file-...): ${fileId}`);\n}\n\n// --- Schema CUBIERTA ---\nconst cubiertaProps = {\n  materialCubierta: { type: \"integer\" },\n  propietarioPapel: { type: \"integer\" },\n  plastificado: { type: \"integer\" },\n  uvi: { type: \"integer\" },\n  impresion: { type: \"string\" },      // ‚úÖ en tu prompt es tipo \"4/0\", \"4/4\"...\n  codDescarga: { type: \"integer\" },   // si luego quieres omitirlo cuando 0, lo haces al final\n  tecnologia: { type: \"integer\" },\n  observaciones: { type: \"string\" },  // si luego quieres omitirlo cuando \"\", lo haces al final\n};\n\nconst schema = {\n  type: \"object\",\n  additionalProperties: false,\n  properties: {\n    cubierta: {\n      type: \"object\",\n      additionalProperties: false,\n      properties: cubiertaProps,\n      // para evitar errores del validador de schema y para asegurar estructura estable:\n      required: Object.keys(cubiertaProps),\n    },\n  },\n  required: [\"cubierta\"],\n};\n\nreturn {\n  openaiBody: {\n    model: \"gpt-5.2\",\n    input: [{\n      role: \"user\",\n      content: [\n        { type: \"input_file\", file_id: fileId },\n        { type: \"input_text\", text: prompt },\n      ],\n    }],\n    text: {\n      format: {\n        type: \"json_schema\",\n        name: \"cubierta_pedido\",\n        strict: false,\n        schema,\n      },\n    },\n  },\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1408,
        1616
      ],
      "id": "c97124b0-e253-412f-8da9-5c292bc52bdb",
      "name": "Build OpenAI Body (schema)6"
    },
    {
      "parameters": {
        "content": "## Cubierta",
        "height": 304,
        "width": 1360,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1312,
        1520
      ],
      "id": "f3193804-f85d-4f9a-9e1b-7172339c562c",
      "name": "Sticky Note18"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/responses",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpBearerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json.openaiBody}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1936,
        2032
      ],
      "id": "9b5edf55-defc-451a-86a0-7aba50d21e66",
      "name": "OpenAI7",
      "alwaysOutputData": false,
      "executeOnce": false,
      "retryOnFail": false,
      "credentials": {
        "httpBearerAuth": {
          "id": "Fb5EZ7r56FOl5M3A",
          "name": "Http Open AI"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const fileId = $items(\"Subir PDF a OpenAI\")[0].json.id; // ‚úÖ file-...\nconst prompt = ($json.promptExtras || \"\").trim();\n\nif (!fileId?.startsWith(\"file-\")) {\n  throw new Error(`fileId inv√°lido (esperaba file-...): ${fileId}`);\n}\n\n// ---------- Subschemas ----------\n\n// papelPedido / papelProduccion (id√©nticos salvo nombre de ref)\nconst papelPedidoProps = {\n  refPedido: { type: \"string\" },\n  gramaje: { type: \"integer\" },\n  anchoBobinaCm: { type: \"number\" },\n  upsCalc: { type: \"integer\" },\n  ups: { type: \"integer\" },\n  metros: { type: \"number\" },\n  kg: { type: \"number\" },\n};\n\nconst papelProduccionProps = {\n  refProduccion: { type: \"string\" },\n  gramaje: { type: \"integer\" },\n  anchoBobinaCm: { type: \"number\" },\n  upsCalc: { type: \"integer\" },\n  ups: { type: \"integer\" },\n  metros: { type: \"number\" },\n  kg: { type: \"number\" },\n};\n\nconst guardasProps = {\n  papel_id: { type: \"integer\" },\n  propietarioPapel: { type: \"integer\" },\n  tipoImpresion: { type: \"integer\" },\n  calidad: { type: \"string\" },          // en tu prompt es texto (\"Ahuesado\", etc.)\n  paginas: { type: \"integer\" },\n  plegadoOCortado: { type: \"integer\" },\n  maquina: { type: \"integer\" },\n  observaciones: { type: \"string\" },\n  papelPedido: {\n    type: \"object\",\n    additionalProperties: false,\n    properties: papelPedidoProps,\n    required: Object.keys(papelPedidoProps),\n  },\n  papelProduccion: {\n    type: \"object\",\n    additionalProperties: false,\n    properties: papelProduccionProps,\n    required: Object.keys(papelProduccionProps),\n  },\n};\n\nconst sobrecubiertaProps = {\n  materialSobrecubierta: { type: \"integer\" },\n  propietarioPapel: { type: \"integer\" },\n  plastificado: { type: \"integer\" },\n  uvi: { type: \"integer\" },\n  impresion: { type: \"string\" },    // \"4/0\", \"4/4\", etc.\n  tecnologia: { type: \"integer\" },\n  observaciones: { type: \"string\" },\n};\n\nconst fajaProps = {\n  materialFaja: { type: \"integer\" },\n  propietarioPapel: { type: \"integer\" },\n  plastificado: { type: \"integer\" },\n  uvi: { type: \"integer\" },\n  impresion: { type: \"string\" },    // \"4/0\", \"4/4\", etc.\n  tecnologia: { type: \"integer\" },\n  observaciones: { type: \"string\" },\n};\n\nconst componenteEspecialProps = {\n  material: { type: \"integer\" },\n  propietarioPapel: { type: \"integer\" },\n  nombre: { type: \"string\" },\n  plastificado: { type: \"integer\" },\n  uvi: { type: \"boolean\" },         // en tu modelo inicial era boolean\n  impresion: { type: \"string\" },    // mejor string (\"4/0\"...)\n  tecnologia: { type: \"integer\" },\n  observaciones: { type: \"string\" },\n};\n\nconst peticionEspecialProps = {\n  descripcion: { type: \"string\" },\n};\n\nconst direccionProps = {\n  direccionId: { type: \"string\" },  // a veces viene como n√∫mero; si prefieres integer lo cambio\n  destinatario: { type: \"string\" },\n  via: { type: \"string\" },\n  numero: { type: \"string\" },\n  piso: { type: \"string\" },\n  puerta: { type: \"string\" },\n  cp: { type: \"string\" },\n  localidad: { type: \"string\" },\n  provincia: { type: \"string\" },\n  pais: { type: \"string\" },\n  contacto: { type: \"string\" },\n  telefonos: { type: \"string\" },\n  pallet: { type: \"integer\" },\n  encajado: { type: \"integer\" },\n  ejemplaresPaquete: { type: \"integer\" },\n  ejemplares: { type: \"integer\" },\n  envioResto: { type: \"integer\" },\n  modelos: { type: \"integer\" },\n  observaciones: { type: \"string\" },\n};\n\n// ---------- Main schema ----------\nconst schema = {\n  type: \"object\",\n  additionalProperties: false,\n  properties: {\n    guardas: {\n      type: \"object\",\n      additionalProperties: false,\n      properties: guardasProps,\n      required: Object.keys(guardasProps),\n    },\n    sobrecubierta: {\n      type: \"object\",\n      additionalProperties: false,\n      properties: sobrecubiertaProps,\n      required: Object.keys(sobrecubiertaProps),\n    },\n    faja: {\n      type: \"object\",\n      additionalProperties: false,\n      properties: fajaProps,\n      required: Object.keys(fajaProps),\n    },\n    componentesEspeciales: {\n      type: \"array\",\n      items: {\n        type: \"object\",\n        additionalProperties: false,\n        properties: componenteEspecialProps,\n        required: Object.keys(componenteEspecialProps),\n      },\n    },\n    peticionesEspeciales: {\n      type: \"array\",\n      items: {\n        type: \"object\",\n        additionalProperties: false,\n        properties: peticionEspecialProps,\n        required: Object.keys(peticionEspecialProps),\n      },\n    },\n    direcciones: {\n      type: \"array\",\n      items: {\n        type: \"object\",\n        additionalProperties: false,\n        properties: direccionProps,\n        required: Object.keys(direccionProps),\n      },\n    },\n  },\n  required: [\"guardas\", \"sobrecubierta\", \"faja\", \"componentesEspeciales\", \"peticionesEspeciales\", \"direcciones\"],\n};\n\nreturn {\n  openaiBody: {\n    model: \"gpt-5.2\",\n    input: [{\n      role: \"user\",\n      content: [\n        { type: \"input_file\", file_id: fileId },\n        { type: \"input_text\", text: prompt },\n      ],\n    }],\n    text: {\n      format: {\n        type: \"json_schema\",\n        name: \"extras_pedido\",\n        strict: false,\n        schema,\n      },\n    },\n  },\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1408,
        2032
      ],
      "id": "ee7eda0b-1a0c-400f-8776-2a93122d40e2",
      "name": "Build OpenAI Body (schema)7"
    },
    {
      "parameters": {
        "jsCode": "// ------------------------\n// PARSE + LIMPIEZA (EXTRAS)\n// ------------------------\n\n// A veces n8n trae el body como string. Lo hacemos robusto:\nlet resp = $json;\nif (typeof resp === \"string\") resp = JSON.parse(resp);\n\n// Soporta \"Full Response\" ON/OFF:\nconst body = resp.body ?? resp;\n\n// En Responses API el texto suele venir en body.output[0..].content[*].text\nconst text =\n  body.output?.flatMap(o => o.content || [])\n    ?.find(c => c.type === \"output_text\")\n    ?.text;\n\nif (!text) {\n  throw new Error(\"No encuentro output_text en la respuesta de OpenAI (extras)\");\n}\n\n// Parse JSON\nlet parsed;\ntry {\n  parsed = JSON.parse(text);\n} catch (e) {\n  throw new Error(\n    `El output_text no es JSON v√°lido: ${e.message}. Primeros 200 chars: ${String(text).slice(0, 200)}`\n  );\n}\n\nif (!parsed || typeof parsed !== \"object\" || Array.isArray(parsed)) {\n  throw new Error(\"La salida parseada de extras no es un objeto JSON v√°lido\");\n}\n\n// -----------------\n// Normalizaci√≥n base\n// -----------------\nconst norm = {\n  guardas: parsed.guardas ?? null,\n  sobrecubierta: parsed.sobrecubierta ?? null,\n  faja: parsed.faja ?? null,\n  componentesEspeciales: Array.isArray(parsed.componentesEspeciales) ? parsed.componentesEspeciales : [],\n  peticionesEspeciales: Array.isArray(parsed.peticionesEspeciales) ? parsed.peticionesEspeciales : [],\n  direcciones: Array.isArray(parsed.direcciones) ? parsed.direcciones : [],\n};\n\n// -----------\n// Limpieza\n// -----------\n// Borra 0, \"\", null, [], {} EXCEPTO algunos campos cr√≠ticos (por path)\nconst keepAlwaysPaths = new Set([\n  // Arrays ra√≠z: queremos que existan aunque est√©n vac√≠os\n  \"componentesEspeciales\",\n  \"peticionesEspeciales\",\n  \"direcciones\",\n\n  // Direcciones: mantener siempre si existen (si vienen vac√≠os, se limpiar√°n igual)\n  \"direcciones[].direccionId\",\n  \"direcciones[].ejemplares\",\n]);\n\nfunction isEmpty(v) {\n  if (v === null || v === undefined) return true;\n  if (typeof v === \"string\" && v.trim() === \"\") return true;\n  if (typeof v === \"number\" && v === 0) return true;\n  if (Array.isArray(v) && v.length === 0) return true;\n  if (typeof v === \"object\" && !Array.isArray(v) && Object.keys(v).length === 0) return true;\n  return false;\n}\n\nfunction cleanDeep(value, path) {\n  if (Array.isArray(value)) {\n    const arr = [];\n    for (const el of value) {\n      const cleaned = cleanDeep(el, path + \"[]\");\n      if (!isEmpty(cleaned)) arr.push(cleaned);\n    }\n    return arr;\n  }\n\n  if (value && typeof value === \"object\") {\n    const obj = { ...value };\n    for (const k of Object.keys(obj)) {\n      const childPath = path ? `${path}.${k}` : k;\n      obj[k] = cleanDeep(obj[k], childPath);\n\n      if (keepAlwaysPaths.has(childPath)) continue;\n      if (isEmpty(obj[k])) delete obj[k];\n    }\n    return obj;\n  }\n\n  return value;\n}\n\n// Limpia cada bloque\nconst cleaned = cleanDeep(norm, \"\");\n\n// Post-reglas:\n// - Si guardas/sobrecubierta/faja quedan vac√≠os => null\nfunction nullIfEmptyObject(v) {\n  if (!v || typeof v !== \"object\" || Array.isArray(v)) return v;\n  return Object.keys(v).length === 0 ? null : v;\n}\n\nconst out = {\n  guardas: nullIfEmptyObject(cleaned.guardas),\n  sobrecubierta: nullIfEmptyObject(cleaned.sobrecubierta),\n  faja: nullIfEmptyObject(cleaned.faja),\n  componentesEspeciales: Array.isArray(cleaned.componentesEspeciales) ? cleaned.componentesEspeciales : [],\n  peticionesEspeciales: Array.isArray(cleaned.peticionesEspeciales) ? cleaned.peticionesEspeciales : [],\n  direcciones: Array.isArray(cleaned.direcciones) ? cleaned.direcciones : [],\n};\n\n// Asegura que las arrays ra√≠z existen siempre\nif (!Array.isArray(out.componentesEspeciales)) out.componentesEspeciales = [];\nif (!Array.isArray(out.peticionesEspeciales)) out.peticionesEspeciales = [];\nif (!Array.isArray(out.direcciones)) out.direcciones = [];\n\nreturn [{ json: out }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2464,
        2032
      ],
      "id": "72e5d322-8e60-4861-bd98-b30cb1e69808",
      "name": "Parse output_text4"
    },
    {
      "parameters": {
        "content": "## Extras",
        "height": 320,
        "width": 1376,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1312,
        1936
      ],
      "id": "6ff5c09e-68be-48a7-a940-b802610516da",
      "name": "Sticky Note19"
    },
    {
      "parameters": {
        "jsCode": "function toNumber(v) {\n  if (v === null || v === undefined) return NaN;\n  if (typeof v === 'number') return v;\n  if (typeof v === 'string') return Number(v.replace(',', '.').trim());\n  return Number(v);\n}\n\nfunction toBool(v) {\n  if (typeof v === 'boolean') return v;\n  if (typeof v === 'number') return v === 1;\n  if (typeof v === 'string') {\n    const s = v.trim().toLowerCase();\n    if (s === 'true' || s === '1' || s === 's√≠' || s === 'si') return true;\n    if (s === 'false' || s === '0' || s === 'no') return false;\n  }\n  return Boolean(v);\n}\n\n// Cabecera (ajusta el nombre si tu nodo se llama distinto)\nconst cabecera = $items(\"Parse output_text\", 0, 0)[0]?.json ?? {};\n\nif (!$json.cubierta || typeof $json.cubierta !== 'object') {\n  throw new Error(\"No encuentro $json.cubierta en la salida de Parse output_text2\");\n}\n\nconst encuadernacion = toNumber(cabecera.encuadernacion);\nconst tirada = toNumber(cabecera.tirada);\nconst solapa = toBool(cabecera.solapa);\n\nconst uvi = toNumber($json.cubierta.uvi);\nconst tecnologiaIn = toNumber($json.cubierta.tecnologia);\n\nif (!Number.isFinite(encuadernacion)) throw new Error(\"Cabecera: encuadernacion falta o no es num√©rico\");\nif (!Number.isFinite(tirada)) throw new Error(\"Cabecera: tirada falta o no es num√©rico\");\nif (!Number.isFinite(uvi)) throw new Error(\"Cubierta: uvi falta o no es num√©rico\");\nif (!Number.isFinite(tecnologiaIn)) throw new Error(\"Cubierta: tecnologia falta o no es num√©rico\");\n\n// 1) Regla especial: si IA detecta offset => 5, lo cambiamos a 2\nlet tecnologia = tecnologiaIn;\n\nif (tecnologiaIn === 5) {\n  tecnologia = 2;\n} else {\n  // 2) Resto de la l√≥gica\n  const c1 = (encuadernacion === 1 && uvi === 1 && tirada > 799);\n  const c2 = (encuadernacion === 1 && uvi === 0 && tirada > 999);\n  const c3 = (encuadernacion === 3 && uvi === 1 && solapa === true && tirada > 799);\n  const c4 = (encuadernacion === 3 && uvi === 0 && solapa === true && tirada > 1499);\n  const c5 = (uvi === 1 && tirada > 799);\n  const c6 = (uvi === 0 && tirada > 1999);\n  const c7 = (tirada > 1999);\n\n  const any = (c1 || c2 || c3 || c4 || c5 || c6 || c7);\n\n  tecnologia = any ? 3 : 1;\n}\n\n// Solo tocamos cubierta.tecnologia\n$json.cubierta = { ...$json.cubierta, tecnologia };\n\nreturn [{ json: $json }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2448,
        1616
      ],
      "id": "dc40d2d8-afc0-4f0e-ade3-b5bd8237514b",
      "name": "Calcular tecnologia (cubierta)1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "059e152e-2548-4983-add7-2d9f28cc9968",
              "leftValue": "={{ Number($items(\"Build JSON completo\")[0].json?.interiores?.[0]?.papel_id ?? 0) }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        5792,
        1264
      ],
      "id": "346162fb-7bcf-48d1-9acf-0c07e3aba930",
      "name": "¬øpapel_id > 0?1"
    },
    {
      "parameters": {
        "url": "https://liberdigital.gomezaparicio.es/sw/automatizacion/bobinas/stock",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "options": {
          "allowUnauthorizedCerts": true,
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        6192,
        1536
      ],
      "id": "032c2e9f-30bd-4e6f-a59b-59db895e7eb0",
      "name": "API Bobinas Stock1",
      "alwaysOutputData": true,
      "notesInFlow": false,
      "credentials": {
        "httpBasicAuth": {
          "id": "EGTFeBpcDKH8NdqZ",
          "name": "Apis Libernet"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// items = lista de items que vienen del HTTP (117 bobinas)\nconst stock = items.map(i => i.json);\n\n// devolvemos 1 solo item con un campo stock = [ ...bobinas ]\nreturn [{ json: { stock } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6576,
        1648
      ],
      "id": "cabcc54e-11a4-4a2d-977b-fbc46346d0ec",
      "name": "Agrupar stock1"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        3168,
        2224
      ],
      "id": "0397886d-42f4-4e42-bb30-b01ced711474",
      "name": "Unir pedido + stock1"
    },
    {
      "parameters": {
        "jsCode": "function toNumber(v) {\n  if (v === null || v === undefined) return NaN;\n  if (typeof v === \"number\") return v;\n\n  const s = String(v)\n    .trim()\n    // deja solo d√≠gitos, coma, punto y signo\n    .replace(/[^\\d.,+-]/g, \"\")\n    // si hay coma, la tratamos como decimal\n    .replace(\",\", \".\");\n\n  const n = Number(s);\n  return Number.isFinite(n) ? n : NaN;\n}\n\nfunction normStr(v) {\n  return (v ?? \"\").toString().trim();\n}\n\n// normalizaci√≥n ‚Äútipo prompt‚Äù: min√∫sculas, sin acentos, colapsa espacios\nfunction normKey(v) {\n  return (v ?? \"\")\n    .toString()\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\") // quita acentos\n    .toLowerCase()\n    .replace(/\\s+/g, \" \")\n    .trim();\n}\n\n// gramaje robusto: acepta \"70\", \"70 g\", \"70gr\", \"70,0\"\nfunction normGramaje(v) {\n  const s = (v ?? \"\").toString().replace(/[^\\d.,]/g, \"\");\n  const n = toNumber(s);\n  return Number.isFinite(n) ? n : NaN;\n}\n\n// ======================\n// INPUT\n// ======================\nconst root = { ...$json };\nconst pedido = root.pedido ?? root;\n\n// stock puede estar en root.stock, root.stock.stock, pedido.stock, pedido.stock.stock...\nconst bobinas =\n  Array.isArray(root.stock) ? root.stock :\n  Array.isArray(root.stock?.stock) ? root.stock.stock :\n  Array.isArray(pedido.stock) ? pedido.stock :\n  Array.isArray(pedido.stock?.stock) ? pedido.stock.stock :\n  [];\n\n// ======================\n// VALIDACIONES\n// ======================\nconst interior0 = Array.isArray(pedido.interiores) ? pedido.interiores[0] : null;\nif (!interior0) return [{ json: pedido }];\nif (!Array.isArray(bobinas) || bobinas.length === 0) return [{ json: pedido }];\n\n// ======================\n// DATOS PEDIDO (como Azure Function)\n// ======================\nconst anchoLibroCm = toNumber(pedido.anchoPaginaCm);\nif (!Number.isFinite(anchoLibroCm)) return [{ json: pedido }];\n\nconst unionPliegos = toNumber(pedido.unionPliegos);\nconst esCosido = Number.isFinite(unionPliegos) && unionPliegos === 1;\n\nconst propietarioDeseado = \"Liberdigital\";\n\n// üëá robusto\nconst calidadPedidoN = normKey(interior0?.calidad);\nconst gramajePedidoN = normGramaje(interior0?.papelPedido?.gramaje);\n\nconst certificacionCodigo = normStr(pedido.certificacion);\n\n// ======================\n// MAPEO CERTIFICACI√ìN (igual que Python)\n// ======================\nconst mapaCert = {\n  \"2\": \"FSC MIX CREDIT\",\n  \"3\": \"100% PEFC CERTIFICADO\",\n  \"4\": \"70% PEFC CERTIFICADO\",\n  \"5\": \"FSC Reciclado 100%\",\n};\n\nconst certTexto = mapaCert[certificacionCodigo] ?? null;\n\n// ======================\n// 1) FILTRAR CALIDAD + GRAMAJE (robusto OCR)\n// ======================\nlet base = bobinas.filter(b => {\n  const calidadB = normKey(b.calidad);\n  const gramajeB = normGramaje(b.gramaje);\n\n  // si no podemos parsear gramaje, NO lo aceptamos\n  if (!Number.isFinite(gramajePedidoN) || !Number.isFinite(gramajeB)) return false;\n\n  return calidadB === calidadPedidoN && gramajeB === gramajePedidoN;\n});\n\nif (base.length === 0) {\n  // Limpieza stock igualmente\n  delete root.stock;\n  if (root.pedido) delete root.pedido.stock;\n  delete pedido.stock;\n  if (pedido.pedido) delete pedido.pedido.stock;\n  delete pedido.seleccionBobina;\n  delete root.seleccionBobina;\n\n  return [{ json: pedido }];\n}\n\n// ======================\n// 2) CALCULAR CANDIDATOS (propietario + cert + copias)\n// ======================\nconst anchoEfectivo = anchoLibroCm + 1;\nif (!(anchoEfectivo > 0)) return [{ json: pedido }];\n\nconst candidatos = [];\n\nfor (const b of base) {\n  const anchoBobina = toNumber(b.ancho); // admite \"48\", \"48 cm\", etc.\n  if (!Number.isFinite(anchoBobina) || anchoBobina <= 0) continue;\n\n  // propietario (igual que python: si bobina trae propietario y no coincide, fuera)\n  const propBobina = normKey(b.propietario);\n  if (propietarioDeseado && propBobina && propBobina !== normKey(propietarioDeseado)) continue;\n\n  // certificaci√≥n\n  const certBobina = normKey(b.certificacion);\n  if (certTexto && certBobina) {\n    const certObjetivo = normKey(certTexto);\n\n    if (certObjetivo === normKey(\"FSC MIX CREDIT\")) {\n      // admite MIX CREDIT o MIX 70%\n      if (certBobina !== normKey(\"FSC MIX CREDIT\") && certBobina !== normKey(\"FSC MIX 70%\")) continue;\n    } else {\n      if (certBobina !== certObjetivo) continue;\n    }\n  }\n\n  // max copias base\n  const maxCopias = Math.floor(anchoBobina / anchoEfectivo);\n  if (maxCopias <= 0) continue;\n\n  let copias;\n  if (esCosido) {\n    // solo 4 o 2\n    if (maxCopias >= 4) copias = 4;\n    else if (maxCopias >= 2) copias = 2;\n    else continue;\n  } else {\n    // fresado: todas las que quepan\n    copias = maxCopias;\n  }\n\n  candidatos.push({\n    bobina: b,\n    copiasEnAncho: copias,\n    anchoBobina: anchoBobina,\n  });\n}\n\nif (candidatos.length === 0) {\n  // Limpieza stock\n  delete root.stock;\n  if (root.pedido) delete root.pedido.stock;\n  delete pedido.stock;\n  if (pedido.pedido) delete pedido.pedido.stock;\n  delete pedido.seleccionBobina;\n  delete root.seleccionBobina;\n\n  return [{ json: pedido }];\n}\n\n// ======================\n// 3) ELEGIR MEJOR (igual que python)\n// 1¬∫ mayor copiasEnAncho\n// 2¬∫ menor anchoBobina\n// ======================\ncandidatos.sort((a, b) => {\n  if (b.copiasEnAncho !== a.copiasEnAncho) return b.copiasEnAncho - a.copiasEnAncho;\n  return a.anchoBobina - b.anchoBobina;\n});\n\nconst mejor = candidatos[0].bobina;\nconst ups = candidatos[0].copiasEnAncho;\n\n// ======================\n// 4) APLICAR AL PEDIDO\n// ======================\nconst papelIdNuevo = toNumber(mejor.papelId);\nif (Number.isFinite(papelIdNuevo)) interior0.papel_id = papelIdNuevo;\n\nif (typeof interior0.papelPedido !== \"object\" || interior0.papelPedido === null) {\n  interior0.papelPedido = {};\n}\n\n// mantenemos gramaje, pero lo reasignamos por seguridad\ninterior0.papelPedido.gramaje = toNumber(mejor.gramaje) || toNumber(interior0.papelPedido.gramaje) || 0;\n\n// ancho bobina\ninterior0.papelPedido.anchoBobinaCm = toNumber(mejor.ancho) || 0;\n\n// ups (siempre calculado como el Python)\ninterior0.papelPedido.ups = ups;\n\n// kg siempre 0\ninterior0.papelPedido.kg = 0;\n\n// referencia informativa\nif (normStr(mejor.referencia)) interior0.papelPedido.refPedido = normStr(mejor.referencia);\n\n// ======================\n// LIMPIEZA STOCK\n// ======================\ndelete root.stock;\nif (root.pedido) delete root.pedido.stock;\n\ndelete pedido.stock;\nif (pedido.pedido) delete pedido.pedido.stock;\n\ndelete pedido.seleccionBobina;\ndelete root.seleccionBobina;\n\n// ======================\n// SALIDA\n// ======================\nreturn [{ json: pedido }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3664,
        2224
      ],
      "id": "5eebf258-684d-4c0b-ba7d-242b27b68df4",
      "name": "Seleccionar bobina (JS)1"
    },
    {
      "parameters": {
        "jsCode": "function toNumber(v) {\n  if (v === null || v === undefined) return NaN;\n  if (typeof v === 'number') return v;\n  if (typeof v === 'string') return Number(v.replace(',', '.').trim());\n  return Number(v);\n}\n\nfunction calcUps({ anchoBobinaCm, anchoPaginaCm, unionPliegos }) {\n  const aBob = toNumber(anchoBobinaCm);\n  const aPag = toNumber(anchoPaginaCm);\n  const uPl  = toNumber(unionPliegos);\n\n  if (!Number.isFinite(aBob) || aBob <= 0) return null;\n  if (!Number.isFinite(aPag)) return null;\n\n  const denom = aPag + 1;\n  if (!Number.isFinite(denom) || denom <= 0) return null;\n\n  // 1) F√≥rmula base exacta + parte entera (sin redondear)\n  const base = Math.floor(aBob / denom);\n\n  // 2) Reglas seg√∫n unionPliegos\n  // 2 = FRESADO => tal cual\n  if (uPl === 2) return base;\n\n  // 1 = COSIDO => solo 0 / 2 / 4\n  if (uPl === 1) {\n    if (base >= 4) return 4;\n    if (base >= 2) return 2;\n    return 0;\n  }\n\n  // Si viene otro valor, por defecto aplicamos base (si prefieres otra cosa, lo cambiamos)\n  return base;\n}\n\n// ======================\n// INPUT\n// ======================\nconst data = $json;\n\n// interiores[0]\nconst interior0 = Array.isArray(data?.interiores) ? data.interiores[0] : null;\nif (!interior0) return [{ json: data }];\n\n// papelPedido\nif (typeof interior0.papelPedido !== 'object' || interior0.papelPedido === null) {\n  interior0.papelPedido = {};\n}\n\n// Datos necesarios (salen de Parse output_text1)\nconst anchoPaginaCm = data.anchoPaginaCm;\nconst unionPliegos  = data.unionPliegos;\n\n// anchoBobinaCm: si ya vino en papelPedido, lo usamos\nconst anchoBobinaCm = interior0.papelPedido.anchoBobinaCm;\n\n// Calcular\nconst ups = calcUps({ anchoBobinaCm, anchoPaginaCm, unionPliegos });\n\n// Si no se puede calcular, NO TOCAMOS NADA\nif (ups === null) return [{ json: data }];\n\n// Guardar ups (solo esto)\ninterior0.papelPedido.ups = ups;\n\nreturn [{ json: data }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2448,
        1200
      ],
      "id": "d959ec20-67dc-45b1-9b21-ef5582d38b19",
      "name": "Calcular UPS (interiores)1"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2224,
        1200
      ],
      "id": "8662ebf4-975d-4935-9da7-2ec792780fce",
      "name": "Merge9"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://liberdigital-des.gomezaparicio.es/desarrollo/sw/automatizacion/pedidos/digital/nuevo/",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        6880,
        1072
      ],
      "id": "bd6583a8-6080-4f03-b74e-1e96f8b22183",
      "name": "Desarrollo2",
      "credentials": {
        "httpBasicAuth": {
          "id": "EGTFeBpcDKH8NdqZ",
          "name": "Apis Libernet"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f0ce385a-7aee-445a-9af9-1acee2a8952e",
              "name": "promptCabecera",
              "value": "## ANAYA v1\n\nAct√∫a como un extractor de datos. Tu tarea es analizar el PDF adjunto y devolver exclusivamente un JSON v√°lido conforme al siguiente esquema:\n\n## MODELO DE SALIDA\n{\n  \"cliente\": 34,\n  \"contacto\": 0,\n  \"suReferencia\": 0,\n  \"numeroOf\": \"\",\n  \"numeroOtCliente\": \"\",\n  \"isbnPack\": \"\",\n  \"fechaEntrega\": \"\",\n  \"sinRetraso\": false,\n  \"tirada\": 0,\n  \"precioUnitarioSinIVA\": 0,\n  \"precioToltalSinIVA\": 0,\n  \"quiereVerFerros\": 3,\n  \"certificacion\": 0,\n  \"observacionesPedido\": \"\",\n  \"titulo\": \"\",\n  \"sello\": \"\",\n  \"isbn\": \"\",\n  \"codProyecto\": \"\",\n  \"anchoPaginaCm\": 0,\n  \"altoPaginaCm\": 0,\n  \"unionPliegos\": 0,\n  \"encuadernacion\": 0,\n  \"cabezada\": 0,\n  \"cabezadaColor\": 0,\n  \"cabezadaColorOtro\": \"\",\n  \"guardasAparte\": 0,\n  \"guardasImpresas\": 0,\n  \"cintaRegistro\": 0,\n  \"cintaRegistroColor\": 0,\n  \"cintaRegistroColorOtro\": \"\",\n  \"calibreCarton\": 0,\n  \"tipoLomo\": 0,\n  \"solapa\": false,\n  \"hendidoCortesia\": false,\n  \"espiralMaterial\": 0,\n  \"espiralColor\": 0,\n  \"espiralColorOtro\": \"\",\n  \"espiralLado\": 0,\n  \"wireoMaterial\": 0,\n  \"wireoColor\": 0,\n  \"wireoColorOtro\": \"\",\n  \"wireoLado\": 0,\n  \"observacionesEncuadernacion\": \"\"\n}\n\n## REGLAS OBLIGATORIAS\n1) Devuelve SOLO JSON. Sin texto adicional. Sin markdown. Sin explicaciones.  \n2) El JSON debe ser v√°lido (comillas dobles, sin trailing commas).  \n3) Cumple el esquema al 100%:  \n   - No inventes campos que no existan en el esquema.  \n   - No devuelvas claves extra fuera del esquema.  \n   - Respeta tipos (string/number/boolean/array/object) y enum si existen.  \n4) Si un dato no aparece en el PDF:  \n   - Usa null si el esquema lo permite.  \n   - Si NO permite null, usa el valor vac√≠o adecuado: \"\" para string, 0 para number, false para boolean, [] para arrays, {} para objetos (solo si el esquema lo permite).  \n   - Si un campo indica \"siempre vac√≠o\", debe devolverse como cadena vac√≠a (\"\") aunque se detecte contenido.  \n5) Normalizaci√≥n:  \n   - Fechas en formato \"YYYY-MM-DD\" si el esquema no indica otro.  \n   - Importes num√©ricos sin s√≠mbolo de moneda (ej: 174.00).  \n   - Medidas: conserva unidades solo si el esquema lo pide; si no, usa n√∫mero limpio.  \n   - Ignora acentos SOLO para detectar coincidencias; el valor devuelto mantiene tildes originales.  \n   - Si un texto contiene comillas internas, esc√°palas con una barra invertida: \\\"  \n   - Acepta SI/S√≠/No/NO sin importar may√∫sculas/acentos.  \n   EN LA BUSQUEDA DE DATOS:  \n   - Coincidencia sin distinguir may√∫sculas/min√∫sculas.  \n   - Ignora acentos/diacr√≠ticos.  \n   - Colapsa espacios m√∫ltiples y recorta espacios sobrantes.  \n6) Verificaci√≥n final antes de responder:  \n   - Revisa que el JSON parsea.  \n   - Revisa que cumple el esquema.  \n   - Revisa que no hay texto fuera del JSON.\n\n## REGLAS POR CAMPO\n- \"cliente\": Devuelve 34.  \n- \"contacto\": Usa el prompt de CONTACTO.  \n- \"suReferencia\":   Busca en la secci√≥n \"T√çTULOS\" el \"C√≥digo Comercial\". Acepta etiquetas equivalentes: \"C√≥digo Comercial\", \"C√≥d. Com.\", \"Cod. Com.\". Devuelve solo d√≠gitos (number). Ej: \"191121\" ‚Üí 191121.\n- \"numeroOf\":   En \"T√çTULOS\", busca \"N¬∫ O.F.\" o \"Orden de Fabricaci√≥n\" y devuelve el n√∫mero.  \n- \"numeroOtCliente\":   Busca \"ORDEN DE TRABAJO N¬∫\" o \"ORDEN DE TRABAJO DE OTROS DIGITAL N¬∫\". Devuelve el n√∫mero SIN puntos ni separadores. Ej: \"1.132.221\" ‚Üí \"1132221\"..  \n- \"fechaEntrega\":   En \"ACONDICIONAMIENTO Y ENTREGA\", columna \"Fecha Entrega\". Convierte a \"YYYY-MM-DD\". Si est√° vac√≠o/no aparece, busca primera fecha dd/mm/aaaa en el bloque de instrucciones/entrega (cerca de GETAFE/Distribuir/ENTREGAR).\n- \"sinRetraso\":   true si en \"ACONDICIONAMIENTO Y ENTREGA / Instrucciones\" aparece literalmente \"URGENTE\" o \"URGENTES\". En caso contrario false..  \n- \"tirada\":   En \"T√çTULOS\", campo/columna \"TIRADA\" (o \"Tirada\").\n- \"precioUnitarioSinIVA\": siempre 0.  \n- \"precioToltalSinIVA\": Busca \"TOTAL ORDEN\". Devuelve solo el importe como n√∫mero, Quita puntos de miles y cambia coma decimal por punto. Ej \"498,83\" ‚Üí 498.83.\n- \"quiereVerFerros\":   En \"ACONDICIONAMIENTO Y ENTREGA / Instrucciones\": 1 si detectas \"ferro digital\". 2 si detectas \"ferro f√≠sico\" o \"ferro fisico\". 3 si no se menciona nada.  \n- \"certificacion\": Usa el prompt de CERTIFICACION.  \n- \"observacionesPedido\": Usa el prompt de OBSERVACIONES.  \n- \"titulo\":   Busca SOLO en la secci√≥n \"T√çTULOS\", en la columna/celda \"T√≠tulo\". PROHIBIDO usar \"T√≠tulo del Elemento\" de la secci√≥n \"ELEMENTOS Y TIRADAS\".\n              Limpieza:\n              - elimina prefijo tipo \"90.\" al inicio si existiera\n              - elimina una barra \"/\" final si existiera\n              - si el texto contiene \" / \" con m√°s contenido, qu√©date SOLO con la parte anterior a la primera barra. \n- sello:  Devuelve el primer sello/editorial del encabezado del documento (por ejemplo \"GRUPO ANAYA,- S.A. (C√°tedra)\").\n              - GRUPO ANAYA,- S.A. (C√°tedra)\n              - GRUPO EDITORIAL BRU√ëO,S.L (Escolar)\n              - ALIANZA EDITORIAL S.A. (Libro de Bolsillo)\n              - EDITORIAL BARCANOVA S.A. (Texto)\n              - EDICIONS XERAIS DE GALICIA S.A (Edici√≥n General)\n              - ALIANZA EDITORIAL S.A. (Libro de Bolsillo)\n- \"isbn\": siempre \"\" (aunque aparezca).  \n- \"codProyecto\": En \"T√çTULOS\", campo \"C√≥digo Proyecto\"..  \n- \"anchoPaginaCm\"/\"altoPaginaCm\":   Busca el \"Formato\" (en instrucciones o en tabla de elaboraciones).\n                                    Acepta separadores \"x\", \"X\", \"*\", \"¬∑\".\n                                    Ej: \"13,50 x 21,00\" o \"13,5*21\" ‚Üí anchoPaginaCm=13.5, altoPaginaCm=21.0  \n- \"unionPliegos\":   En \"ELABORACIONES...\" o donde figure \"Encuadernaci√≥n: ...\":\n                      si contiene \"FRESADO\" ‚Üí 2\n                      si contiene \"COSIDO\"  ‚Üí 1  \n- \"encuadernacion\": En Instrucciones: devuelve el n√∫mero 1=Carton√©/Tapa dura, 2=Flexible, 3=R√∫stica, 4=Espiral, 5=Grapa, 6=Wire-o, 7=Otro.  \n- \"cabezada\": En Instrucciones: 1 si aparece \"Cabezada SI/S√ç\" y encuadernaci√≥n es 1 o 2, si aparece \"SIN cabezadas\" o no aparece devuelve 0.  \n- \"cabezadaColorOtro\":  \n  - Si aparece ‚ÄúCabezada S√≠‚Äù y encuadernacion ‚àà {1,2} ‚áí cabezada = 1.  \n    - Extrae el texto despu√©s de ‚ÄúS√≠‚Äù (ej.: Politi 1 - Blanco).  \n    - Guarda ese color en cabezadaColorOtro (string).  \n    - cabezadaColor debe ser 0 siempre.  \n  - Si aparece ‚ÄúCabezada No‚Äù o no hay ‚ÄúCabezada‚Äù ‚áí cabezada = 0, cabezadaColorOtro = \"\" y cabezadaColor = 0.  \n  - Scope: Eval√∫a ‚ÄúS√≠/No‚Äù y el texto asociado solo en la misma l√≠nea donde aparezca ‚ÄúCabezada‚Äù (o 1 l√≠nea debajo). Ignora ‚Äús√≠/no‚Äù en otras secciones.  \n  - Si cabezada=1 y no hay texto despu√©s de ‚ÄúS√≠‚Äù, entonces cabezadaColorOtro=\"\" (vac√≠o).  \n- \"guardasAparte\": 1 si encuadernaci√≥n ‚àà {1,2}, si no 0.  \n- \"guardasImpresas\": 1 si aparece ‚Äúguardas impresas‚Äù y encuadernaci√≥n ‚àà {1,2}, si no 0.  \n- \"cintaRegistro\": 1 si aparece ‚ÄúCinta de registro SI‚Äù o \"Cinta registro SI/S√ç\" y encuadernaci√≥n ‚àà {1,2}, si aparece ‚ÄúCinta de registro NO\" o \"Cinta registro NO\" devuelve 0.  \n- \"cintaRegistroColorOtro\":  \n  - Si aparece ‚ÄúS√≠‚Äù y encuadernacion ‚àà {1,2} ‚áí cintaRegistro = 1.  \n    - Extrae el texto despu√©s de ‚ÄúS√≠‚Äù (ej.: Politi 8 - Blanco).  \n    - Guarda ese color en cintaRegistroColorOtro (string).  \n    - cintaRegistroColor debe ser 0 siempre.  \n  - Si aparece ‚ÄúNo‚Äù o no hay menci√≥n ‚áí cintaRegistro = 0, cintaRegistroColorOtro = \"\", cintaRegistroColor = 0.  \n  - Importante: NO pongas cintaRegistro = 0 solo porque no encuentres el color. Son cosas independientes.  \n  - Scope: Eval√∫a ‚ÄúS√≠/No‚Äù y el texto asociado solo en la misma l√≠nea donde aparezca ‚ÄúCinta de registro‚Äù (o 1 l√≠nea debajo). Ignora ‚Äús√≠/no‚Äù en otras secciones.  \n  - Si cintaRegistro=1 y no hay texto despu√©s de ‚ÄúS√≠‚Äù, entonces cintaRegistroColorOtro=\"\" (vac√≠o).  \n- \"calibreCarton\": Usa el prompt de CALIBRE.  \n- \"tipoLomo\": 1 = ‚Äúlomo cuadrado‚Äù, 2 = ‚Äúlomo redondo‚Äù y encuadernaci√≥n ‚àà {1,2}, si no 0.  \n- \"solapa\": Busca tanto en ELABORACIONES Y VALORACI√ìN -Elementos gr√°ficos- / Encuadernaci√≥n como en ACONDICIONAMIENTO Y ENTREGA / Instrucciones y devuelve true si aparece literalmente \"SOLAPA\", \"SOLAPAS\", \"CON SOLAPA\", \"CON SOLAPAS\". false si aparece \"SIN SOLAPA\", \"SIN SOLAPAS\" o no aparece nada. Coincidencia insensible a may√∫sculas/min√∫sculas ni acentos.  \n- \"hendidoCortesia\": Devuelve true.  \n- Los campos como ‚Äúespiral...‚Äù o ‚Äúwireo...‚Äù solo se rellenan si aparecen expl√≠citamente en el PDF, si no mantener en 0 o \"\".  \n- \"observacionesEncuadernacion\": Solo si detectas \"Guardas impresas NO\" busca referencia al material de impresi√≥n, ejemplo \"Geltex\".\n\n\n## PROMPTS\n\n### CONTACTO\nBusca en el PDF solo en la parte inferior de la orden (el √∫ltimo cuarto de la p√°gina). Seguido a Fdo., localiza el nombre y apellidos juntos.\n  Reglas:\n    Coincidencia sin distinguir may√∫sculas/min√∫sculas.\n    Ignora acentos/diacr√≠ticos (√Å= A, √â= E, √ç= I, √ì= O, √ö= U, √ú= U, √ë= N).\n    Colapsa espacios m√∫ltiples y recorta espacios sobrantes.\n    Si varias l√≠neas del mapa coinciden tras normalizar (por ejemplo, duplicados con y sin acento), devuelve el usuarioId menor.\n    Si no hay coincidencia, devuelve 0.\n    Salida: devuelve solo el n√∫mero usuarioId (entero, sin comillas).\n    Mapa nombre ‚Üí usuarioId:\n              Concepci√≥n Mercado = 160\n              Cristina Calvo = 161\n              Didac Puigcerver = 163\n              Jose E. Valdepe√±as = 164\n              Jose Exp√≥sito = 165\n              Juan A. Barras = 166\n              Juan F. Garc√≠a = 167\n              Juan J. Rodr√≠guez = 168\n              Luis M. Bustos = 169\n              Manuel Fern√°ndez = 170\n              Natalia Yag√ºez = 171\n              Ruben Camacho = 172\n              Oscar Bravo = 176\n              Juan F. Garc√≠a Escalonilla = 177\n              Daniel = 225\n              Pilar = 227\n              BEL√âN = 454\n              Carmen = 473\n              Maria Isabel = 476\n              ALEJANDRO = 482\n              Susana = 487\n              SARA = 495\n              Aurora = 501\n              √ÅNGELES = 506\n\n### OBSERVACIONES\n    1. Localiza el bloque de texto del apartado ‚ÄúInstrucciones‚Äù del √≠tem (fila) correspondiente.\n    2. Extrae el bloque completo, desde la primera l√≠nea (p.ej. ‚ÄúRUSTICA FRESADA‚Ä¶‚Äù) hasta justo antes de la primera aparici√≥n de:\n          - una fecha de entrega (patr√≥n dd/mm/aaaa o dd/mm/aa), o\n          - el encabezado/log√≠stica tipo ‚ÄúPaquetes y/o Cajas‚Ä¶‚Äù, ‚ÄúENTREGAS:‚Äù, ‚ÄúFACTURACI√ìN:‚Äù, ‚ÄúOBSERVACIONES GENERALES‚Äù.\n    3. Devu√©lve un solo p√°rrafo (reemplazar \\n y guiones repetidos (ejemplo: ------) por espacio).\n    4. No incluyas en observacionesPedido los valores de Fecha Entrega / Destino / Para (van en sus campos).\n    5. Si el texto de Instrucciones est√° en una celda contigua a otras columnas, NO concatenes esas columnas al texto.\n          Normaliza:\n              - Sustituye cada salto de l√≠nea (\\n o nueva l√≠nea real) por un √∫nico espacio.\n              - Despu√©s, colapsa espacios m√∫ltiples a uno y recorta\n\n### CALIBRE\nObjetivo:\nDevuelve exclusivamente el ID correspondiente al calibreCarton seg√∫n la tabla. Si no se encuentra una coincidencia inequ√≠voca, devuelve 0.\n\nMAPEO (calibre ‚Üí ID):\n- 1,5 ‚Üí 1\n- 2,0 ‚Üí 2\n- 2,5 ‚Üí 3\n- 3,0 ‚Üí 4\n- 2,0 + espuma 3 ‚Üí 5\n- 2,5 + espuma 3 ‚Üí 6\n- 3,0 + espuma 3 ‚Üí 7\n- 1,75 ‚Üí 8\n- 2,25 ‚Üí 9\n- 2,75 ‚Üí 10\n\nREGLAS DE DETECCI√ìN:\n1. Scope:\n- Prioriza coincidencias cercanas a palabras clave como: ‚Äúcalibre‚Äù, ‚Äúcart√≥n‚Äù, ‚Äúcartone‚Äù, ‚Äútapa‚Äù, ‚Äúcubierta‚Äù, ‚Äúcaja r√≠gida‚Äù.\n- Si no se encuentran cerca de esas palabras, busca en todo el PDF.\n\n2. Normalizaci√≥n previa:\n- Ignora may√∫sculas, min√∫sculas y acentos.\n- Considera \".\" igual a \",\" (ej.: ‚Äú2.5‚Äù se interpreta como ‚Äú2,5‚Äù).\n- Elimina espacios innecesarios.\n- ‚Äúfoam‚Äù, ‚Äúesp.‚Äù y ‚Äúespuma‚Äù se consideran equivalentes.\n- ‚Äúmm‚Äù es opcional y puede omitirse.\n\n3. Orden de detecci√≥n (prioridad):\na) Detecta primero patrones que indiquen combinaciones con espuma 3 (acepta formatos con \"+\", \"con\", \"y\", incluso en orden invertido).\nb) Si no hay espuma, busca solo el calibre exacto (usando el mapeo anterior).\n\n4. Desempate:\n- Si aparecen varios valores posibles:\n  - Prioriza el m√°s espec√≠fico (el que incluye espuma).\n  - Si tienen misma especificidad, elige el m√°s cercano al contexto (palabras clave del Scope).\n  - Si persiste el empate ‚Üí devuelve 0.\n\nSALIDA:\nDevuelve √∫nicamente el n√∫mero del ID (ej.: 3). Si no hay coincidencia inequ√≠voca, devuelve 0.\n\nEJEMPLOS:\n- ‚Äú2,5 mm‚Äù ‚Üí 3\n- ‚Äú3,0 + espuma 3‚Äù ‚Üí 7\n- ‚Äú2.0 + FOAM 3‚Äù ‚Üí 5\n- ‚Äú1,75‚Äù ‚Üí 8\n- ‚Äú2,0 y 2,5 sin claridad‚Äù ‚Üí 0\n\nsolo si encuadernaci√≥n ‚àà {1,2}, si no 0.\n\n### CERTIFICACION\nIdentifica el bloque correcto ‚ÄúDescripci√≥n (del art√≠culo)‚Äù siguiendo esta l√≥gica:\n\n1. LOCALIZACI√ìN DEL BLOQUE:\n- Busca una l√≠nea exacta con el texto ‚ÄúDescripci√≥n‚Äù.\n- Dentro de las 10 l√≠neas siguientes, debe aparecer al menos uno de estos r√≥tulos de ficha:\n  Autor, Ed/Enc, Colecci√≥n, Tiraje, Formato, N¬∫ P√°ginas, Solapa, Grosor, C√≥digo Barras.\n- Si ‚ÄúDescripci√≥n‚Äù forma parte de una tabla o cabecera (por ejemplo en ‚ÄúServicios‚Äù o ‚ÄúComponentes‚Äù), desc√°rtalo: no es el bloque de ficha del art√≠culo.\n\n2. DEFINICI√ìN DEL BLOQUE:\n- El bloque comienza en la l√≠nea inmediatamente posterior a ‚ÄúDescripci√≥n‚Äù.\n- Finaliza al encontrar alguno de estos r√≥tulos:\n  Autor, Ed/Enc, Colecci√≥n, Tiraje, Formato, N¬∫ P√°ginas, Solapa, Grosor, C√≥digo Barras, Servicios, Componentes, Observaciones.\n\n3. ALCANCE DE B√öSQUEDA:\n- La b√∫squeda de certificaci√≥n se limita √∫nicamente a ese bloque validado.\n\n4. DETECCI√ìN DE CERTIFICACI√ìN (valores literales y sensibles a may√∫sculas/min√∫sculas):\n- Si aparece exactamente ‚ÄúFSC Mix‚Äù ‚áí devuelve 2.\n- Si no aparece ‚ÄúFSC Mix‚Äù pero s√≠ aparece exactamente ‚ÄúPEFC‚Äù ‚áí devuelve 4.\n- En cualquier otro caso ‚áí devuelve 0.\n- Si ambos aparecen ‚áí da prioridad a ‚ÄúFSC Mix‚Äù (devuelve 2).\n\n5. EXCLUSIONES EXPL√çCITAS:\nIgnora cualquier menci√≥n a ‚ÄúFSC‚Äù, ‚ÄúFSC¬Æ‚Äù, ‚ÄúFSC Mix‚Äù, ‚ÄúPEFC‚Äù si:\n- Est√° en cabeceras, pies de p√°gina o notas legales (ej.: ‚Äúempresa certificada FSC¬Æ‚Ä¶‚Äù).\n- Est√° dentro de las tablas o secciones ‚ÄúServicios‚Äù o ‚ÄúComponentes‚Äù (ej.: ‚ÄúMB PRIME BRIGHT‚Ä¶ (FSC)‚Äù).\n\n6. SALIDA:\nDevuelve √∫nicamente el valor en ‚Äúcertificacion‚Äù: 2, 4 o 0. No devuelvas ning√∫n texto adicional.\n\n\n## IMPORTANTE\nDevuelve todos los valores del esquema aunque esten vacios o sin datos",
              "type": "string"
            },
            {
              "id": "c96c9a1c-073d-4f7e-b50a-3cd080f922a9",
              "name": "promptInteriores",
              "value": "## ANAYA v1\n\nAct√∫as como extractor de datos de √ìrdenes de Trabajo (PDF). \nDevuelve EXCLUSIVAMENTE un JSON v√°lido que cumpla el esquema EXACTO.\n\nREGLAS GENERALES\n1) Devuelve SOLO JSON (sin texto, sin markdown).\n2) JSON v√°lido (comillas dobles, sin comas finales).\n3) Devuelve SIEMPRE todas las claves del esquema. No a√±adas claves nuevas.\n4) Tipos estrictos: number/string/boolean.\n5) Si no hay dato: \"\" para string, 0 para number, false para boolean.\n6) Normaliza para comparar: min√∫sculas, sin acentos, colapsa espacios, elimina guiones de salto de l√≠nea OCR.\n\nESQUEMA DE SALIDA (exacto)\n{\n  \"interiores\": [\n    {\n      \"papel_id\": 0,\n      \"propietarioPapel\": 0,\n      \"tipoImpresion\": 0,\n      \"calidad\": \"\",\n      \"paginas\": 0,\n      \"plegadoOCortado\": 0,\n      \"maquina\": 0,\n      \"observaciones\": \"\",\n      \"papelPedido\": {\n        \"refPedido\": \"\",\n        \"gramaje\": 0,\n        \"anchoBobinaCm\": 0,\n        \"upsCalc\": 0,\n        \"ups\": 0,\n        \"metros\": 0,\n        \"kg\": 0\n      }\n    }\n  ]\n}\n\nOBJETIVO\nExtraer SOLO datos de INTERIORES. Ignora completamente cualquier dato de cubierta.\n\nFILTRO (MUY IMPORTANTE)\n- Solo considera filas/textos donde aparezca: ‚ÄúINT‚Äù, ‚ÄúINTERIOR‚Äù, ‚ÄúCTE INT‚Äù, ‚ÄúCUERPO‚Äù, ‚ÄúINTERIORES‚Äù.\n- Excluye cualquier fila/texto donde aparezca: ‚ÄúCUB‚Äù, ‚ÄúCUBIERTA‚Äù, ‚ÄúTAPA‚Äù, ‚ÄúSOBRECUBIERTA‚Äù.\n\nFLUJO DE EXTRACCI√ìN (prioridad obligatoria)\nA) Primero intenta MATERIALES ‚Üí columna ‚ÄúMaterial‚Äù (solo interiores).\nB) Si no hay MATERIALES para interiores, usa ELABORACIONES Y VALORACI√ìN ‚Üí ‚ÄúClase de papel‚Äù (solo interiores).\nC) Si tampoco hay, usa Observaciones/Instrucciones que describan el papel interior.\n\nMAPEO por MATERIALES/Material\nSi en MATERIALES / Material aparece literal OFF.PQ.AHUE.SAT.ORIA PEFC. 54,0x 0,0.110,0 (gr.) ‚Üí \"papel_id\":  596\nSi en MATERIALES / Material aparece literal OFF.DIG.PQ.AHUE.SAT.ORIA PEFC. 50,0x 0,0. 80,0 (gr.) ‚Üí \"papel_id\":  593\nSi en MATERIALES / Material aparece literal OFF.PQ.AHUE.SAT.ORIA PRINT IVORY PEFC. 54,0x 0,0. 70,0 (gr.) ‚Üí \"papel_id\":  592\nSi en MATERIALES / Material aparece literal OFF.PQ.AHUE.SAT.ORIA PRINT IVORY PEFC. 48,0x 0,0. 70,0 (gr.) ‚Üí \"papel_id\":  590\nSi en MATERIALES / Material aparece literal OFF.PQ.AHUE.SAT.ORIA PRINT IVORY PEFC. 52,0x 0,0. 70,0 (gr.) ‚Üí \"papel_id\":  588\n\n\nSI:\n- \"papel_id\":  596 devuelve \"propietarioPapel\": 2, \"calidad\": \"Ahuesado\", \"gramaje\": 110, \"refPedido\": \"Ahuesado Oria (ANAYA)\" y \"anchoBobinaCm\": 54\n- \"papel_id\":  593 devuelve \"propietarioPapel\": 2, \"calidad\": \"Ahuesado\", \"gramaje\": 80, \"refPedido\": \"Ahuesado Oria (ANAYA)\" y \"anchoBobinaCm\": 50\n- \"papel_id\":  592 devuelve \"propietarioPapel\": 2, \"calidad\": \"Ahuesado\", \"gramaje\": 70, \"refPedido\": \"Ahuesado Oria (ANAYA)\" y \"anchoBobinaCm\": 54\n- \"papel_id\":  590 devuelve \"propietarioPapel\": 2, \"calidad\": \"Ahuesado\", \"gramaje\": 70, \"refPedido\": \"Ahuesado Oria (ANAYA)\" y \"anchoBobinaCm\": 48\n- \"papel_id\":  588 devuelve \"propietarioPapel\": 2, \"calidad\": \"Ahuesado\", \"gramaje\": 70, \"refPedido\": \"Ahuesado Oria (ANAYA)\" y \"anchoBobinaCm\": 52\n\n\nSI NO HAY papel_id POR MAPEO (fallback)\n- \"calidad\": si no encuantras Materiales, completa el json con los datos del papel que encuentres en ELABORACIONES Y VALORACI√ìN -Elementos gr√°ficos- columna Clase de papel.\n                devuelve literalmente \"Ahuesado\" si aparece solo la referencia ahuesado\n                devuelve literalmente \"Ahuesado volumen 1.5\" si aparece solo la referencia ahuesado mano 1.5 o ahuesado 1.5\n                devuelve literalmente \"Ahuesado volumen 1.6\" si aparece solo la referencia ahuesado mano 1.6 o ahuesado 1.6\n                devuelve literalmente \"Ahuesado volumen 1.8\" si aparece solo la referencia ahuesado mano 1.8 o ahuesado 1.8\n                devuelve literalmente \"Ahuesado volumen 2\" si aparece solo la referencia ahuesado mano 2.0 o ahuesado 2.0 o ahuesado 2\n                devuelve literalmente \"Estucado semimate\" si aparece solo la referencia Estudado o Estucado semimate\n                devuelve literalmente \"Offset blanco\" si aparece solo la referencia Offset blanco\n                devuelve literalmente \"Offset Blanco Volumen\" si aparece solo la referencia Offset Blanco Volumen\n                En estos casos deja \"papel_id\": 0 y propietarioPapel = 1.\n\n\ntipoImpresion (interiores)\n- Si detectas ‚Äú1/1‚Äù, ‚Äú1+1‚Äù, ‚ÄúNEGRO‚Äù, ‚ÄúB/N‚Äù o ‚ÄúInkjet Premium‚Äù ‚Üí tipoImpresion = 2\n- Si detectas ‚Äú4/4‚Äù, ‚Äú4+4‚Äù, ‚ÄúCMYK‚Äù, ‚Äúcuatricrom√≠a‚Äù, ‚Äúcolor‚Äù ‚Üí tipoImpresion = 1\n- Si no hay evidencia ‚Üí tipoImpresion = 1\n\npaginas\n- En ELABORACIONES Y VALORACI√ìN - Elementos gr√°ficos, toma el valor ‚ÄúP√°g.‚Äù asociado a interiores (Cte INT / Interior).\n- Si no aparece, 0.\n\nkg\n- En MATERIALES, usa la fila del papel interior (por filtro INT/INTERIOR) y toma la columna num√©rica de Kg asociada a esa fila (no totales).\n- Si no aparece, 0.\n\nNo extraer. Dejar fijo en valor 0:\nplegadoOCortado=0, maquina=0, observaciones=\"\", upsCalc=0, ups=0, metros=0.\n\nSi detectas m√°s de un papel interior distinto, devuelve un objeto por cada uno en el array ‚Äúinteriores‚Äù.\n",
              "type": "string"
            },
            {
              "id": "61b81b8a-7210-47b0-8839-f6cf5cb901c4",
              "name": "promptCubierta",
              "value": "### ANAYA v1\n\nAct√∫as como un extractor de datos de √ìrdenes de Trabajo (PDF). Tu tarea es analizar el PDF adjunto y devolver EXCLUSIVAMENTE un JSON v√°lido que cumpla ESTRICTAMENTE el esquema proporcionado.\n\nREGLAS OBLIGATORIAS\n1) Devuelve SOLO JSON. Sin texto adicional. Sin markdown. Sin explicaciones.\n2) El JSON debe ser v√°lido (comillas dobles, sin trailing commas).\n3) Devuelve EXACTAMENTE las claves del esquema (ni m√°s ni menos).\n4) Respeta tipos:\n   - number: solo n√∫meros (sin comillas)\n   - string: texto entre comillas\n5) Si un dato NO aparece en el PDF: usa 0 para number y \"\" para string.\n6) Normalizaci√≥n para b√∫squeda:\n   - Coincidencia insensible a may√∫sculas/min√∫sculas.\n   - Ignora acentos/diacr√≠ticos.\n   - Colapsa espacios y saltos m√∫ltiples a un espacio.\n   - Elimina guiones de final de l√≠nea por OCR.\n7) Consistencia: NO mezcles datos de interiores con cubierta.\n8) Verificaci√≥n final: el JSON debe parsear y no debe haber nada fuera del JSON.\n\nMODELO DE SALIDA (exacto)\n{\n  \"cubierta\": {\n    \"materialCubierta\": 0,\n    \"propietarioPapel\": 0,\n    \"plastificado\": 0,\n    \"uvi\": 0,\n    \"impresion\": \"4/0\",\n    \"codDescarga\": 0,\n    \"tecnologia\": 0,\n    \"observaciones\": \"\"\n  }\n}\n\nOBJETIVO\nExtraer SOLO datos de CUBIERTA (portada/tapa). Ignora completamente interiores.\n\nFILTRO (muy importante)\n- Solo considera texto/filas donde aparezca alguna de estas evidencias:\n  \"CUB\", \"CUBIERTA\", \"TAPA\", \"PORTADA\", \"SOBRECUBIERTA\", \"CUB. EXT\", \"CUB EXT\", \"CUBIERTA EXT\"\n- Excluye texto/filas donde aparezca:\n  \"INT\", \"INTERIOR\", \"CTE INT\", \"INTERIORES\", \"CUERPO\"\n\nFUENTES PRIORITARIAS (orden obligatorio)\n1) SECCI√ìN \"ELABORACIONES Y VALORACI√ìN - Elementos gr√°ficos\" (si hay referencia espec√≠fica a cubierta)\n2) SECCI√ìN \"ACONDICIONAMIENTO Y ENTREGA / Instrucciones\" (solo si menciona cubierta expl√≠citamente)\n\nREGLAS POR CAMPO\n\nA) materialCubierta (number)\nELABORACIONES Y VALORACI√ìN -Elementos gr√°ficos- / Clase de papel\n    - Si Cte CUB -> Clase de papel CARTULINA GOF2C -> 250 devuelve estos valores ‚áí materialCubierta=14  ‚áí propietarioPapel=1  ‚áí plastificado=6 (SIGNIFICA: SIN PLASTIFICADO / NO APLICA, No eval√∫es el campo Recubrimiento ni busques plastificado en instrucciones. Ignora ‚ÄúGOFRADO‚Äù si apareciera en otro contexto)\n    - Si Cte CUB -> Clase de papel CART.EST.1C.PQ -> 240 devuelve estos valores ‚áí materialCubierta=1  ‚áí propietarioPapel=1\n\n    - Si la encuadernaci√≥n es Carton√©/Tapa dura/Flexible devuelve estos valores ‚áí materialCubierta=2  ‚áí propietarioPapel=1\n\nB) plastificado (number)\n    - ELABORACIONES Y VALORACI√ìN -Elementos gr√°ficos- / Recubrimiento (m√°s espec√≠fico ‚Üí gen√©rico; insensible a may√∫sculas/acentos):\n          \"MATE SEDOSO\"‚Üí3\n          \"MATE ANTIRRAYA\"‚Üí4\n          \"BRILLO DIGITAL\"‚Üí7\n          \"MATE DIGITAL\"‚Üí8,\n          \"GOFRADO\"‚Üí5\n          \"NATUREFLEX\"‚Üí9\n          \"SANDY\"‚Üí10\n          \"BRILLO\"‚Üí1\n          \"MATE\"‚Üí2,\n          IMPORTANTE: Si Recubrimiento est√° vac√≠o o no existe ‚Üí plastificado=6\n\nC) uvi (number)\nACONDICIONAMIENTO Y ENTREGA / Instrucciones\n    - Busca ‚ÄúUVI‚Äù, ‚ÄúUV‚Äù, ‚ÄúBARNIZ UVI‚Äù, ‚ÄúBARNIZ UV‚Äù, ‚ÄúRESERVA UVI/UV‚Äù.\n    - Mapea:\n      - ‚ÄúUVI/UV TOTAL‚Äù / ‚ÄúUV TOTAL‚Äù ‚Üí uvi = 1\n      - ‚ÄúUVI/UV RESERVA‚Äù / ‚ÄúUV RESERVA‚Äù / ‚ÄúRESERVA‚Äù ‚Üí uvi = 2\n      - ‚ÄúSIN UVI/UV‚Äù ‚Üí uvi = 0\n    - Solo considera ‚ÄòRESERVA‚Äô si est√° en la misma frase/l√≠nea que ‚ÄòUVI‚Äô, ‚ÄòUV‚Äô o ‚ÄòBARNIZ\n    - Si no se menciona ‚Üí 0\n\nD) impresion (string)\nELABORACIONES Y VALORACI√ìN -Elementos gr√°ficos- / b/v\n- Extrae el formato de impresi√≥n de la cubierta si aparece (ej: 1/0, 1/1, 4/0, 4/1, 4/4, 5/0.\n- Si no hay evidencia, deja el valor por defecto: \"4/0\"\n\nE) codDescarga (number)\n-Busca en T√çTULOS / Imprimir C√≥digo\n    - Si = 1\n    - NO = 0\n\nF) tecnologia (number)\n\nH) observaciones (string)\nACONDICIONAMIENTO Y ENTREGA / Instrucciones. Extrae solo frases que contengan ‚Äòcubierta‚Äô, ‚Äòtapa‚Äô, ‚Äòportada‚Äô, ‚Äòsolapa‚Äô, ‚Äòplastificado‚Äô, ‚Äòrecubrimiento‚Äô, ‚Äògofrado‚Äô, ‚Äòuvi/uv‚Äô, ‚Äòbarniz‚Äô, ‚Äòlaminado.\n\nIMPORTANTE\n- No uses informaci√≥n de ‚Äúinteriores‚Äù para completar campos de cubierta.\n- Devuelve SOLO el JSON final.\n",
              "type": "string"
            },
            {
              "id": "5dab2b9d-9686-473a-85b9-8bfe63dfe1d0",
              "name": "promptExtras",
              "value": "### ANAYA v1\n\nAct√∫as como un extractor de datos de documentos. Tu tarea es analizar el PDF adjunto y devolver EXCLUSIVAMENTE un JSON v√°lido que cumpla ESTRICTAMENTE el esquema proporcionado.\n\n### REGLAS OBLIGATORIAS:\n1) Devuelve SOLO JSON. Sin texto adicional. Sin markdown. Sin explicaciones.\n2) El JSON debe ser v√°lido (comillas dobles, sin trailing commas).\n3) Cumple el esquema al 100%:\n   - No inventes campos que no existan en el esquema.\n   - No devuelvas claves extra fuera del esquema.\n   - Respeta tipos (string/number/boolean/array/object) y enum si existen.\n4) Si un dato no aparece en el PDF:\n   - Usa null si el esquema lo permite.\n   - Si NO permite null, usa el valor vac√≠o adecuado: \"\" para string, 0 para number, false para boolean, [] para arrays, {} para objetos (solo si el esquema lo permite).\n   - Si un campo indica \"siempre vac√≠o\", debe devolverse como cadena vac√≠a (\"\") aunque se detecte contenido.\n5) Normalizaci√≥n:\n   - Fechas en formato \"YYYY-MM-DD\" si el esquema no indica otro.\n   - Importes num√©ricos sin s√≠mbolo de moneda (ej: 174.00).\n   - Medidas: conserva unidades solo si el esquema lo pide; si no, usa n√∫mero limpio.\n   - En la recogida de datos mant√©n tildes y caracteres originales.\n   - Si un texto contiene comillas internas, esc√°palas con una barra invertida: \\\"\n    EN LA BUSQUEDA DE DATOS:\n        - Coincidencia sin distinguir may√∫sculas/min√∫sculas.\n        - Ignora acentos/diacr√≠ticos\n        - Colapsa espacios m√∫ltiples y recorta espacios sobrantes\n6) Consistencia:\n   - Si hay tablas/listas (servicios, componentes, direcciones), devu√©lvelas como arrays.\n   - No mezcles datos de secciones distintas.\n7) Verificaci√≥n final antes de responder:\n   - Revisa que el JSON parsea.\n   - Revisa que cumple el esquema.\n   - Revisa que no hay texto fuera del JSON\n\n\n### MODELO DE SALIDA:\n{\n  \"guardas\": {\n    \"papel_id\": 0,\n    \"propietarioPapel\": 0,\n    \"tipoImpresion\": 0,\n    \"calidad\": \"\",\n    \"paginas\": 0,\n    \"plegadoOCortado\": 0,\n    \"maquina\": 0,\n    \"observaciones\": \"\",\n    \"papelPedido\": {\n      \"refPedido\": \"\",\n      \"gramaje\": 0,\n      \"anchoBobinaCm\": 0,\n      \"upsCalc\": 0,\n      \"ups\": 0,\n      \"metros\": 0,\n      \"kg\": 0\n    },\n    \"papelProduccion\": {\n      \"refProduccion\": \"\",\n      \"gramaje\": 0,\n      \"anchoBobinaCm\": 0,\n      \"upsCalc\": 0,\n      \"ups\": 0,\n      \"metros\": 0,\n      \"kg\": 0\n    }\n  },\n  \"sobrecubierta\": {\n    \"materialSobrecubierta\": 0,\n    \"propietarioPapel\": 0,\n    \"plastificado\": 0,\n    \"uvi\": 0,\n    \"impresion\": \"\",\n    \"tecnologia\": 0,\n    \"observaciones\": \"\"\n  },\n  \"faja\": {\n    \"materialFaja\": 0,\n    \"propietarioPapel\": 0,\n    \"plastificado\": 0,\n    \"uvi\": 0,\n    \"impresion\": \"\",\n    \"tecnologia\": 0,\n    \"observaciones\": \"\"\n  },\n  \"componentesEspeciales\": [\n    {\n      \"material\": 0,\n      \"propietarioPapel\": 0,\n      \"nombre\": \"\",\n      \"plastificado\": 0,\n      \"uvi\": 0,\n      \"impresion\": \"\",\n      \"tecnologia\": 0,\n      \"observaciones\": \"\"\n    }\n  ],\n  \"peticionesEspeciales\": [\n    {\n      \"descripcion\": \"\"\n    }\n  ],\n  \"direcciones\": [\n    {\n      \"direccionId\": \"\",\n      \"destinatario\": \"\",\n      \"via\": \"\",\n      \"numero\": \"\",\n      \"piso\": \"\",\n      \"puerta\": \"\",\n      \"cp\": \"\",\n      \"localidad\": \"\",\n      \"provincia\": \"\",\n      \"pais\": \"\",\n      \"contacto\": \"\",\n      \"telefonos\": \"\",\n      \"pallet\": 0,\n      \"encajado\": 0,\n      \"ejemplaresPaquete\": 0,\n      \"ejemplares\": 0,\n      \"envioResto\": 0,\n      \"modelos\": 0,\n      \"observaciones\": \"\"\n    }\n  ]\n}\n\n### GUARDAS:\nInstrucciones:\n    1. SOLO devuelve datos si detectas indicios de guardas (ej. ‚Äúguardas incluidas‚Äù, ‚Äúguardas aparte‚Äù, ‚Äúguardas impresas‚Äù).\n    2. Verifica el tipo de encuadernaci√≥n:\n      - Si encuadernaci√≥n = 3 (R√∫stica), 4 (Espiral), 5 (Grapa) o 6 (Wire-o) ‚Üí NO lleva guardas ‚Üí NO devuelvas nada.\n      - Solo lleva guardas si encuadernaci√≥n = 1 (Carton√©) o 2 (Flexible).\n    3. Si hay referencia v√°lida a guardas, devuelve este bloque JSON con los siguientes valores fijos o vac√≠os:\n    4. Valor de `\"refPedido\"`:\n      - Si se menciona ‚Äúguardas aparte‚Äù: busca el texto del papel al final de las observaciones y √∫salo como descripci√≥n.\n      - Si se menciona ‚Äúguardas incluidas‚Äù: usa la descripci√≥n del papel del interior como refPedido.\n    5. Usa exactamente estas equivalencias para interpretar descripciones encontradas en observaciones:\n      - \"Ahuesado\" devuelve esto:\n                {\n                  \"guardas\": {\n                    \"papel_id\": 561,\n                    \"propietarioPapel\": 1,\n                    \"tipoImpresion\": 1,\n                    \"calidad\": \"Ahuesado\",\n                    \"paginas\": 8,\n                    \"observaciones\": \"\",\n                    \"papelPedido\": {\n                      \"refPedido\": \"Ahuesado Oria\", \n                      \"gramaje\": 120,\n                      \"anchoBobinaCm\": 54,\n                      \"ups\": 2\n                    }\n                  }\n                }\n    - \"Offset blanco\" devuelve esto:\n                {\n                  \"guardas\": {\n                    \"papel_id\": 620,\n                    \"propietarioPapel\": 1,\n                    \"tipoImpresion\": 1,\n                    \"calidad\": \"Offset blanco\",\n                    \"paginas\": 8,\n                    \"observaciones\": \"\",\n                    \"papelPedido\": {\n                      \"refPedido\": \"Navigator Offset Premium 161\", \n                      \"gramaje\": 120,\n                      \"anchoBobinaCm\": 54,\n                      \"ups\": 2\n                    }\n                  }\n                }\n    - \"Estucado\" devuelve esto:   \n                {\n                  \"guardas\": {\n                    \"papel_id\": 613,\n                    \"propietarioPapel\": 1,\n                    \"tipoImpresion\": 1,\n                    \"calidad\": \"Estucado semimate\",\n                    \"paginas\": 8,\n                    \"observaciones\": \"\",\n                    \"papelPedido\": {\n                      \"refPedido\": \"G-Silk\", \n                      \"gramaje\": 150,\n                      \"anchoBobinaCm\": 54,\n                      \"ups\": 2\n                    }\n                  }\n                }\n\n### SOBRECUBIERTA:\nBasate en este prompt Rellenar solo si el PDF contiene una menci√≥n expl√≠cita a SOBRECUBIERTA.\n    - Trabaja sin distinguir may√∫sculas/min√∫sculas ni acentos.\n    - Solo cuenta si aparece la palabra ‚Äúsobrecubierta‚Äù o las variantes ‚Äúsobre cubierta‚Äù o ‚Äúsobre-cubierta‚Äù como palabra independiente, en frases tipo: ‚Äúlleva sobrecubierta‚Äù, ‚Äúcolocar sobrecubierta‚Äù, ‚Äúimprimir sobrecubierta‚Äù, etc.\n    - No la confundas nunca con la palabra ‚Äúcubierta‚Äù (es otra cosa) ni con ‚Äúfaja‚Äù, aunque usen el mismo material, gramaje, plastificado, UVI o cualquier otro dato.\n    - Ignora por completo la informaci√≥n de cubierta, faja, guardas, encuadernaci√≥n, materiales, gramajes, plastificados y UVI para decidir si hay sobrecubierta:\n    - Si no aparece literalmente ‚Äúsobrecubierta‚Äù / ‚Äúsobre cubierta‚Äù / ‚Äúsobre-cubierta‚Äù, deja todos los valores por defecto.\n    - Si ves negaciones claras como ‚Äúsin sobrecubierta‚Äù, ‚Äúno lleva sobrecubierta‚Äù, ‚Äúno colocar sobrecubierta‚Äù, tambi√©n debes dejar los valores por defecto.\n\n    No deduzcas ni supongas la existencia de sobrecubierta por contexto: solo decide por la palabra literal indicada.\n      \"materialSobrecubierta\": devuelve 15.\n      \"propietarioPapel\": devuelve 1.\n\n      \"plastificado\":\n          brillo ‚Üí 1\n          mate ‚Üí 2\n          mate sedoso ‚Üí 3\n          mate antirraya ‚Üí 4\n          gofrado ‚Üí 5\n          brillo digital ‚Üí 7\n          mate digital ‚Üí 8\n          natureflex ‚Üí 9\n          sandy ‚Üí 10\n          cualquier otro caso ‚Üí 6\n\n    - \"uvi\": Devuelve 1 si aparece referencia UVI o 0 si no aparece.\n    - \"Impresion\": Si no detectas \"materialSobrecubierta\" no devuelvas nada, si no usa literalmente \"4/0\", \"4/1\", \"4/4\", \"1/0\", \"5/0\", si no lo encuentras devuelve 4/0. Si detectas la referencia \"Reverso\" indica 4/4.\n    - \"tecnologia\": \n    - \"Observaciones\": indica \"Recibimos modelo de impresi√≥n\" solo si el documento contiene alguna referencia expl√≠cita a ‚Äúenviamos modelo‚Äù, \"enviamos prueba\", \"muestra de impresi√≥n\" (Coincidencia insensible a may√∫sculas/min√∫sculas ni acentos).\n\n    GATE SOBRECUBIERTA (OBLIGATORIO):\n        - Busca SOLO coincidencias literales como palabra independiente: \"sobrecubierta\", \"sobre cubierta\", \"sobre-cubierta\"\n        - Ignora coincidencias donde solo aparezca \"cubierta\".\n        - Si NO hay coincidencia literal -> sobrecubierta = valores por defecto y NO rellenar nada m√°s.\n        - Si hay negaci√≥n dentro de una ventana de 5 palabras: (\"sin\", \"no\", \"nunca\") -> valores por defecto.\n        Ejemplos de negaci√≥n: \"sin sobrecubierta\", \"no lleva sobrecubierta\", \"no colocar sobrecubierta\".\n\n    PROHIBICI√ìN:\n        - Est√° prohibido copiar valores de \"cubierta\" a \"sobrecubierta\" o \"faja\".\n        - Aunque haya plastificado, UVI o impresi√≥n, si no se supera el GATE literal, deja sobrecubierta/faja por defecto.\n    \n    PRUEBA M√çNIMA (interna):\n        - Para marcar sobrecubierta/faja como presente, debes localizar un fragmento del PDF que contenga la palabra gatillo EXACTA.\n        - Si no puedes se√±alar internamente esa frase, entonces NO est√° presente y devuelves valores por defecto.\n        - No devuelvas el fragmento en el JSON.\n    √ÅMBITO:\n        - Si detectas \"sobrecubierta\", solo puedes extraer plastificado/uvi/impresion desde:\n            a) la misma l√≠nea, o\n            b) las 2 l√≠neas siguientes.\n        - En cualquier otro caso, deja esos campos por defecto.\n\n### FAJA:\nBasate en este prompt Rellenar solo si hay informaci√≥n referente a FAJA o FAJILLA (Coincidencia insensible a may√∫sculas/min√∫sculas ni acentos) en el PDF, ejemplos \"lleva faja\", \"colocar fajilla\", \"imprimir faja\", si no dejar valores por defecto.\n    - \"materialFaja\": devuelve 15.\n    - \"propietarioPapel\": devuelve 1.\n    - \"plastificado\":\n                brillo ‚Üí 1\n                mate ‚Üí 2\n                mate sedoso ‚Üí 3\n                mate antirraya ‚Üí 4\n                gofrado ‚Üí 5\n                brillo digital ‚Üí 7\n                mate digital ‚Üí 8\n                natureflex ‚Üí 9\n                sandy ‚Üí 10\n                cualquier otro caso ‚Üí 6\n    - \"uvi\": Devuelve 1 si aparece referencia UVI o 0 si no aparece.\n    - \"Impresion\": Si no detectas \"materialFaja\" no devuelvas nada, si no usa literalmente \"4/0\", \"4/1\", \"4/4\", \"1/0\", \"5/0\", si no lo encuentras devuelve 4/0. Si detectas la referencia \"Reverso\" indica 4/4.\n    - \"tecnologia\":   \n    - Observaciones: indica \"Recibimos modelo de impresi√≥n\" solo si el documento contiene alguna referencia expl√≠cita a ‚Äúenviamos modelo‚Äù, \"enviamos prueba\", \"muestra de impresi√≥n\" (Coincidencia insensible a may√∫sculas/min√∫sculas ni acentos)..\n\n    GATE FAJA (OBLIGATORIO):\n        - Solo acepta como evidencia la palabra literal: \"faja\" o \"fajilla\" como palabra independiente.\n        - Si NO aparece -> faja = valores por defecto.\n        - Si aparece negada (\"sin faja\", \"no lleva faja\") -> valores por defecto.\n        - No uses jam√°s materiales, plastificados o impresi√≥n para inferir la existencia de faja.\n    \n    PROHIBICI√ìN:\n        - Est√° prohibido copiar valores de \"cubierta\" a \"sobrecubierta\" o \"faja\".\n        - Aunque haya plastificado, UVI o impresi√≥n, si no se supera el GATE literal, deja sobrecubierta/faja por defecto.\n    \n    PRUEBA M√çNIMA (interna):\n        - Para marcar sobrecubierta/faja como presente, debes localizar un fragmento del PDF que contenga la palabra gatillo EXACTA.\n        - Si no puedes se√±alar internamente esa frase, entonces NO est√° presente y devuelves valores por defecto.\n        - No devuelvas el fragmento en el JSON.\n    √ÅMBITO:\n        - Si detectas \"sobrecubierta\", solo puedes extraer plastificado/uvi/impresion desde:\n            a) la misma l√≠nea, o\n            b) las 2 l√≠neas siguientes.\n        - En cualquier otro caso, deja esos campos por defecto.\n\n\n### COMPONENTES ESPECIALES:\nBasate en este prompt Busca en el PDF menciones a elementos especiales como:\n    - \"Cuadernillo\"\n    - \"Encarte\"\n    - \"Pliego\"\n\n    (Sensibilidad: no distingue may√∫sculas/min√∫sculas/acentos)\n\n### Si encuentras una menci√≥n, devuelve el siguiente JSON (rellenado):\n\"componentesEspeciales\": [\n  {\n    \"material\": 0,           // Devuelve el papel indicado en esa secci√≥n\n    \"propietarioPapel\": 1,   // Devuelve siempre 1\n    \"nombre\": \"ENCARTE\",     // Devuelve literalmente ENCARTE\n    \"plastificado\": 0,       // Siempre vac√≠o\n    \"uvi\": 0,            // Siempre vac√≠o\n    \"impresion\": \"4/0\",      // Usa literalmente lo que indique el pedido (ej.: \"4/0\", \"4/1\", \"4/4\", \"1/0\", \"5/0\"). Si no lo encuentras, devuelve \"4/0\"\n    \"tecnologia\": 1,         // Devuelve siempre 1\n    \"observaciones\": \"\"      // Devuelve la l√≠nea o l√≠neas relacionadas al encarte/cuadernillo/pliego detectado\n  }\n]\n\n### Si no encuentras nada, no devuelvas este bloque.\n.\n\n### PETICIONES ESPECIALES:\n\nAnaliza el texto del PDF (en texto plano) y detecta si se solicitan estos elementos especiales: Faja, Topo, Sobrecubierta, Cuadernillo, Encarte, Pliego.\n\nReglas generales de detecci√≥n\n    No distingas may√∫sculas/min√∫sculas ni acentos.\n    No hagas inferencias por contexto: solo cuenta si aparece la palabra clave literal.\n    La coincidencia debe ser palabra completa, separada por espacios o signos de puntuaci√≥n.\n    No cuentes coincidencias dentro de otras palabras (por ejemplo: ‚Äúfajardo‚Äù, ‚Äútopograf√≠a‚Äù, ‚Äúplegadora‚Äù no valen).\n    Revisa primero las zonas de Observaciones, Notas y Componentes/Servicios; si no encuentras nada, revisa el resto del documento.\n\nNegaciones\n    Si una menci√≥n est√° negada cerca de la palabra clave, NO la cuentes.\n    Usa una ventana de ¬±5 palabras alrededor de la palabra clave.\n    Palabras o frases de negaci√≥n: ‚Äúsin‚Äù, ‚Äúno‚Äù, ‚Äúno lleva‚Äù, ‚Äúsin llevar‚Äù, ‚Äúsin colocar‚Äù.\n    Ejemplos: ‚Äúsin faja‚Äù ‚Üí no contar ‚Äúfaja‚Äù; ‚Äúno lleva sobrecubierta‚Äù ‚Üí no contar ‚Äúsobrecubierta‚Äù; ‚Äúno colocar topo‚Äù ‚Üí no contar ‚Äútopo‚Äù.\n    Si ves ‚Äúguardas‚Äù: null, ‚Äúsobrecubierta‚Äù: null, ‚Äúfaja‚Äù: null, no lo cuentes.\n\nPalabras clave por tipo\n\nFaja:\nPalabra clave: ‚Äúfaja‚Äù.\nSolo cuenta ‚Äúfaja‚Äù como palabra independiente.\nNo cuentes ‚Äúfajilla‚Äù ni otras palabras m√°s largas que contengan ‚Äúfaja‚Äù.\nSi hay una menci√≥n v√°lida (no negada), a√±ade ‚ÄúColocar faja‚Äù al array peticionesEspeciales.\n\nTopo:\nPalabra clave: ‚Äútopo‚Äù.\nSolo cuenta ‚Äútopo‚Äù como palabra independiente.\nSi hay una menci√≥n v√°lida (no negada), a√±ade ‚ÄúColocar topo‚Äù al array peticionesEspeciales.\n\nSobrecubierta:\nPalabra clave: ‚Äúsobrecubierta‚Äù.\nAcepta como equivalentes las variantes con espacio o guion: ‚Äúsobre cubierta‚Äù, ‚Äúsobre-cubierta‚Äù.\nNo cuentes ‚Äúcubierta‚Äù sola.\nNo deduzcas nunca que hay sobrecubierta por tipo de encuadernaci√≥n, UVI, plastificado, carton√©, guardas, faja o fajilla. Solo cuenta si aparece literalmente ‚Äúsobrecubierta‚Äù (o sus variantes indicadas).\nSi hay una menci√≥n v√°lida (no negada), a√±ade ‚ÄúColocar Sobrecubierta‚Äù al array peticionesEspeciales.\n\nCuadernillo:\nPalabra clave: ‚Äúcuadernillo‚Äù.\nSi hay una menci√≥n v√°lida (no negada), a√±ade al array peticionesEspeciales la(s) frase(s) donde se mencione ‚Äúcuadernillo‚Äù, omitiendo referencias a papel (tipo de papel, gramaje, etc.).\n\nEncarte:\nPalabra clave: ‚Äúencarte‚Äù.\nSi hay una menci√≥n v√°lida (no negada), a√±ade al array peticionesEspeciales la(s) frase(s) donde se mencione ‚Äúencarte‚Äù, omitiendo referencias a papel.\n\nPliego:\nPalabra clave: ‚Äúpliego‚Äù.\nSi hay una menci√≥n v√°lida (no negada), a√±ade al array peticionesEspeciales la(s) frase(s) donde se mencione ‚Äúpliego‚Äù, omitiendo referencias a papel.\n\nConstrucci√≥n de peticionesEspeciales:\npeticionesEspeciales es un array de cadenas.\nPuede contener:\n\n‚ÄúColocar faja‚Äù\n\n‚ÄúColocar topo‚Äù\n\n‚ÄúColocar Sobrecubierta‚Äù\n\nLas frases correspondientes a Cuadernillo, Encarte y Pliego (sin referencias a papel).\n\nCada tipo de elemento solo puede aparecer una vez en el array.\nEl array debe respetar el orden en el que se detecta cada elemento por primera vez en el documento.\nSi un elemento no aparece o solo aparece en forma negada, no lo a√±adas al array.\n\nProhibiciones\nNo inventes elementos especiales si no aparecen las palabras clave expl√≠citas.\nNo infieras Faja, Topo, Sobrecubierta, Cuadernillo, Encarte o Pliego por contexto, tipo de libro, UVI, plastificado, carton√©, fajilla, etc.\nNo cuentes menciones negadas.\nNo generes texto extra fuera de la estructura de salida.\n\nSalida esperada (solo esto):\nUn objeto JSON con:\n‚ÄúpeticionesEspeciales‚Äù: array de cadenas.\n\n### DIRECCIONES:\n\n      Reglas:\n          Buscar si existe un alias exacto en el PDF:\n              Usa coincidencia insensible a may√∫sculas/min√∫sculas, acentos y elimina espacios extra.\n              La coincidencia debe ser por frase completa (no dentro de otras palabras).\n          En caso de empate:\n              Prefiere alias completo exacto.\n              Luego la cadena coincidente m√°s larga.\n              Luego el menor direccionId.\n          Si se encuentra un alias:\n            Devuelve un objeto con:\n              \"direccionId\" correspondiente del mapa.\n              Solo el campo \"ejemplares\" con el n√∫mero de tirada.\n              Todos los dem√°s campos deben ir vac√≠os (\"\") o en 0.\n              Si NO se encuentra alias:\n              Usa \"direccionId\": 0.\n              Extrae del PDF todos los campos posibles:\n              via, numero, piso, puerta, cp, localidad, provincia, pais, contacto, telefonos, pallet, encajado, ejemplaresPaquete, ejemplares, envioResto, modelos, observaciones.\n              Si alg√∫n campo no aparece, d√©jalo vac√≠o (\"\") o en 0.\n              Regla adicional \"Sin muestras\" o \"Sin muestra\":\n              Si NO se encuentra la referencia \"Sin muestras\" o \"Sin muestra\" en observaciones:\n\n            Mapa ‚Üí direccionId:\n                  GETAFE = 2\n                  OFICINA = 3\n                  TRACTILPACK = 52\n                  GAMAN ENCUADERNACI√ìN = 221\n\n      Formato de salida (id√©ntico a este):\n      Si encuentras direccionId devuleve:\n      {\n        \"direcciones\": [\n          {\n            \"direccionId\": 0,\n            \"ejemplares\": 0\n          }\n        ]\n      }\n      \n      Si no completa este:    \n      {\n        \"direcciones\": [\n          {\n            \"direccionId\": 0,\n            \"destinatario\": \"\",\n            \"via\": \"\",\n            \"numero\": \"\",\n            \"piso\": \"\",\n            \"puerta\": \"\",\n            \"cp\": \"\",\n            \"localidad\": \"\",\n            \"provincia\": \"\",\n            \"pais\": \"\",\n            \"contacto\": \"\",\n            \"telefonos\": \"\",\n            \"pallet\": 0,\n            \"encajado\": 0,\n            \"ejemplaresPaquete\": 0,\n            \"ejemplares\": 0,\n            \"envioResto\": 0,\n            \"modelos\": 0,\n            \"observaciones\": \"\"\n          }\n        ]\n      }\n\n",
              "type": "string"
            },
            {
              "id": "cc2cb1a8-001c-47c2-905c-932fb95e2f0a",
              "name": "",
              "value": "",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        432,
        800
      ],
      "id": "9dfce2fd-ef78-4a8e-b325-6c8b341fa02c",
      "name": "PromptConfig_ANAYA1"
    },
    {
      "parameters": {
        "content": "## Prompt Mono",
        "height": 384,
        "width": 320,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        336,
        656
      ],
      "typeVersion": 1,
      "id": "39d4caf9-9128-4995-8189-f884df7618c6",
      "name": "Sticky Note20"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/responses",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpBearerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-4o-mini\",\n  \"temperature\": 0,\n  \"input\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Eres un extractor de datos de pedidos de impresi√≥n. Devuelve SOLO JSON v√°lido seg√∫n el esquema. Prohibido inventar datos.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": [\n        {\n          \"type\": \"input_file\",\n          \"file_id\": \"{{$json.openaiFileIdClean}}\"\n        },\n        {\n          \"type\": \"input_text\",\n          \"text\": \"Tarea: Detecta CODIGOS DE PROYECTO dentro del apartado 'T√çTULOS'.\\n\\nReglas estrictas:\\n1) SOLO extrae valores que est√©n en la tabla bajo la columna 'C√≥digo Proyecto' (o 'C√≥digo Proy.').\\n2) NO busques c√≥digos fuera del bloque 'T√çTULOS'. Ignora 'ELEMENTOS Y TIRADAS', 'ELABORACIONES', etc.\\n3) Devuelve la lista en orden de aparici√≥n, SIN duplicados.\\n4) Si no est√°s seguro, no lo incluyas.\\n\\nDevuelve SOLO el JSON del esquema.\"\n        }\n      ]\n    }\n  ],\n  \"text\": {\n    \"format\": {\n      \"type\": \"json_schema\",\n      \"name\": \"project_detector\",\n      \"strict\": true,\n      \"schema\": {\n        \"type\": \"object\",\n        \"additionalProperties\": false,\n        \"properties\": {\n          \"projectCount\": { \"type\": \"integer\" },\n          \"isMulti\": { \"type\": \"boolean\" },\n          \"projects\": {\n            \"type\": \"array\",\n            \"items\": {\n              \"type\": \"object\",\n              \"additionalProperties\": false,\n              \"properties\": {\n                \"codigoProyecto\": { \"type\": \"string\" }\n              },\n              \"required\": [\"codigoProyecto\"]\n            }\n          },\n          \"evidence\": {\n            \"type\": \"object\",\n            \"additionalProperties\": false,\n            \"properties\": {\n              \"projectsFound\": {\n                \"type\": \"array\",\n                \"items\": { \"type\": \"string\" }\n              },\n              \"notes\": { \"type\": \"string\" }\n            },\n            \"required\": [\"projectsFound\", \"notes\"]\n          }\n        },\n        \"required\": [\"projectCount\", \"isMulti\", \"projects\", \"evidence\"]\n      }\n    }\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -512,
        416
      ],
      "id": "ab533acc-413a-4b39-9d72-1fb0386e4250",
      "name": "cuantos titulos",
      "alwaysOutputData": false,
      "executeOnce": false,
      "retryOnFail": false,
      "credentials": {
        "httpBearerAuth": {
          "id": "Fb5EZ7r56FOl5M3A",
          "name": "Http Open AI"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "function uniq(arr) {\n  return [...new Set((arr || []).filter(Boolean))];\n}\n\nfunction getOutputText(resp) {\n  const msg = (resp.output || []).find(o => o.type === \"message\");\n  const out = msg?.content?.find(c => c.type === \"output_text\")?.text;\n  return out || \"\";\n}\n\nconst resp = $json; // item del nodo HTTP\n\nconst outText = getOutputText(resp);\n\n// 1) Parse JSON seguro\nlet data;\ntry {\n  data = JSON.parse(outText);\n} catch (e) {\n  data = {\n    projectCount: 0,\n    isMulti: false,\n    projects: [],\n    evidence: { projectsFound: [], notes: \"No se pudo parsear output_text como JSON\" }\n  };\n}\n\n// 2) Normaliza lista de c√≥digos desde projects + evidence\nconst fromProjects = (data.projects || []).map(p => p?.codigoProyecto).filter(Boolean);\nconst fromEvidence = (data.evidence?.projectsFound || []).filter(Boolean);\n\nlet codes = uniq([...fromProjects, ...fromEvidence]).map(s => String(s).trim());\n\n// 3) Anti-hallucination: filtro por formato (AJUSTA si tu cliente cambia)\n// Para ANAYA tipo BS000741\nconst re = /^[A-Z]{2}\\d{6}$/;\ncodes = codes.filter(c => re.test(c));\n\n// 4) Reconstruye salida consistente\nconst result = {\n  projectCount: codes.length,\n  isMulti: codes.length > 1,\n  projects: codes.map(c => ({ codigoProyecto: c })),\n  evidence: {\n    projectsFound: codes,\n    notes: data.evidence?.notes || \"Normalizado desde c√≥digos √∫nicos (post-filtro aplicado)\"\n  },\n  _rawDetectorText: outText\n};\n\nreturn [{ json: result }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -304,
        416
      ],
      "id": "7a32aae1-1f90-4ba2-af8a-bc17b60540bf",
      "name": "Code in JavaScript1",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "88b10645-d2fe-4b22-98c9-5c87a9896c85",
              "leftValue": "={{ $json.isMulti }}",
              "rightValue": 1,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -112,
        416
      ],
      "id": "8d11c6ab-cd2d-4eba-8c32-1b2947b1c905",
      "name": "If1",
      "alwaysOutputData": false,
      "executeOnce": false
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e6ef0a7e-5818-43ce-b97d-df1f2745a739",
              "name": "openaiFileIdClean",
              "value": "={{ ($json.openaiFileId || \"\").trim().replace(/[^A-Za-z0-9_-]/g,\"\") }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -704,
        416
      ],
      "id": "dca8e124-3435-4d9e-87c1-8791c51055e3",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "content": "## Filtra por cantidad de t√≠tulos\nSi hay mas de un t√≠tulo tira por arriba, si no por abajo",
        "height": 320,
        "width": 880
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -800,
        288
      ],
      "id": "e4ea8e65-e533-4237-a6d5-0eea542da208",
      "name": "Sticky Note21"
    },
    {
      "parameters": {
        "content": "## Procesa pedidos con solo un t√≠tulo",
        "height": 2624,
        "width": 7184,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1152,
        512
      ],
      "id": "1f209267-ca75-4359-9454-8e8182a2cf2b",
      "name": "Sticky Note22"
    },
    {
      "parameters": {
        "content": "## id por Elemento",
        "height": 1520
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2880,
        -1600
      ],
      "typeVersion": 1,
      "id": "00fa7ba4-d236-465a-b9a9-66e77bb61593",
      "name": "Sticky Note23"
    },
    {
      "parameters": {
        "content": "## Procesa pedidos con varios t√≠tulos",
        "height": 2080,
        "width": 5312,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1136,
        -1808
      ],
      "id": "30a32411-eb68-4af9-911e-cde3f3419951",
      "name": "Sticky Note24"
    }
  ],
  "connections": {
    "OpenAI": {
      "main": [
        [
          {
            "node": "Parse cabecera",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build OpenAI Body (schema)": {
      "main": [
        [
          {
            "node": "OpenAI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Subir PDF a OpenAI": {
      "main": [
        [
          {
            "node": "openaiFileId",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "openaiFileId": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "OpenAI1": {
      "main": [
        [
          {
            "node": "Parse interiores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build OpenAI Body (schema)1": {
      "main": [
        [
          {
            "node": "OpenAI1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI2": {
      "main": [
        [
          {
            "node": "Parse cubierta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build OpenAI Body (schema)2": {
      "main": [
        [
          {
            "node": "OpenAI2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI3": {
      "main": [
        [
          {
            "node": "Parse output_text3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build OpenAI Body (schema)3": {
      "main": [
        [
          {
            "node": "OpenAI3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse output_text3": {
      "main": [
        [
          {
            "node": "Split Out Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PDF - Base64": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øpapel_id > 0?": {
      "main": [
        [
          {
            "node": "limpieza",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "API Bobinas Stock",
            "type": "main",
            "index": 0
          },
          {
            "node": "Unir pedido + stock",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API Bobinas Stock": {
      "main": [
        [
          {
            "node": "Agrupar stock",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agrupar stock": {
      "main": [
        [
          {
            "node": "Unir pedido + stock",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Seleccionar bobina (JS)": {
      "main": [
        [
          {
            "node": "limpieza",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcular UPS (interiores)": {
      "main": [
        [
          {
            "node": "idElemento1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "Calcular UPS (interiores)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Desarrollo1": {
      "main": [
        []
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "PDF - Base64",
            "type": "main",
            "index": 0
          },
          {
            "node": "Renombrar binario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "solo PDF": {
      "main": [
        [
          {
            "node": "Download file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download file": {
      "main": [
        [
          {
            "node": "Renombrar binario",
            "type": "main",
            "index": 0
          },
          {
            "node": "PDF - Base64",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Drive": {
      "main": [
        [
          {
            "node": "solo PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Renombrar binario": {
      "main": [
        [
          {
            "node": "Subir PDF a OpenAI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PromptConfig_ANAYA": {
      "main": [
        []
      ]
    },
    "Parse cabecera": {
      "main": [
        [
          {
            "node": "Split Out Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out Items": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge5",
            "type": "main",
            "index": 0
          },
          {
            "node": "idElemento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse interiores": {
      "main": [
        [
          {
            "node": "Split Out Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out Items1": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Parse cubierta": {
      "main": [
        [
          {
            "node": "Split Out Items2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out Items2": {
      "main": [
        [
          {
            "node": "Merge5",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Calcular tecnologia (cubierta)": {
      "main": [
        [
          {
            "node": "idElemento2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge5": {
      "main": [
        [
          {
            "node": "Calcular tecnologia (cubierta)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out Items3": {
      "main": [
        [
          {
            "node": "idElemento3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "idElemento": {
      "main": [
        [
          {
            "node": "Merge6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "idElemento1": {
      "main": [
        [
          {
            "node": "Merge6",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "idElemento2": {
      "main": [
        [
          {
            "node": "Merge7",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge6": {
      "main": [
        [
          {
            "node": "Merge7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge7": {
      "main": [
        [
          {
            "node": "Merge8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "idElemento3": {
      "main": [
        [
          {
            "node": "Merge8",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge8": {
      "main": [
        [
          {
            "node": "a√±ade PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "¬øpapel_id > 0?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unir pedido + stock": {
      "main": [
        [
          {
            "node": "Seleccionar bobina (JS)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "const id = String($json.idElemento || 'sin-id'); const now = new Date().toISOString().slice(0,19).re": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create a file": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Create a file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "limpieza": {
      "main": [
        [
          {
            "node": "const id = String($json.idElemento || 'sin-id'); const now = new Date().toISOString().slice(0,19).re",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "a√±ade PDF": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse output_text": {
      "main": [
        [
          {
            "node": "Merge9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse output_text1": {
      "main": [
        [
          {
            "node": "Merge9",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Parse output_text2": {
      "main": [
        [
          {
            "node": "Calcular tecnologia (cubierta)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build JSON completo": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Normalizar pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API Pedidos": {
      "main": [
        [
          {
            "node": "Validar duplicados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar pedido": {
      "main": [
        [
          {
            "node": "API Pedidos",
            "type": "main",
            "index": 0
          },
          {
            "node": "Unir pedido + stock1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar duplicados": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "OT_DUPLICADA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ISBN_EN_PRODUCCION",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "DATOS_INCOMPLETOS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "¬øpapel_id > 0?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Desarrollo": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OT_DUPLICADA": {
      "main": [
        [
          {
            "node": "email AUTOMATE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ISBN_EN_PRODUCCION": {
      "main": [
        [
          {
            "node": "email AUTOMATE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DATOS_INCOMPLETOS": {
      "main": [
        [
          {
            "node": "email AUTOMATE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "INFORME DE REGISTRO 2": {
      "main": [
        [
          {
            "node": "email AUTOMATE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "json para email": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge3": {
      "main": [
        [
          {
            "node": "INFORME DE REGISTRO 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "json para email1": {
      "main": [
        [
          {
            "node": "Merge4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "INFORME DE REGISTRO ": {
      "main": [
        [
          {
            "node": "email AUTOMATE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge4": {
      "main": [
        [
          {
            "node": "INFORME DE REGISTRO ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI4": {
      "main": [
        [
          {
            "node": "Parse output_text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build OpenAI Body (schema)4": {
      "main": [
        [
          {
            "node": "OpenAI4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI5": {
      "main": [
        [
          {
            "node": "Parse output_text1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build OpenAI Body (schema)5": {
      "main": [
        [
          {
            "node": "OpenAI5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI6": {
      "main": [
        [
          {
            "node": "Parse output_text2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build OpenAI Body (schema)6": {
      "main": [
        [
          {
            "node": "OpenAI6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI7": {
      "main": [
        [
          {
            "node": "Parse output_text4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build OpenAI Body (schema)7": {
      "main": [
        [
          {
            "node": "OpenAI7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse output_text4": {
      "main": [
        [
          {
            "node": "Build JSON completo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øpapel_id > 0?1": {
      "main": [
        [
          {
            "node": "json para email1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "API Bobinas Stock1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API Bobinas Stock1": {
      "main": [
        [
          {
            "node": "Agrupar stock1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agrupar stock1": {
      "main": [
        [
          {
            "node": "Unir pedido + stock1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Unir pedido + stock1": {
      "main": [
        [
          {
            "node": "Seleccionar bobina (JS)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Seleccionar bobina (JS)1": {
      "main": [
        [
          {
            "node": "json para email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge9": {
      "main": [
        [
          {
            "node": "Calcular UPS (interiores)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Desarrollo2": {
      "main": [
        [
          {
            "node": "Merge4",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "PromptConfig_ANAYA1": {
      "main": [
        [
          {
            "node": "Build OpenAI Body (schema)4",
            "type": "main",
            "index": 0
          },
          {
            "node": "Build OpenAI Body (schema)5",
            "type": "main",
            "index": 0
          },
          {
            "node": "Build OpenAI Body (schema)6",
            "type": "main",
            "index": 0
          },
          {
            "node": "Build OpenAI Body (schema)7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cuantos titulos": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "cuantos titulos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "PromptConfig_ANAYA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "PromptConfig_ANAYA1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "timeSavedMode": "fixed",
    "timezone": "Europe/Madrid",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "errorWorkflow": "51HtRNdqJ20cKFay"
  },
  "staticData": {
    "node:Google Drive Trigger": {
      "lastTimeChecked": "2025-12-23T12:59:06Z"
    },
    "node:Google Drive": {
      "lastTimeChecked": "2026-01-01T17:31:47Z"
    }
  },
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "c057e1e2-a5f5-4d58-8442-d1479d682cb3",
  "activeVersionId": null,
  "versionCounter": 467,
  "triggerCount": 2,
  "shared": [
    {
      "updatedAt": "2025-12-31T10:07:03.414Z",
      "createdAt": "2025-12-31T10:07:03.414Z",
      "role": "workflow:owner",
      "workflowId": "K9UDY6hPoyI4yT6L",
      "projectId": "5DRxsE1egf1baMP6",
      "project": {
        "updatedAt": "2025-12-16T07:05:26.416Z",
        "createdAt": "2025-12-16T07:00:37.382Z",
        "id": "5DRxsE1egf1baMP6",
        "name": "P GA <procesos@gomezaparicio.es>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "updatedAt": "2025-12-16T07:00:37.382Z",
            "createdAt": "2025-12-16T07:00:37.382Z",
            "userId": "9a4e2f29-7a97-4add-ba5c-b1a99dee84e7",
            "projectId": "5DRxsE1egf1baMP6",
            "user": {
              "updatedAt": "2026-01-04T07:22:52.745Z",
              "createdAt": "2025-12-16T07:00:36.626Z",
              "id": "9a4e2f29-7a97-4add-ba5c-b1a99dee84e7",
              "email": "procesos@gomezaparicio.es",
              "firstName": "P",
              "lastName": "GA",
              "personalizationAnswers": null,
              "settings": {
                "userActivated": true,
                "easyAIWorkflowOnboarded": true,
                "firstSuccessfulWorkflowId": "gR8RJ0nGarvRBlGa",
                "userActivatedAt": 1766491998544
              },
              "disabled": false,
              "mfaEnabled": true,
              "lastActiveAt": "2026-01-04",
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [],
  "activeVersion": null
}