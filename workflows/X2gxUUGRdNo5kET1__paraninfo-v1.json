{
  "updatedAt": "2025-12-29T17:13:32.906Z",
  "createdAt": "2025-12-23T10:49:24.487Z",
  "id": "X2gxUUGRdNo5kET1",
  "name": "Paraninfo v1",
  "description": null,
  "active": false,
  "isArchived": true,
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "authentication": "serviceAccount",
        "triggerOn": "specificFolder",
        "folderToWatch": {
          "__rl": true,
          "value": "1MfFe7fxdX2djPbNMWrb0yEwv2vBMvYA8",
          "mode": "list",
          "cachedResultName": "Paraninfo",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1MfFe7fxdX2djPbNMWrb0yEwv2vBMvYA8"
        },
        "event": "fileCreated",
        "options": {
          "fileType": "all"
        }
      },
      "type": "n8n-nodes-base.googleDriveTrigger",
      "typeVersion": 1,
      "position": [
        -1232,
        336
      ],
      "id": "bc268378-9736-4345-a997-91ababcc793f",
      "name": "Google Drive Trigger",
      "credentials": {
        "googleApi": {
          "id": "ePv2Ty1cw3gq6g7N",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        },
        "options": {
          "binaryPropertyName": "data"
        }
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -944,
        336
      ],
      "id": "ae0e43d2-89c8-443c-84db-02fdad69478f",
      "name": "Download file",
      "alwaysOutputData": false,
      "credentials": {
        "googleApi": {
          "id": "ePv2Ty1cw3gq6g7N",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Conexión con Google DRIVE\nRecoge el EXCEL de la carpeta ",
        "height": 352,
        "width": 608,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1328,
        208
      ],
      "id": "9204396f-d093-4f18-9619-64fb0ec25900",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "operation": "xlsx",
        "binaryPropertyName": "excel",
        "options": {
          "headerRow": true
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        -432,
        -80
      ],
      "id": "66a3b991-e4d1-44ed-9bf2-c00a78098839",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "jsCode": "function toISODate(v) {\n  if (!v) return \"\";\n  if (v instanceof Date) return v.toISOString().slice(0, 10);\n  const s = String(v);\n  return s.length >= 10 ? s.slice(0, 10) : s;\n}\n\nfunction joinObs(k, l) {\n  const a = String(k ?? \"\").trim();\n  const b = String(l ?? \"\").trim();\n  if (a && b) return `${a} - ${b}`;\n  return a || b || \"\";\n}\n\n// 1) Cogemos el PDF en base64 UNA sola vez (del nodo que generó binary.pdf)\nconst pdfBase64 =\n  $items(\"binary\")?.[0]?.binary?.pdf?.data\n  ?? $input.first()?.binary?.pdf?.data\n  ?? \"\";\n\nif (!pdfBase64) {\n  throw new Error(\"No se encontró el PDF en binary.pdf.data. Revisa que el nodo 'binary' genere binary.pdf y que llegue hasta este nodo.\");\n}\n\nconst out = [];\n\nfor (const item of $input.all()) {\n  const r = item.json;\n\n  const colorRaw = String(r.color ?? \"\").trim().toUpperCase();\n  const ancho = Number(r.ancho ?? 0);\n\n  const esColor = colorRaw === \"COLOR\";\n  const anchoGrande = ancho > 17;\n\n  let papel_id, tipoImpresion, materialCubierta;\n\n  if (esColor) {\n    papel_id = anchoGrande ? 672 : 674;\n    tipoImpresion = 1;\n    materialCubierta = 3;\n  } else {\n    papel_id = anchoGrande ? 170 : 28;\n    tipoImpresion = 2;\n    materialCubierta = 1;\n  }\n\n  const anchoBobinaCm = (papel_id === 672 || papel_id === 170) ? 48 : 54;\n  const ups = anchoGrande ? 2 : 3;\n\n  const tirada = Number(r.ejemplares ?? 0);\n  const paginas = Number(r.paginas ?? 0);\n\n  out.push({\n    json: {\n      archivoBase64: pdfBase64,   // ✅ aquí va el PDF en base64\n      cliente: \"17\",\n      contacto: \"23\",\n      numeroOtCliente: String(r.otCliente ?? \"\"),\n      fechaEntrega: toISODate(r.fechaEntrega),\n      sinRetraso: true,\n      tirada,\n      precioUnitarioSinIVA: 0,\n      precioToltalSinIVA: 0,\n      observacionesPedido: joinObs(r.personalizacion, r.obs),\n      titulo: String(r.titulo ?? \"\"),\n      sello: \"\",\n      isbn: String(r.isbn ?? \"\"),\n      codProyecto: String(r.numProyecto ?? \"\"),\n      anchoPaginaCm: Number(r.ancho ?? 0),\n      altoPaginaCm: Number(r.alto ?? 0),\n      unionPliegos: 2,\n      encuadernacion: 3,\n      interiores: [\n        {\n          papel_id,\n          propietarioPapel: 1,\n          tipoImpresion,\n          paginas,\n          papelPedido: {\n            refPedido: \"\",\n            gramaje: 0,\n            anchoBobinaCm,\n            ups,\n            metros: 0.0,\n            kg: 0.0,\n          },\n        },\n      ],\n      cubierta: {\n        materialCubierta,\n        propietarioPapel: 1,\n        plastificado: 1,\n        impresion: \"4/0\",\n        tecnologia: 1,\n        observaciones: \"\",\n      },\n      direcciones: [\n        { destinatario: \"34\", ejemplares: tirada, observaciones: \"\" },\n      ],\n    }\n  });\n}\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -112,
        -80
      ],
      "id": "a78c7675-d410-4b37-b156-535188f9fdb0",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "operation": "toJson",
        "mode": "each",
        "options": {
          "fileName": "=={{$json.numeroOtCliente}}_{{$json.codProyecto}}.json"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        96,
        -80
      ],
      "id": "3c400a56-78bf-48db-be84-4263eb3c1d7f",
      "name": "Convert to File"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        560,
        -80
      ],
      "id": "5683cf66-c41f-4a8d-bc98-0799a5f5dcda",
      "name": "Loop Over Items"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        784,
        32
      ],
      "id": "eb632120-703f-4149-b0c4-87015ea30581",
      "name": "Wait",
      "webhookId": "6382499c-9b9b-43ca-8015-3d58f2408186"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "1c7kSdOXBM74BZ1XtBtzjiIwdh_wB4z1k",
          "mode": "list",
          "cachedResultName": "ParaninfoJSON",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1c7kSdOXBM74BZ1XtBtzjiIwdh_wB4z1k"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        1008,
        128
      ],
      "id": "ee8e9095-9897-4a8d-8eef-3da9f6424860",
      "name": "Upload file",
      "credentials": {
        "googleApi": {
          "id": "ePv2Ty1cw3gq6g7N",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "recibir-datos-paraninfo",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1040,
        -80
      ],
      "id": "5f1263a2-a399-4f93-888a-45ad27d09734",
      "name": "Webhook",
      "webhookId": "a0e43989-8bdf-4f1c-a0d7-842981a126f6"
    },
    {
      "parameters": {
        "jsCode": "// El Webhook en tu caso mete el payload dentro de $json.body\nconst payload = $json.body ?? $json;\n\nconst atts = payload.attachments ?? [];\nconst out = {\n  json: { email: payload.email ?? {} },\n  binary: {},\n};\n\nfor (const a of atts) {\n  const fileName = String(a.name ?? '');\n  const lower = fileName.toLowerCase();\n\n  let key = null;\n  if (lower.endsWith('.pdf')) key = 'pdf';\n  if (lower.endsWith('.xlsx') || lower.endsWith('.xls')) key = 'excel';\n  if (!key) continue;\n\n  const base64 = String(a.contentBytes ?? '');\n  out.binary[key] = {\n    data: base64,              // base64 correcto (UEsDB / JVBER…)\n    fileName,\n    mimeType: a.contentType || (key === 'pdf'\n      ? 'application/pdf'\n      : 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),\n  };\n}\n\nout.json.hasPdf = !!out.binary.pdf;\nout.json.hasExcel = !!out.binary.excel;\nout.json.attachmentsCount = atts.length;\n\nreturn [out];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -688,
        -80
      ],
      "id": "efb3da2d-f897-4cc1-a758-88ed96e7860e",
      "name": "binary"
    },
    {
      "parameters": {
        "content": "## Conectado al flujo de Automate\nEnvia el PDF y el Excel del pedido",
        "height": 288,
        "width": 432
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1200,
        -176
      ],
      "id": "6a8b0b73-99d2-4c40-98ea-826cbb865c22",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## Extrae los datos del Excel",
        "height": 304
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -496,
        -176
      ],
      "id": "70377ef8-0bfe-42e8-a272-64b30a57fc5e",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## Completa el json plantilla\nCon los datos del excel",
        "height": 304,
        "width": 464
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -176,
        -176
      ],
      "id": "f1bbe2fa-1c2f-41fc-b7c8-97634c28811d",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://liberdigital-des.gomezaparicio.es/desarrollo/sw/automatizacion/pedidos/digital/nuevo/",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1472,
        -176
      ],
      "id": "560cbb0b-18f9-4b85-85fe-304a46df2a88",
      "name": "Desarrollo1",
      "credentials": {
        "httpBasicAuth": {
          "id": "EGTFeBpcDKH8NdqZ",
          "name": "Apis Libernet"
        }
      }
    },
    {
      "parameters": {
        "content": "## LIBERNET",
        "height": 560,
        "width": 368,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1344,
        -288
      ],
      "id": "1910aff1-16b2-419d-bae6-c0d7f2d8320f",
      "name": "Sticky Note11"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://liberdigital.gomezaparicio.es/sw/automatizacion/pedidos/digital/nuevo/",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1472,
        64
      ],
      "id": "3eaee71c-860a-49e1-b7b7-5a3e1706d94c",
      "name": "Producción1",
      "credentials": {
        "httpBasicAuth": {
          "id": "EGTFeBpcDKH8NdqZ",
          "name": "Apis Libernet"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c50ac2fc-7702-478c-bb8a-fe568b6229b8",
              "name": "asunto",
              "value": "=Informe del registro del pedido {{ $('¿papel_id > 0?').item.json.numeroOtCliente }}, Ot {{ $json.numeroPedido }}",
              "type": "string"
            },
            {
              "id": "a7625554-7c62-408b-965c-183c852a901d",
              "name": "texto",
              "value": "=El resultado es {{ $json.resultado }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1936,
        -64
      ],
      "id": "bfdbe289-0abd-4adc-b3d9-f23f20922ff3",
      "name": "INFORME DE REGISTRO 1"
    },
    {
      "parameters": {
        "content": "## Texto Informe\nCuando el papel es suyo",
        "height": 304,
        "width": 256
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1856,
        -176
      ],
      "id": "1d166827-e702-4650-8922-81c9583faec1",
      "name": "Sticky Note13"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://default90419c2b07624d6fb6a1aca6fc3084.80.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/b8ed51b3f3514e6f8835627e068fe901/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=8nyoBAiRe-vHc4jKd_eLpw_R5BPIg-GxP32JL1lYr4s",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "asunto",
              "value": "={{$json.asunto}}"
            },
            {
              "name": "texto",
              "value": "={{$json.texto}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2240,
        -64
      ],
      "id": "d9bf19b6-987b-44aa-9133-642cd624d6e0",
      "name": "email AUTOMATE"
    }
  ],
  "connections": {
    "Google Drive Trigger": {
      "main": [
        [
          {
            "node": "Download file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download file": {
      "main": [
        []
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Upload file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload file": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "binary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "binary": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Desarrollo1": {
      "main": [
        [
          {
            "node": "INFORME DE REGISTRO 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "INFORME DE REGISTRO 1": {
      "main": [
        [
          {
            "node": "email AUTOMATE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": {
    "node:Google Drive Trigger": {
      "lastTimeChecked": "2025-12-27T19:36:44Z"
    }
  },
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "b38d381a-cea3-4454-90e7-84f1f108ddd0",
  "activeVersionId": null,
  "versionCounter": 26,
  "triggerCount": 2,
  "shared": [
    {
      "updatedAt": "2025-12-23T10:49:24.487Z",
      "createdAt": "2025-12-23T10:49:24.487Z",
      "role": "workflow:owner",
      "workflowId": "X2gxUUGRdNo5kET1",
      "projectId": "5DRxsE1egf1baMP6",
      "project": {
        "updatedAt": "2025-12-16T07:05:26.416Z",
        "createdAt": "2025-12-16T07:00:37.382Z",
        "id": "5DRxsE1egf1baMP6",
        "name": "P GA <procesos@gomezaparicio.es>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "updatedAt": "2025-12-16T07:00:37.382Z",
            "createdAt": "2025-12-16T07:00:37.382Z",
            "userId": "9a4e2f29-7a97-4add-ba5c-b1a99dee84e7",
            "projectId": "5DRxsE1egf1baMP6",
            "user": {
              "updatedAt": "2026-01-03T06:48:17.640Z",
              "createdAt": "2025-12-16T07:00:36.626Z",
              "id": "9a4e2f29-7a97-4add-ba5c-b1a99dee84e7",
              "email": "procesos@gomezaparicio.es",
              "firstName": "P",
              "lastName": "GA",
              "personalizationAnswers": null,
              "settings": {
                "userActivated": true,
                "easyAIWorkflowOnboarded": true,
                "firstSuccessfulWorkflowId": "gR8RJ0nGarvRBlGa",
                "userActivatedAt": 1766491998544
              },
              "disabled": false,
              "mfaEnabled": true,
              "lastActiveAt": "2026-01-03",
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [],
  "activeVersion": null
}